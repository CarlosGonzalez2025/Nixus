{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 7, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/lib/errors.ts"],"sourcesContent":["\nexport type SecurityRuleContext = {\n  path: string;\n  operation: 'get' | 'list' | 'create' | 'update' | 'delete' | 'write';\n  requestResourceData?: any;\n};\n\nexport class FirestorePermissionError extends Error {\n  context: SecurityRuleContext;\n\n  constructor(context: SecurityRuleContext) {\n    const message = `FirestoreError: Missing or insufficient permissions. The following request was denied by Firestore Security Rules:\\n${JSON.stringify(\n      {\n        context,\n      },\n      null,\n      2\n    )}`;\n    super(message);\n    this.name = 'FirestorePermissionError';\n    this.context = context;\n\n    // This is to make the error message more readable in the console\n    Object.setPrototypeOf(this, FirestorePermissionError.prototype);\n  }\n}\n"],"names":[],"mappings":";;;AAOO,MAAM,iCAAiC;IAC5C,QAA6B;IAE7B,YAAY,OAA4B,CAAE;QACxC,MAAM,UAAU,CAAC,oHAAoH,EAAE,KAAK,SAAS,CACnJ;YACE;QACF,GACA,MACA,IACC;QACH,KAAK,CAAC;QACN,IAAI,CAAC,IAAI,GAAG;QACZ,IAAI,CAAC,OAAO,GAAG;QAEf,iEAAiE;QACjE,OAAO,cAAc,CAAC,IAAI,EAAE,yBAAyB,SAAS;IAChE;AACF","debugId":null}},
    {"offset": {"line": 29, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/components/ui/badge.tsx"],"sourcesContent":["import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  \"inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground hover:bg-primary/80\",\n        secondary:\n          \"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80\",\n        outline: \"text-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  )\n}\n\nexport { Badge, badgeVariants }\n"],"names":[],"mappings":";;;;;AACA;AAEA;;;;AAEA,MAAM,gBAAgB,CAAA,GAAA,gKAAA,CAAA,MAAG,AAAD,EACtB,0KACA;IACE,UAAU;QACR,SAAS;YACP,SACE;YACF,WACE;YACF,aACE;YACF,SAAS;QACX;IACF;IACA,iBAAiB;QACf,SAAS;IACX;AACF;AAOF,SAAS,MAAM,EAAE,SAAS,EAAE,OAAO,EAAE,GAAG,OAAmB;IACzD,qBACE,8OAAC;QAAI,WAAW,CAAA,GAAA,mHAAA,CAAA,KAAE,AAAD,EAAE,cAAc;YAAE;QAAQ,IAAI;QAAa,GAAG,KAAK;;;;;;AAExE","debugId":null}},
    {"offset": {"line": 71, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/components/ui/card.tsx"],"sourcesContent":["import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"rounded-lg border bg-card text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n))\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\n\nexport { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }\n"],"names":[],"mappings":";;;;;;;;;AAAA;AAEA;;;;AAEA,MAAM,qBAAO,CAAA,GAAA,qMAAA,CAAA,aAAgB,AAAD,EAG1B,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,8OAAC;QACC,KAAK;QACL,WAAW,CAAA,GAAA,mHAAA,CAAA,KAAE,AAAD,EACV,4DACA;QAED,GAAG,KAAK;;;;;;AAGb,KAAK,WAAW,GAAG;AAEnB,MAAM,2BAAa,CAAA,GAAA,qMAAA,CAAA,aAAgB,AAAD,EAGhC,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,8OAAC;QACC,KAAK;QACL,WAAW,CAAA,GAAA,mHAAA,CAAA,KAAE,AAAD,EAAE,iCAAiC;QAC9C,GAAG,KAAK;;;;;;AAGb,WAAW,WAAW,GAAG;AAEzB,MAAM,0BAAY,CAAA,GAAA,qMAAA,CAAA,aAAgB,AAAD,EAG/B,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,8OAAC;QACC,KAAK;QACL,WAAW,CAAA,GAAA,mHAAA,CAAA,KAAE,AAAD,EACV,sDACA;QAED,GAAG,KAAK;;;;;;AAGb,UAAU,WAAW,GAAG;AAExB,MAAM,gCAAkB,CAAA,GAAA,qMAAA,CAAA,aAAgB,AAAD,EAGrC,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,8OAAC;QACC,KAAK;QACL,WAAW,CAAA,GAAA,mHAAA,CAAA,KAAE,AAAD,EAAE,iCAAiC;QAC9C,GAAG,KAAK;;;;;;AAGb,gBAAgB,WAAW,GAAG;AAE9B,MAAM,4BAAc,CAAA,GAAA,qMAAA,CAAA,aAAgB,AAAD,EAGjC,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,8OAAC;QAAI,KAAK;QAAK,WAAW,CAAA,GAAA,mHAAA,CAAA,KAAE,AAAD,EAAE,YAAY;QAAa,GAAG,KAAK;;;;;;AAEhE,YAAY,WAAW,GAAG;AAE1B,MAAM,2BAAa,CAAA,GAAA,qMAAA,CAAA,aAAgB,AAAD,EAGhC,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,8OAAC;QACC,KAAK;QACL,WAAW,CAAA,GAAA,mHAAA,CAAA,KAAE,AAAD,EAAE,8BAA8B;QAC3C,GAAG,KAAK;;;;;;AAGb,WAAW,WAAW,GAAG","debugId":null}},
    {"offset": {"line": 152, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/components/ui/table.tsx"],"sourcesContent":["import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n"],"names":[],"mappings":";;;;;;;;;;;AAAA;AAEA;;;;AAEA,MAAM,sBAAQ,CAAA,GAAA,qMAAA,CAAA,aAAgB,AAAD,EAG3B,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,8OAAC;QAAI,WAAU;kBACb,cAAA,8OAAC;YACC,KAAK;YACL,WAAW,CAAA,GAAA,mHAAA,CAAA,KAAE,AAAD,EAAE,iCAAiC;YAC9C,GAAG,KAAK;;;;;;;;;;;AAIf,MAAM,WAAW,GAAG;AAEpB,MAAM,4BAAc,CAAA,GAAA,qMAAA,CAAA,aAAgB,AAAD,EAGjC,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,8OAAC;QAAM,KAAK;QAAK,WAAW,CAAA,GAAA,mHAAA,CAAA,KAAE,AAAD,EAAE,mBAAmB;QAAa,GAAG,KAAK;;;;;;AAEzE,YAAY,WAAW,GAAG;AAE1B,MAAM,0BAAY,CAAA,GAAA,qMAAA,CAAA,aAAgB,AAAD,EAG/B,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,8OAAC;QACC,KAAK;QACL,WAAW,CAAA,GAAA,mHAAA,CAAA,KAAE,AAAD,EAAE,8BAA8B;QAC3C,GAAG,KAAK;;;;;;AAGb,UAAU,WAAW,GAAG;AAExB,MAAM,4BAAc,CAAA,GAAA,qMAAA,CAAA,aAAgB,AAAD,EAGjC,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,8OAAC;QACC,KAAK;QACL,WAAW,CAAA,GAAA,mHAAA,CAAA,KAAE,AAAD,EACV,2DACA;QAED,GAAG,KAAK;;;;;;AAGb,YAAY,WAAW,GAAG;AAE1B,MAAM,yBAAW,CAAA,GAAA,qMAAA,CAAA,aAAgB,AAAD,EAG9B,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,8OAAC;QACC,KAAK;QACL,WAAW,CAAA,GAAA,mHAAA,CAAA,KAAE,AAAD,EACV,+EACA;QAED,GAAG,KAAK;;;;;;AAGb,SAAS,WAAW,GAAG;AAEvB,MAAM,0BAAY,CAAA,GAAA,qMAAA,CAAA,aAAgB,AAAD,EAG/B,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,8OAAC;QACC,KAAK;QACL,WAAW,CAAA,GAAA,mHAAA,CAAA,KAAE,AAAD,EACV,oGACA;QAED,GAAG,KAAK;;;;;;AAGb,UAAU,WAAW,GAAG;AAExB,MAAM,0BAAY,CAAA,GAAA,qMAAA,CAAA,aAAgB,AAAD,EAG/B,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,8OAAC;QACC,KAAK;QACL,WAAW,CAAA,GAAA,mHAAA,CAAA,KAAE,AAAD,EAAE,kDAAkD;QAC/D,GAAG,KAAK;;;;;;AAGb,UAAU,WAAW,GAAG;AAExB,MAAM,6BAAe,CAAA,GAAA,qMAAA,CAAA,aAAgB,AAAD,EAGlC,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,8OAAC;QACC,KAAK;QACL,WAAW,CAAA,GAAA,mHAAA,CAAA,KAAE,AAAD,EAAE,sCAAsC;QACnD,GAAG,KAAK;;;;;;AAGb,aAAa,WAAW,GAAG","debugId":null}},
    {"offset": {"line": 270, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/components/ui/dialog.tsx"],"sourcesContent":["\n\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;AAGA;AACA;AACA;AAEA;AANA;;;;;;AAQA,MAAM,SAAS,kKAAA,CAAA,OAAoB;AAEnC,MAAM,gBAAgB,kKAAA,CAAA,UAAuB;AAE7C,MAAM,eAAe,kKAAA,CAAA,SAAsB;AAE3C,MAAM,cAAc,kKAAA,CAAA,QAAqB;AAEzC,MAAM,8BAAgB,CAAA,GAAA,qMAAA,CAAA,aAAgB,AAAD,EAGnC,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,8OAAC,kKAAA,CAAA,UAAuB;QACtB,KAAK;QACL,WAAW,CAAA,GAAA,mHAAA,CAAA,KAAE,AAAD,EACV,0JACA;QAED,GAAG,KAAK;;;;;;AAGb,cAAc,WAAW,GAAG,kKAAA,CAAA,UAAuB,CAAC,WAAW;AAE/D,MAAM,8BAAgB,CAAA,GAAA,qMAAA,CAAA,aAAgB,AAAD,EAGnC,CAAC,EAAE,SAAS,EAAE,QAAQ,EAAE,GAAG,OAAO,EAAE,oBACpC,8OAAC;;0BACC,8OAAC;;;;;0BACD,8OAAC,kKAAA,CAAA,UAAuB;gBACtB,KAAK;gBACL,WAAW,CAAA,GAAA,mHAAA,CAAA,KAAE,AAAD,EACV,+fACA;gBAED,GAAG,KAAK;;oBAER;kCACD,8OAAC,kKAAA,CAAA,QAAqB;wBAAC,WAAU;;0CAC/B,8OAAC,4LAAA,CAAA,IAAC;gCAAC,WAAU;;;;;;0CACb,8OAAC;gCAAK,WAAU;0CAAU;;;;;;;;;;;;;;;;;;;;;;;;AAKlC,cAAc,WAAW,GAAG,kKAAA,CAAA,UAAuB,CAAC,WAAW;AAE/D,MAAM,eAAe,CAAC,EACpB,SAAS,EACT,GAAG,OACkC,iBACrC,8OAAC;QACC,WAAW,CAAA,GAAA,mHAAA,CAAA,KAAE,AAAD,EACV,sDACA;QAED,GAAG,KAAK;;;;;;AAGb,aAAa,WAAW,GAAG;AAE3B,MAAM,eAAe,CAAC,EACpB,SAAS,EACT,GAAG,OACkC,iBACrC,8OAAC;QACC,WAAW,CAAA,GAAA,mHAAA,CAAA,KAAE,AAAD,EACV,iEACA;QAED,GAAG,KAAK;;;;;;AAGb,aAAa,WAAW,GAAG;AAE3B,MAAM,4BAAc,CAAA,GAAA,qMAAA,CAAA,aAAgB,AAAD,EAGjC,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,8OAAC,kKAAA,CAAA,QAAqB;QACpB,KAAK;QACL,WAAW,CAAA,GAAA,mHAAA,CAAA,KAAE,AAAD,EACV,qDACA;QAED,GAAG,KAAK;;;;;;AAGb,YAAY,WAAW,GAAG,kKAAA,CAAA,QAAqB,CAAC,WAAW;AAE3D,MAAM,kCAAoB,CAAA,GAAA,qMAAA,CAAA,aAAgB,AAAD,EAGvC,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,8OAAC,kKAAA,CAAA,cAA2B;QAC1B,KAAK;QACL,WAAW,CAAA,GAAA,mHAAA,CAAA,KAAE,AAAD,EAAE,iCAAiC;QAC9C,GAAG,KAAK;;;;;;AAGb,kBAAkB,WAAW,GAAG,kKAAA,CAAA,cAA2B,CAAC,WAAW","debugId":null}},
    {"offset": {"line": 402, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/components/ui/checkbox.tsx"],"sourcesContent":["\"use client\"\n\nimport * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n"],"names":[],"mappings":";;;;AAEA;AACA;AACA;AAEA;AANA;;;;;;AAQA,MAAM,yBAAW,CAAA,GAAA,qMAAA,CAAA,aAAgB,AAAD,EAG9B,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,8OAAC,oKAAA,CAAA,OAAsB;QACrB,KAAK;QACL,WAAW,CAAA,GAAA,mHAAA,CAAA,KAAE,AAAD,EACV,kTACA;QAED,GAAG,KAAK;kBAET,cAAA,8OAAC,oKAAA,CAAA,YAA2B;YAC1B,WAAW,CAAA,GAAA,mHAAA,CAAA,KAAE,AAAD,EAAE;sBAEd,cAAA,8OAAC,oMAAA,CAAA,QAAK;gBAAC,WAAU;;;;;;;;;;;;;;;;AAIvB,SAAS,WAAW,GAAG,oKAAA,CAAA,OAAsB,CAAC,WAAW","debugId":null}},
    {"offset": {"line": 447, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/components/ui/label.tsx"],"sourcesContent":["\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n"],"names":[],"mappings":";;;;AAEA;AACA;AACA;AAEA;AANA;;;;;;AAQA,MAAM,gBAAgB,CAAA,GAAA,gKAAA,CAAA,MAAG,AAAD,EACtB;AAGF,MAAM,sBAAQ,CAAA,GAAA,qMAAA,CAAA,aAAgB,AAAD,EAI3B,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,8OAAC,iKAAA,CAAA,OAAmB;QAClB,KAAK;QACL,WAAW,CAAA,GAAA,mHAAA,CAAA,KAAE,AAAD,EAAE,iBAAiB;QAC9B,GAAG,KAAK;;;;;;AAGb,MAAM,WAAW,GAAG,iKAAA,CAAA,OAAmB,CAAC,WAAW","debugId":null}},
    {"offset": {"line": 479, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/components/ui/signature-pad.tsx"],"sourcesContent":["\n\"use client\";\n\nimport React, { useRef, useState, useEffect } from 'react';\nimport { Button } from './button';\nimport { Eraser, Loader2, Save } from 'lucide-react';\nimport { DialogFooter } from './dialog';\nimport { Checkbox } from './checkbox';\nimport { Label } from './label';\n\ninterface SignaturePadProps {\n  onSave: (signature: string) => void;\n  isSaving?: boolean;\n}\n\nexport const SignaturePad: React.FC<SignaturePadProps> = ({ onSave, isSaving = false }) => {\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const containerRef = useRef<HTMLDivElement>(null);\n  const [isDrawing, setIsDrawing] = useState(false);\n  const [hasConsented, setHasConsented] = useState(false);\n\n  const getCanvasContext = () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return null;\n    return canvas.getContext('2d');\n  };\n\n  const resizeCanvas = () => {\n    const canvas = canvasRef.current;\n    const container = containerRef.current;\n    if (canvas && container) {\n      canvas.width = container.offsetWidth;\n      canvas.height = 200; // Keep a fixed height or make it responsive too\n      const ctx = getCanvasContext();\n      if(ctx) {\n        ctx.strokeStyle = '#000';\n        ctx.lineWidth = 2;\n      }\n    }\n  };\n\n  useEffect(() => {\n    resizeCanvas();\n    window.addEventListener('resize', resizeCanvas);\n    return () => window.removeEventListener('resize', resizeCanvas);\n  }, []);\n\n  const startDrawing = (event: React.MouseEvent<HTMLCanvasElement> | React.TouchEvent<HTMLCanvasElement>) => {\n    event.preventDefault();\n    const ctx = getCanvasContext();\n    if (!ctx) return;\n    \n    const pos = getMousePos(event);\n    ctx.beginPath();\n    ctx.moveTo(pos.x, pos.y);\n    setIsDrawing(true);\n  };\n\n  const draw = (event: React.MouseEvent<HTMLCanvasElement> | React.TouchEvent<HTMLCanvasElement>) => {\n    event.preventDefault();\n    if (!isDrawing) return;\n    const ctx = getCanvasContext();\n    if (!ctx) return;\n\n    const pos = getMousePos(event);\n    ctx.lineTo(pos.x, pos.y);\n    ctx.stroke();\n  };\n\n  const stopDrawing = () => {\n    const ctx = getCanvasContext();\n    if (!ctx) return;\n    ctx.closePath();\n    setIsDrawing(false);\n  };\n  \n  const getMousePos = (event: React.MouseEvent<HTMLCanvasElement> | React.TouchEvent<HTMLCanvasElement>) => {\n    const canvas = canvasRef.current;\n    if (!canvas) return { x: 0, y: 0 };\n    const rect = canvas.getBoundingClientRect();\n\n    let clientX, clientY;\n\n    if ('touches' in event.nativeEvent) {\n      if (event.nativeEvent.touches.length === 0) return { x: 0, y: 0};\n      clientX = event.nativeEvent.touches[0].clientX;\n      clientY = event.nativeEvent.touches[0].clientY;\n    } else {\n      clientX = (event.nativeEvent as MouseEvent).clientX;\n      clientY = (event.nativeEvent as MouseEvent).clientY;\n    }\n    \n    return {\n      x: clientX - rect.left,\n      y: clientY - rect.top,\n    };\n  }\n\n  const clearPad = () => {\n    const canvas = canvasRef.current;\n    const ctx = getCanvasContext();\n    if (canvas && ctx) {\n      ctx.clearRect(0, 0, canvas.width, canvas.height);\n    }\n  };\n\n  const handleSave = () => {\n    const canvas = canvasRef.current;\n    if (canvas) {\n      const blank = document.createElement('canvas');\n      blank.width = canvas.width;\n      blank.height = canvas.height;\n      if(canvas.toDataURL() === blank.toDataURL()) {\n        alert(\"Por favor, provea una firma.\");\n        return;\n      }\n      \n      const dataUrl = canvas.toDataURL('image/png');\n      onSave(dataUrl);\n    }\n  };\n\n  return (\n    <div className=\"flex flex-col items-center gap-4 w-full\" ref={containerRef}>\n      <canvas\n        ref={canvasRef}\n        className=\"border border-gray-300 rounded-md bg-white cursor-crosshair touch-none w-full\"\n        onMouseDown={startDrawing}\n        onMouseMove={draw}\n        onMouseUp={stopDrawing}\n        onMouseLeave={stopDrawing}\n        onTouchStart={startDrawing}\n        onTouchMove={draw}\n        onTouchEnd={stopDrawing}\n      />\n       <div className=\"flex items-start space-x-3 w-full\">\n        <Checkbox \n          id=\"consent\" \n          checked={hasConsented}\n          onCheckedChange={(checked) => setHasConsented(Boolean(checked))}\n          className=\"mt-1\"\n        />\n        <Label htmlFor=\"consent\" className=\"text-xs text-muted-foreground\">\n          Al firmar, doy mi consentimiento y estoy de acuerdo con la informaci√≥n relacionada dentro del permiso de trabajo y sus anexos. Adicionalmente, autorizo el tratamiento de mis datos personales conforme a lo establecido en la Ley 1581 de 2012 y su Decreto Reglamentario 1377 de 2013, para las finalidades descritas en la pol√≠tica de tratamiento de datos de la organizaci√≥n.\n        </Label>\n      </div>\n      <DialogFooter className=\"w-full\">\n         <Button variant=\"outline\" onClick={clearPad} disabled={isSaving}>\n          <Eraser className=\"mr-2 h-4 w-4\" />\n          Limpiar\n        </Button>\n        <Button onClick={handleSave} disabled={!hasConsented || isSaving}>\n          {isSaving ? <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" /> : <Save className=\"mr-2 h-4 w-4\" />}\n          {isSaving ? 'Guardando...' : 'Guardar Firma'}\n        </Button>\n      </DialogFooter>\n    </div>\n  );\n};\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 708, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/components/ui/collapsible.tsx"],"sourcesContent":["\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n"],"names":[],"mappings":";;;;;AAEA;AAFA;;AAIA,MAAM,cAAc,uKAAA,CAAA,OAAyB;AAE7C,MAAM,qBAAqB,uKAAA,CAAA,qBAAuC;AAElE,MAAM,qBAAqB,uKAAA,CAAA,qBAAuC","debugId":null}},
    {"offset": {"line": 726, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/app/%28app%29/permits/actions.ts"],"sourcesContent":["\n'use server';\n\nimport { adminDb, isAdminReady } from '@/lib/firebase-admin';\nimport { revalidatePath } from 'next/cache';\nimport type { Permit, ExternalWorker, PermitStatus, PermitClosure, Approval, UserRole, AnexoAltura, AnexoConfinado, AnexoEnergias, AnexoExcavaciones, AnexoIzaje, AnexoATS, PermitGeneralInfo, JustificacionATS, ValidacionDiaria, User, Notification } from '@/types';\nimport { FieldValue, UpdateData, Timestamp } from 'firebase-admin/firestore';\nimport { sendWhatsAppNotification } from '@/lib/notifications';\nimport { getEmailForUser, sendPermitUpdateEmail } from '@/lib/email';\nimport { config } from 'dotenv';\nconfig();\n\n// --- Funciones Auxiliares para Notificaciones ---\n\nconst getInvolvedUsers = async (permit: Permit): Promise<string[]> => {\n  const userIds = new Set<string>();\n\n  // 1. Creador del permiso\n  if (permit.createdBy) {\n    userIds.add(permit.createdBy);\n  }\n\n  // 2. Usuarios que han firmado\n  Object.values(permit.approvals || {}).forEach(approval => {\n    if (approval && approval.userId) {\n      userIds.add(approval.userId);\n    }\n  });\n\n  // 3. Roles administrativos o de supervisi√≥n que deber√≠an ser notificados\n  const adminsQuery = await adminDb.collection('users').where('role', 'in', ['admin', 'autorizante', 'lider_sst']).get();\n  adminsQuery.forEach(doc => userIds.add(doc.id));\n\n  return Array.from(userIds);\n};\n\nconst createNotification = async (\n  userId: string,\n  permit: Permit,\n  message: string,\n  type: Notification['type'],\n  triggeredBy: { uid: string, displayName: string | null }\n) => {\n  const notification: Omit<Notification, 'id'> = {\n    userId,\n    permitId: permit.id,\n    permitNumber: permit.number || '',\n    message,\n    type,\n    isRead: false,\n    createdAt: FieldValue.serverTimestamp() as Timestamp,\n    triggeredBy,\n  };\n  await adminDb.collection('notifications').add(notification as any);\n  \n  // Enviar correo electr√≥nico\n  const userEmail = await getEmailForUser(userId);\n  if (userEmail) {\n    await sendPermitUpdateEmail({\n      to: userEmail,\n      subject: `Actualizaci√≥n en Permiso SGTC: ${permit.number || permit.id}`,\n      html: `<p>${message}</p><p>Puedes ver los detalles del permiso haciendo clic <a href=\"${process.env.NEXT_PUBLIC_BASE_URL}/permits/${permit.id}\">aqu√≠</a>.</p>`\n    });\n  }\n};\n\n// --- Fin de Funciones de Notificaciones ---\n\nconst workTypesMap: {[key: string]: string} = {\n  'alturas': 'Trabajo en Alturas',\n  'confinado': 'Espacios Confinados',\n  'energia': 'Control de Energ√≠as',\n  'izaje': 'Izaje de Cargas',\n  'excavacion': 'Excavaciones',\n  'general': 'Trabajo General'\n};\n\nconst getWorkTypesString = (permit: Partial<Permit>): string => {\n  const selectedTypes: string[] = [];\n  if (permit.trabajoAlturas) selectedTypes.push('Trabajo en Alturas');\n  if (permit.espaciosConfinados) selectedTypes.push('Espacios Confinados');\n  if (permit.controlEnergia) selectedTypes.push('Control de Energ√≠as');\n  if (permit.izajeCargas) selectedTypes.push('Izaje de Cargas');\n  if (permit.excavaciones) selectedTypes.push('Excavaciones');\n  \n  if (selectedTypes.length === 0) {\n    if (permit.trabajoGeneral) return 'Trabajo General';\n    // Fallback for old data structure\n    if (permit.workType && Array.isArray(permit.workType)) {\n      return permit.workType.map(key => workTypesMap[key] || key).join(', ');\n    }\n    return 'Trabajo General';\n  }\n  return selectedTypes.join(', ');\n};\n\nconst getStatusText = (status: string) => {\n    const statusText: {[key: string]: string} = {\n      'borrador': 'Borrador',\n      'pendiente_revision': 'Pendiente de Revisi√≥n',\n      'aprobado': 'Aprobado',\n      'en_ejecucion': 'En Ejecuci√≥n',\n      'suspendido': 'Suspendido',\n      'cerrado': 'Cerrado',\n      'rechazado': 'Rechazado'\n    };\n    return statusText[status] || status;\n  };\n\nconst signatureRoles: { [key in 'solicitante' | 'autorizante' | 'mantenimiento' | 'lider_sst' | 'coordinador_alturas']: string } = {\n  coordinador_alturas: 'COORDINADOR DE TRABAJOS EN ALTURAS',\n  solicitante: 'QUIEN SOLICITA (L√çDER A CARGO DEL EQUIPO EJECUTANTE)',\n  autorizante: 'QUIEN AUTORIZA (JEFES Y DUE√ëOS DE AREA)',\n  mantenimiento: 'PERSONAL DE MANTENIMIENTO',\n  lider_sst: 'Firma SST',\n};\n\ntype PermitCreateData = Omit<Permit, 'id' | 'createdAt' | 'status' | 'createdBy' | 'number' | 'user' | 'approvals' | 'closure'> & {\n  userId: string;\n  userDisplayName: string | null;\n  userEmail: string | null;\n  userPhotoURL: string | null;\n};\n\nexport async function createPermit(data: PermitCreateData) {\n  if (!data.userId) {\n    return { success: false, error: 'User not authenticated' };\n  }\n   if (!isAdminReady()) {\n    return { success: false, error: 'Credenciales de administrador de Firebase no configuradas en el servidor.' };\n  }\n\n  const { userId, userDisplayName, userEmail, userPhotoURL, ...permitData } = data;\n\n  const initialApprovals = {\n    solicitante: { status: 'pendiente' as const },\n    autorizante: { status: 'pendiente' as const },\n    mantenimiento: { status: 'pendiente' as const },\n    lider_sst: { status: 'pendiente' as const },\n    coordinador_alturas: { status: 'pendiente' as const },\n  };\n\n  const permitPayload: Omit<Permit, 'id'> = {\n    ...permitData,\n    status: 'pendiente_revision' as const,\n    createdBy: userId,\n    createdAt: FieldValue.serverTimestamp() as Timestamp,\n    user: {\n      displayName: userDisplayName,\n      email: userEmail,\n      photoURL: userPhotoURL,\n    },\n    approvals: initialApprovals,\n    trabajoAlturas: data.trabajoAlturas || false,\n    isSSTSignatureRequired: data.isSSTSignatureRequired || false,\n    closure: {},\n  };\n  \n  try {\n    const docRef = await adminDb.collection('permits').add(permitPayload as any);\n    const permitNumber = `PT-${Date.now()}-${docRef.id.substring(0, 6).toUpperCase()}`;\n    await docRef.update({ number: permitNumber });\n    \n    console.log('‚úÖ [Action] Permiso creado con √©xito en Firestore:', docRef.id);\n\n    const createdPermit = { ...permitPayload, id: docRef.id, number: permitNumber } as Permit;\n    const involvedUsers = await getInvolvedUsers(createdPermit);\n    const message = `Se cre√≥ un nuevo permiso de trabajo: #${permitNumber}`;\n    \n    for (const uid of involvedUsers) {\n      if (uid !== userId) {\n        await createNotification(uid, createdPermit, message, 'creation', { uid: userId, displayName: userDisplayName });\n      }\n    }\n\n    const workTypesText = getWorkTypesString(permitPayload);\n    const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'https://sgpt-movil.web.app';\n    const permitUrl = `${baseUrl}/permits/${docRef.id}`;\n    \n    const messageBody = `*¬°Alerta de Seguridad SGPT!* üö®\nSe ha creado una nueva solicitud de permiso de trabajo.\n\nüìÑ *N√∫mero:* ${permitNumber}\nüë§ *Solicitante:* ${userDisplayName || 'N/A'}\nüõ†Ô∏è *Tipo de Trabajo:* ${workTypesText}\n\nPor favor, revise la solicitud para su aprobaci√≥n en el siguiente enlace:\n${permitUrl}`;\n    \n    await sendWhatsAppNotification(messageBody);\n    \n    revalidatePath('/permits');\n    revalidatePath('/dashboard');\n    \n    return { success: true, permitId: docRef.id, permitNumber };\n  } catch (error: any) {\n    console.error(\"‚ùå [Action] Error al crear permiso:\", error);\n    return { \n      success: false, \n      error: error.message || 'Could not create permit. Please try again.' \n    };\n  }\n}\n\nexport async function savePermitDraft(data: PermitCreateData & { draftId?: string }) {\n  if (!data.userId) {\n    return { success: false, error: 'User not authenticated' };\n  }\n  if (!isAdminReady()) {\n    return { success: false, error: 'Credenciales de administrador de Firebase no configuradas en el servidor.' };\n  }\n\n  const { userId, userDisplayName, userEmail, userPhotoURL, draftId, ...permitData } = data;\n\n  const initialApprovals = {\n    solicitante: { status: 'pendiente' as const },\n    autorizante: { status: 'pendiente' as const },\n    mantenimiento: { status: 'pendiente' as const },\n    lider_sst: { status: 'pendiente' as const },\n    coordinador_alturas: { status: 'pendiente' as const },\n  };\n\n  const permitPayload: Omit<Permit, 'id' | 'createdAt'> = {\n    ...permitData,\n    status: 'borrador' as const,\n    createdBy: userId,\n    user: {\n      displayName: userDisplayName,\n      email: userEmail,\n      photoURL: userPhotoURL,\n    },\n    approvals: initialApprovals,\n    trabajoAlturas: data.trabajoAlturas || false,\n    isSSTSignatureRequired: data.isSSTSignatureRequired || false,\n  };\n\n  try {\n    if (draftId) {\n      // Actualizar un borrador existente\n      const docRef = adminDb.collection('permits').doc(draftId);\n      await docRef.update({ ...permitPayload, updatedAt: FieldValue.serverTimestamp() });\n      revalidatePath(`/permits/${draftId}`);\n      revalidatePath('/permits');\n      return { success: true, permitId: draftId, isUpdate: true };\n    } else {\n      // Crear un nuevo borrador\n      const payloadWithTimestamp = { ...permitPayload, createdAt: FieldValue.serverTimestamp() };\n      const docRef = await adminDb.collection('permits').add(payloadWithTimestamp as any);\n      revalidatePath('/permits');\n      return { success: true, permitId: docRef.id, isUpdate: false };\n    }\n  } catch (error: any) {\n    console.error(\"‚ùå [Action] Error al guardar borrador:\", error);\n    return { \n      success: false, \n      error: error.message || 'Could not save draft. Please try again.' \n    };\n  }\n}\n\nexport async function addSignatureAndNotify(\n  permitId: string, \n  role: 'solicitante' | 'autorizante' | 'mantenimiento' | 'lider_sst' | 'coordinador_alturas' | 'cierre_autoridad' | 'cierre_responsable' | 'cancelacion', \n  signatureType: 'firmaApertura' | 'firmaCierre',\n  signatureDataUrl: string,\n  user: { uid: string, displayName: string | null, role?: UserRole, empresa?: string },\n  comments?: string\n) {\n    if (!permitId || !role || !user || !user.uid || !user.role) {\n        return { success: false, error: 'Par√°metros inv√°lidos para guardar la firma.' };\n    }\n    if (!isAdminReady()) {\n      return { success: false, error: 'Credenciales de administrador de Firebase no configuradas en el servidor.' };\n    }\n\n    try {\n        const docRef = adminDb.collection('permits').doc(permitId);\n        const permitDocBefore = await docRef.get();\n        if (!permitDocBefore.exists) {\n            return { success: false, error: 'El permiso no existe.' };\n        }\n        const permitBeforeData = permitDocBefore.data() as Permit;\n\n        const updateData: UpdateData<Permit> = {};\n\n        // L√≥gica para manejar firmas de cierre y cancelaci√≥n\n        if (role.startsWith('cierre_') || role === 'cancelacion') {\n            const closureRole = role === 'cierre_autoridad' ? 'autoridad' : (role === 'cierre_responsable' ? 'responsable' : 'canceladoPor');\n            const closurePath = `closure.${closureRole}`;\n            \n            const existingClosureData = (permitBeforeData.closure as any)?.[closureRole] || {};\n\n            updateData[closurePath as keyof UpdateData<Permit>] = {\n                ...existingClosureData,\n                firma: signatureDataUrl,\n                nombre: user.displayName,\n                fecha: FieldValue.serverTimestamp() \n            };\n            \n            if (role === 'cancelacion') {\n                updateData['closure.razonCancelacion'] = comments || 'No especificado';\n                updateData['closure.cancelado'] = 'si';\n            }\n\n        } else {\n            // ‚úÖ VALIDACI√ìN DE PERMISOS ANTES DE FIRMAR\n            const canSign = await validateSignaturePermission(permitId, role, user);\n            if (!canSign.allowed) {\n                return { success: false, error: canSign.reason };\n            }\n\n            const approvalData: Partial<Approval> = {\n                status: 'aprobado',\n                firmaApertura: signatureDataUrl,\n                userName: user.displayName,\n                userId: user.uid,\n                signedAt: FieldValue.serverTimestamp() as any,\n                userRole: user.role,\n                userEmpresa: user.empresa || 'N/A',\n                comments: comments || '',\n            }\n            \n            updateData[`approvals.${role}`] = approvalData;\n            \n            // ‚úÖ L√ìGICA DE FIRMAS SEG√öN EL ROL\n            if (signatureType === 'firmaApertura') {\n                const validationPayload: ValidacionDiaria = { \n                    dia: 1, \n                    nombre: user.displayName || '', \n                    firma: signatureDataUrl, \n                    fecha: new Date().toISOString() \n                };\n                \n                // ‚úÖ SOLICITANTE FIRMA: Cambia de Borrador a Pendiente de Revisi√≥n\n                if (role === 'solicitante') {\n                    if (permitBeforeData.status === 'borrador') {\n                        const permitNumber = `PT-${Date.now()}-${permitId.substring(0, 6).toUpperCase()}`;\n                        updateData['number'] = permitNumber;\n                        updateData['status'] = 'pendiente_revision';\n                    }\n                    \n                    // Validaci√≥n diaria inicial del responsable\n                    ['anexoAltura', 'anexoConfinado', 'anexoIzaje', 'anexoExcavaciones'].forEach(anexo => {\n                        if ((permitBeforeData as any)?.[anexo]) {\n                            const currentValidations = (permitBeforeData as any)[anexo].validacion?.responsable || [];\n                            if (!currentValidations[0]?.firma) {\n                                currentValidations[0] = validationPayload;\n                                updateData[`${anexo}.validacion.responsable`] = currentValidations;\n                            }\n                        }\n                    });\n\n                // ‚úÖ AUTORIZANTE FIRMA: Agrega validaci√≥n diaria de autoridad\n                } else if (role === 'autorizante') {\n                    ['anexoAltura', 'anexoConfinado', 'anexoIzaje', 'anexoExcavaciones'].forEach(anexo => {\n                        if ((permitBeforeData as any)?.[anexo]) {\n                           const currentValidations = (permitBeforeData as any)[anexo].validacion?.autoridad || [];\n                            if (!currentValidations[0]?.firma) {\n                                currentValidations[0] = validationPayload;\n                                updateData[`${anexo}.validacion.autoridad`] = currentValidations;\n                            }\n                        }\n                    });\n                }\n            }\n\n            // ‚úÖ VERIFICACI√ìN AUTOM√ÅTICA: ¬øTodas las firmas requeridas est√°n completas?\n            const updatedPermitData = { \n                ...permitBeforeData, \n                approvals: { ...permitBeforeData.approvals, [role]: approvalData }\n            };\n            \n            if (await checkAllRequiredSignaturesComplete(updatedPermitData)) {\n                // üöÄ CAMBIO AUTOM√ÅTICO DE PENDIENTE_REVISION ‚Üí EN_EJECUCION\n                if (permitBeforeData.status === 'pendiente_revision') {\n                    updateData['status'] = 'en_ejecucion';\n                }\n            }\n        }\n        \n        await docRef.update(updateData);\n        \n        const permitDoc = await docRef.get();\n        const updatedPermitData = { id: permitDoc.id, ...permitDoc.data() } as Permit;\n        \n        const signatureRoleName = (signatureRoles as any)[role] || role.replace('_', ' ').replace(/\\b\\w/g, l => l.toUpperCase());\n        \n        const message = `${user.displayName || 'Un usuario'} ha firmado el permiso #${updatedPermitData.number} como ${signatureRoleName}.`;\n        const involvedUsers = await getInvolvedUsers(updatedPermitData);\n        \n        for (const uid of involvedUsers) {\n          if (uid !== user.uid) {\n            await createNotification(uid, updatedPermitData, message, 'signature', user);\n          }\n        }\n        \n        // ‚úÖ NOTIFICACI√ìN ESPECIAL SI EL PERMISO PAS√ì AUTOM√ÅTICAMENTE A EN_EJECUCION\n        if (updateData['status'] === 'en_ejecucion') {\n            const executionMessage = `El permiso #${updatedPermitData.number} ha completado todas las aprobaciones requeridas y ahora est√° EN EJECUCI√ìN.`;\n            for (const uid of involvedUsers) {\n                 await createNotification(uid, updatedPermitData, executionMessage, 'approval', user);\n            }\n            \n            // Notificaci√≥n WhatsApp\n            const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'https://sgpt-movil.web.app';\n            const permitUrl = `${baseUrl}/permits/${permitId}`;\n            const whatsappMsg = `*¬°PERMISO EN EJECUCI√ìN!* ‚úÖ\n\nüìÑ *N√∫mero:* ${updatedPermitData.number}\nüìç *√Årea:* ${permitBeforeData.generalInfo?.areaEspecifica || 'N/A'}\nüõ†Ô∏è *Tipo:* ${getWorkTypesString(permitBeforeData)}\n\n‚úÖ Todas las firmas requeridas han sido completadas.\nEl permiso est√° ahora EN EJECUCI√ìN.\n\nVer detalles: ${permitUrl}`;\n            \n            await sendWhatsAppNotification(whatsappMsg);\n        }\n\n        revalidatePath(`/permits/${permitId}`);\n        return { success: true };\n\n    } catch (error: any) {\n        console.error(\"‚ùå Error al guardar firma y notificar:\", error);\n        return {\n            success: false,\n            error: error.message || 'No se pudo guardar la firma.'\n        };\n    }\n}\n\n// ‚úÖ FUNCI√ìN CORREGIDA: Verificar si todas las firmas requeridas est√°n completas\nasync function checkAllRequiredSignaturesComplete(\n  permitData: Permit\n): Promise<boolean> {\n    const { approvals } = permitData;\n    \n    // Firma del solicitante es SIEMPRE requerida\n    if (approvals?.solicitante?.status !== 'aprobado') {\n        return false;\n    }\n    \n    // Firma del autorizante es SIEMPRE requerida\n    if (approvals?.autorizante?.status !== 'aprobado') {\n        return false;\n    }\n    \n    // Si hay trabajos en alturas, requiere firma del coordinador\n    if (permitData.trabajoAlturas || permitData.selectedWorkTypes?.alturas) {\n        if (approvals?.coordinador_alturas?.status !== 'aprobado') {\n            return false;\n        }\n    }\n    \n    // Si hay control de energ√≠a, requiere firma de mantenimiento\n    if (permitData.controlEnergia) {\n        if (approvals?.mantenimiento?.status !== 'aprobado') {\n            return false;\n        }\n    }\n    \n    // Si SST es requerido, validar su firma\n    if (permitData.isSSTSignatureRequired) {\n        if (approvals?.lider_sst?.status !== 'aprobado') {\n            return false;\n        }\n    }\n    \n    return true;\n}\n\n// ‚úÖ FUNCI√ìN MEJORADA: Validaci√≥n de transiciones de estado\nfunction validateStateTransition(currentStatus: PermitStatus, targetStatus: PermitStatus, userRole: UserRole): { allowed: boolean, reason?: string } {\n    const allowedTransitions: Partial<Record<PermitStatus, Partial<Record<PermitStatus, UserRole[]>>>> = {\n        'borrador': {\n            'pendiente_revision': ['solicitante', 'lider_tarea', 'admin']\n        },\n        'pendiente_revision': {\n            'en_ejecucion': ['autorizante', 'admin'],\n            'rechazado': ['autorizante', 'lider_sst', 'admin']\n        },\n        'en_ejecucion': {\n            'suspendido': ['lider_sst', 'admin'],\n            'cerrado': ['lider_tarea', 'autorizante', 'admin']\n        },\n        'suspendido': {\n            'en_ejecucion': ['lider_sst', 'admin'],\n            'cerrado': ['lider_tarea', 'autorizante', 'admin']\n        },\n        // Mantener compatibilidad con permisos antiguos que tengan estado \"aprobado\"\n        'aprobado': {\n            'en_ejecucion': ['lider_tarea', 'admin'],\n            'rechazado': ['autorizante', 'lider_sst', 'admin']\n        }\n    };\n    \n    const allowedRoles = allowedTransitions[currentStatus]?.[targetStatus];\n    if (!allowedRoles) {\n        return { allowed: false, reason: `Transici√≥n de '${currentStatus}' a '${targetStatus}' no est√° permitida.` };\n    }\n\n    if (!allowedRoles.includes(userRole) && userRole !== 'admin') {\n        return { allowed: false, reason: `Tu rol (${userRole}) no tiene permisos para cambiar el estado a '${targetStatus}'.` };\n    }\n\n    return { allowed: true };\n}\n\nexport async function updatePermitStatus(\n  permitId: string,\n  status: PermitStatus,\n  currentUser: { uid: string, displayName: string | null, role?: UserRole },\n  reason?: string\n) {\n    if (!permitId || !currentUser.uid || !currentUser.role) {\n        return { success: false, error: 'Par√°metros inv√°lidos o usuario sin rol.' };\n    }\n    if (!isAdminReady()) {\n      return { success: false, error: 'Credenciales de administrador de Firebase no configuradas.' };\n    }\n\n    try {\n        const docRef = adminDb.collection('permits').doc(permitId);\n        const permitSnap = await docRef.get();\n        if (!permitSnap.exists) {\n            return { success: false, error: 'El permiso no existe.' };\n        }\n        const permitData = permitSnap.data() as Permit;\n        \n        // ‚úÖ Validar transici√≥n de estado\n        const transition = validateStateTransition(permitData.status, status, currentUser.role);\n        if (!transition.allowed) {\n            return { success: false, error: transition.reason };\n        }\n\n        const updateData: UpdateData<Permit> = { status };\n\n        // ‚úÖ Guardar raz√≥n de rechazo\n        if (status === 'rechazado' && reason) {\n            updateData.rejectionReason = reason;\n        }\n        \n        // ‚úÖ Marcar fecha de cierre\n        if (status === 'cerrado') {\n            updateData['closure.fechaCierre'] = FieldValue.serverTimestamp();\n            updateData['closure.terminado'] = 'si';\n        }\n\n        await docRef.update(updateData);\n        \n        const updatedPermitData = { ...permitData, ...updateData, id: permitId } as Permit;\n        const triggeredBy = currentUser;\n        \n        let notificationType: Notification['type'] = 'status_change';\n        let message = `${currentUser.displayName || 'Un usuario'} ha cambiado el estado del permiso #${permitData.number} a: ${getStatusText(status)}.`;\n\n        if (status === 'en_ejecucion') {\n            notificationType = 'approval';\n            message = `El permiso #${permitData.number} ha sido puesto EN EJECUCI√ìN manualmente.`;\n        } else if (status === 'rechazado') {\n            notificationType = 'rejection';\n            message = `${currentUser.displayName || 'Un usuario'} ha rechazado el permiso #${permitData.number}.`;\n            if (reason) message += ` Motivo: ${reason}`;\n        } else if (status === 'cerrado') {\n            notificationType = 'cancellation';\n            message = `${currentUser.displayName || 'Un usuario'} ha cerrado el permiso #${permitData.number}.`;\n        }\n        \n        const involvedUsers = await getInvolvedUsers(updatedPermitData);\n        for (const uid of involvedUsers) {\n             if (uid !== currentUser.uid) {\n                await createNotification(uid, updatedPermitData, message, notificationType, triggeredBy);\n            }\n        }\n\n        const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'https://sgpt-movil.web.app';\n        const permitUrl = `${baseUrl}/permits/${permitId}`;\n\n        let messageBody = `*Actualizaci√≥n de Estado - SGTC* üîÑ\nEl estado del permiso *${permitData.number || permitId}* ha cambiado.\n\n*Nuevo Estado:* ${getStatusText(status)}\n\nPuede ver los detalles aqu√≠:\n${permitUrl}`;\n\n        if (status === 'rechazado' && reason) {\n          messageBody += `\\n\\n*Motivo del rechazo:* ${reason}`;\n        }\n        \n        await sendWhatsAppNotification(messageBody);\n        \n        revalidatePath(`/permits/${permitId}`);\n        revalidatePath('/permits');\n        revalidatePath('/dashboard');\n\n        return { success: true };\n    } catch (error: any) {\n        console.error(\"‚ùå Error updating permit status:\", error);\n        return {\n            success: false,\n            error: error.message || 'Could not update permit status.'\n        };\n    }\n}\n\n// ‚úÖ FUNCI√ìN MEJORADA: Validaci√≥n de permisos de firma con orden jer√°rquico\nasync function validateSignaturePermission(\n    permitId: string, \n    signatureRole: string, \n    currentUser: { uid: string, role?: UserRole }\n): Promise<{ allowed: boolean, reason?: string }> {\n    const docRef = adminDb.collection('permits').doc(permitId);\n    const permitDoc = await docRef.get();\n    if (!permitDoc.exists) {\n        return { allowed: false, reason: 'Permiso no encontrado.' };\n    }\n    const permit = permitDoc.data() as Permit;\n    \n    // ‚úÖ Verificar que el permiso est√© en un estado v√°lido para firmar\n    if (!['borrador', 'pendiente_revision'].includes(permit.status)) {\n        return { allowed: false, reason: `No se puede firmar un permiso en estado '${permit.status}'.` };\n    }\n    \n    switch (signatureRole) {\n        case 'coordinador_alturas':\n            // Debe haber trabajo en alturas\n            if (!permit.trabajoAlturas && !permit.selectedWorkTypes?.alturas) {\n                return { allowed: false, reason: 'Esta firma solo aplica para trabajos en alturas.' };\n            }\n            // Solo el creador o admin puede gestionar esta firma\n            if (permit.createdBy !== currentUser.uid && currentUser.role !== 'admin') {\n                return { allowed: false, reason: 'Solo el creador del permiso puede gestionar esta firma.' };\n            }\n            break;\n            \n        case 'solicitante':\n            if (permit.createdBy !== currentUser.uid && currentUser.role !== 'admin') {\n                return { allowed: false, reason: 'Solo el creador del permiso puede firmar como solicitante.' };\n            }\n            // ‚úÖ Si hay anexo de alturas, verificar firma del coordinador primero\n            if ((permit.trabajoAlturas || permit.selectedWorkTypes?.alturas) && \n                permit.approvals?.coordinador_alturas?.status !== 'aprobado') {\n                return { allowed: false, reason: 'Se requiere primero la firma del Coordinador de Trabajos en Alturas.' };\n            }\n            break;\n            \n        case 'autorizante':\n            if (currentUser.role !== 'autorizante' && currentUser.role !== 'admin') {\n                return { allowed: false, reason: 'Rol de autorizante requerido para esta firma.' };\n            }\n            if (permit.approvals?.solicitante?.status !== 'aprobado') {\n                return { allowed: false, reason: 'Se requiere primero la firma del solicitante.' };\n            }\n            break;\n            \n        case 'lider_sst':\n            if (currentUser.role !== 'lider_sst' && currentUser.role !== 'admin') {\n                return { allowed: false, reason: 'Rol de L√≠der SST requerido para esta firma.' };\n            }\n            // ‚úÖ Solo requerido si isSSTSignatureRequired es true\n            if (!permit.isSSTSignatureRequired) {\n                return { allowed: false, reason: 'Firma de SST no es requerida para este permiso.' };\n            }\n            if (permit.approvals?.solicitante?.status !== 'aprobado') {\n                return { allowed: false, reason: 'Se requiere primero la firma del solicitante.' };\n            }\n            break;\n            \n        case 'mantenimiento':\n             if (currentUser.role !== 'mantenimiento' && currentUser.role !== 'admin') {\n                return { allowed: false, reason: 'Rol de Mantenimiento requerido para esta firma.' };\n            }\n            if (!permit.controlEnergia) {\n                return { allowed: false, reason: 'Firma de Mantenimiento solo aplica cuando hay control de energ√≠as.' };\n            }\n            if (permit.approvals?.autorizante?.status !== 'aprobado') {\n                return { allowed: false, reason: 'Se requiere primero la firma del autorizante.' };\n            }\n            break;\n    }\n    \n    return { allowed: true };\n}\n\nexport async function addDailyValidationSignature(\n  permitId: string, \n  anexoName: string, \n  validationType: 'autoridad' | 'responsable', \n  index: number, \n  data: ValidacionDiaria, \n  user: User\n) {\n  if (!permitId || !anexoName || !validationType || index < 0 || !data || !user) {\n    return { success: false, error: 'Par√°metros inv√°lidos.' };\n  }\n\n  if (!isAdminReady()) {\n    return { success: false, error: 'Credenciales de administrador de Firebase no configuradas en el servidor.' };\n  }\n\n  const docRef = adminDb.collection('permits').doc(permitId);\n  try {\n    const permitSnap = await docRef.get();\n    if (!permitSnap.exists) {\n      return { success: false, error: 'El permiso no existe.' };\n    }\n    const permitData = permitSnap.data() as Permit;\n\n    // ‚úÖ Verificar que el permiso est√© en ejecuci√≥n para validaciones diarias\n    if (!['en_ejecucion', 'suspendido'].includes(permitData.status)) {\n        return { success: false, error: 'Solo se pueden agregar validaciones diarias en permisos EN EJECUCI√ìN o SUSPENDIDOS.' };\n    }\n\n    const anexoData = (permitData as any)[anexoName];\n    if (!anexoData) {\n      return { success: false, error: `El anexo ${anexoName} no existe en el permiso.` };\n    }\n    \n    const anexoUpdate: any = { ...anexoData };\n    if (!anexoUpdate.validacion) {\n        anexoUpdate.validacion = { autoridad: [], responsable: [] };\n    }\n\n    const validationArray = (anexoUpdate.validacion[validationType] as ValidacionDiaria[]) || [];\n    \n    while (validationArray.length <= index) {\n        validationArray.push({ dia: validationArray.length + 1, nombre: '', fecha: '', firma: '' });\n    }\n\n    validationArray[index] = data;\n    \n    const updatePath = `${anexoName}.validacion.${validationType}`;\n    \n    await docRef.update({\n      [updatePath]: validationArray,\n    });\n\n    const fullPermitData = { id: docRef.id, ...permitData } as Permit;\n    const anexoDisplayName = anexoName.replace('anexo', 'Anexo ');\n    const validationRoleName = validationType === 'autoridad' ? 'Autoridad del √Årea' : 'Responsable del Trabajo';\n    const day = index + 1;\n\n    const message = `${user.displayName || 'Un usuario'} ha realizado la validaci√≥n diaria (${validationRoleName}) para el D√çA ${day} del ${anexoDisplayName} en el permiso #${fullPermitData.number}.`;\n    const involvedUsers = await getInvolvedUsers(fullPermitData);\n    for (const uid of involvedUsers) {\n      if (uid !== user.uid) {\n        await createNotification(uid, fullPermitData, message, 'status_change', { uid: user.uid, displayName: user.displayName || null });\n      }\n    }\n\n    const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'https://sgpt-movil.web.app';\n    const permitUrl = `${baseUrl}/permits/${permitId}`;\n    const whatsappMessage = `*Validaci√≥n Diaria - SGTC* ‚úçÔ∏è\nSe ha registrado una nueva firma de validaci√≥n diaria.\n\nüìÑ *Permiso:* ${fullPermitData.number || 'N/A'}\nüóìÔ∏è *D√≠a:* ${day}\nüë§ *Firmante:* ${user.displayName || 'N/A'}\n‚úÖ *Rol:* ${validationRoleName}\nüìã *Anexo:* ${anexoDisplayName}\n\nPuede ver los detalles aqu√≠:\n${permitUrl}`;\n    \n    await sendWhatsAppNotification(whatsappMessage);\n\n    revalidatePath(`/permits/${permitId}`);\n    return { success: true };\n\n  } catch (error: any) {\n    console.error(\"‚ùå Error al guardar la validaci√≥n diaria:\", error);\n    return { success: false, error: 'No se pudo guardar la firma de validaci√≥n.' };\n  }\n}\n\nexport async function addWorkerSignature(permitId: string, workerIndex: number, signatureType: 'firmaApertura' | 'firmaCierre', signatureDataUrl: string) {\n    if (!permitId || workerIndex < 0 || !signatureType || !signatureDataUrl) {\n        return { success: false, error: 'Faltan par√°metros.' };\n    }\n    if (!isAdminReady()) {\n      return { success: false, error: 'Credenciales de administrador de Firebase no configuradas en el servidor.' };\n    }\n\n    const docRef = adminDb.collection('permits').doc(permitId);\n    try {\n        const permitSnap = await docRef.get();\n        if (!permitSnap.exists) {\n            return { success: false, error: 'El permiso no existe.' };\n        }\n\n        const permitData = permitSnap.data() as Permit;\n        \n        // ‚úÖ CORRECCI√ìN: Validaci√≥n de estado corregida para firma de apertura\n        if (signatureType === 'firmaApertura' && !['pendiente_revision', 'aprobado', 'en_ejecucion'].includes(permitData.status)) {\n            return { success: false, error: 'Solo se puede firmar apertura cuando el permiso est√° pendiente, aprobado o en ejecuci√≥n.' };\n        }\n        if (signatureType === 'firmaCierre' && !['en_ejecucion', 'suspendido'].includes(permitData.status)) {\n            return { success: false, error: 'Solo se puede firmar cierre en permisos EN EJECUCI√ìN o SUSPENDIDOS.' };\n        }\n        \n        const workers = permitData.workers ? [...permitData.workers] : [];\n\n        if (workerIndex >= workers.length) {\n            return { success: false, error: '√çndice de trabajador inv√°lido.' };\n        }\n\n        const signatureField = signatureType === 'firmaApertura' ? 'firmaApertura' : 'firmaCierre';\n        const dateField = signatureType === 'firmaApertura' ? 'fechaFirmaApertura' : 'fechaFirmaCierre';\n\n        workers[workerIndex] = {\n            ...workers[workerIndex],\n            [signatureField]: signatureDataUrl,\n            [dateField]: new Date().toISOString(), \n        };\n\n        await docRef.update({ workers: workers });\n\n        revalidatePath(`/permits/${permitId}`);\n        return { success: true };\n    } catch (error: any) {\n        console.error(\"Error al guardar la firma del trabajador:\", error);\n        return { success: false, error: 'No se pudo guardar la firma.' };\n    }\n}\n"],"names":[],"mappings":";;;;;;IA6fsB,qBAAA,WAAA,GAAA,CAAA,GAAA,sNAAA,CAAA,wBAAA,EAAA,8CAAA,sNAAA,CAAA,aAAA,EAAA,KAAA,GAAA,sNAAA,CAAA,mBAAA,EAAA","debugId":null}},
    {"offset": {"line": 739, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/app/%28app%29/permits/actions.ts"],"sourcesContent":["\n'use server';\n\nimport { adminDb, isAdminReady } from '@/lib/firebase-admin';\nimport { revalidatePath } from 'next/cache';\nimport type { Permit, ExternalWorker, PermitStatus, PermitClosure, Approval, UserRole, AnexoAltura, AnexoConfinado, AnexoEnergias, AnexoExcavaciones, AnexoIzaje, AnexoATS, PermitGeneralInfo, JustificacionATS, ValidacionDiaria, User, Notification } from '@/types';\nimport { FieldValue, UpdateData, Timestamp } from 'firebase-admin/firestore';\nimport { sendWhatsAppNotification } from '@/lib/notifications';\nimport { getEmailForUser, sendPermitUpdateEmail } from '@/lib/email';\nimport { config } from 'dotenv';\nconfig();\n\n// --- Funciones Auxiliares para Notificaciones ---\n\nconst getInvolvedUsers = async (permit: Permit): Promise<string[]> => {\n  const userIds = new Set<string>();\n\n  // 1. Creador del permiso\n  if (permit.createdBy) {\n    userIds.add(permit.createdBy);\n  }\n\n  // 2. Usuarios que han firmado\n  Object.values(permit.approvals || {}).forEach(approval => {\n    if (approval && approval.userId) {\n      userIds.add(approval.userId);\n    }\n  });\n\n  // 3. Roles administrativos o de supervisi√≥n que deber√≠an ser notificados\n  const adminsQuery = await adminDb.collection('users').where('role', 'in', ['admin', 'autorizante', 'lider_sst']).get();\n  adminsQuery.forEach(doc => userIds.add(doc.id));\n\n  return Array.from(userIds);\n};\n\nconst createNotification = async (\n  userId: string,\n  permit: Permit,\n  message: string,\n  type: Notification['type'],\n  triggeredBy: { uid: string, displayName: string | null }\n) => {\n  const notification: Omit<Notification, 'id'> = {\n    userId,\n    permitId: permit.id,\n    permitNumber: permit.number || '',\n    message,\n    type,\n    isRead: false,\n    createdAt: FieldValue.serverTimestamp() as Timestamp,\n    triggeredBy,\n  };\n  await adminDb.collection('notifications').add(notification as any);\n  \n  // Enviar correo electr√≥nico\n  const userEmail = await getEmailForUser(userId);\n  if (userEmail) {\n    await sendPermitUpdateEmail({\n      to: userEmail,\n      subject: `Actualizaci√≥n en Permiso SGTC: ${permit.number || permit.id}`,\n      html: `<p>${message}</p><p>Puedes ver los detalles del permiso haciendo clic <a href=\"${process.env.NEXT_PUBLIC_BASE_URL}/permits/${permit.id}\">aqu√≠</a>.</p>`\n    });\n  }\n};\n\n// --- Fin de Funciones de Notificaciones ---\n\nconst workTypesMap: {[key: string]: string} = {\n  'alturas': 'Trabajo en Alturas',\n  'confinado': 'Espacios Confinados',\n  'energia': 'Control de Energ√≠as',\n  'izaje': 'Izaje de Cargas',\n  'excavacion': 'Excavaciones',\n  'general': 'Trabajo General'\n};\n\nconst getWorkTypesString = (permit: Partial<Permit>): string => {\n  const selectedTypes: string[] = [];\n  if (permit.trabajoAlturas) selectedTypes.push('Trabajo en Alturas');\n  if (permit.espaciosConfinados) selectedTypes.push('Espacios Confinados');\n  if (permit.controlEnergia) selectedTypes.push('Control de Energ√≠as');\n  if (permit.izajeCargas) selectedTypes.push('Izaje de Cargas');\n  if (permit.excavaciones) selectedTypes.push('Excavaciones');\n  \n  if (selectedTypes.length === 0) {\n    if (permit.trabajoGeneral) return 'Trabajo General';\n    // Fallback for old data structure\n    if (permit.workType && Array.isArray(permit.workType)) {\n      return permit.workType.map(key => workTypesMap[key] || key).join(', ');\n    }\n    return 'Trabajo General';\n  }\n  return selectedTypes.join(', ');\n};\n\nconst getStatusText = (status: string) => {\n    const statusText: {[key: string]: string} = {\n      'borrador': 'Borrador',\n      'pendiente_revision': 'Pendiente de Revisi√≥n',\n      'aprobado': 'Aprobado',\n      'en_ejecucion': 'En Ejecuci√≥n',\n      'suspendido': 'Suspendido',\n      'cerrado': 'Cerrado',\n      'rechazado': 'Rechazado'\n    };\n    return statusText[status] || status;\n  };\n\nconst signatureRoles: { [key in 'solicitante' | 'autorizante' | 'mantenimiento' | 'lider_sst' | 'coordinador_alturas']: string } = {\n  coordinador_alturas: 'COORDINADOR DE TRABAJOS EN ALTURAS',\n  solicitante: 'QUIEN SOLICITA (L√çDER A CARGO DEL EQUIPO EJECUTANTE)',\n  autorizante: 'QUIEN AUTORIZA (JEFES Y DUE√ëOS DE AREA)',\n  mantenimiento: 'PERSONAL DE MANTENIMIENTO',\n  lider_sst: 'Firma SST',\n};\n\ntype PermitCreateData = Omit<Permit, 'id' | 'createdAt' | 'status' | 'createdBy' | 'number' | 'user' | 'approvals' | 'closure'> & {\n  userId: string;\n  userDisplayName: string | null;\n  userEmail: string | null;\n  userPhotoURL: string | null;\n};\n\nexport async function createPermit(data: PermitCreateData) {\n  if (!data.userId) {\n    return { success: false, error: 'User not authenticated' };\n  }\n   if (!isAdminReady()) {\n    return { success: false, error: 'Credenciales de administrador de Firebase no configuradas en el servidor.' };\n  }\n\n  const { userId, userDisplayName, userEmail, userPhotoURL, ...permitData } = data;\n\n  const initialApprovals = {\n    solicitante: { status: 'pendiente' as const },\n    autorizante: { status: 'pendiente' as const },\n    mantenimiento: { status: 'pendiente' as const },\n    lider_sst: { status: 'pendiente' as const },\n    coordinador_alturas: { status: 'pendiente' as const },\n  };\n\n  const permitPayload: Omit<Permit, 'id'> = {\n    ...permitData,\n    status: 'pendiente_revision' as const,\n    createdBy: userId,\n    createdAt: FieldValue.serverTimestamp() as Timestamp,\n    user: {\n      displayName: userDisplayName,\n      email: userEmail,\n      photoURL: userPhotoURL,\n    },\n    approvals: initialApprovals,\n    trabajoAlturas: data.trabajoAlturas || false,\n    isSSTSignatureRequired: data.isSSTSignatureRequired || false,\n    closure: {},\n  };\n  \n  try {\n    const docRef = await adminDb.collection('permits').add(permitPayload as any);\n    const permitNumber = `PT-${Date.now()}-${docRef.id.substring(0, 6).toUpperCase()}`;\n    await docRef.update({ number: permitNumber });\n    \n    console.log('‚úÖ [Action] Permiso creado con √©xito en Firestore:', docRef.id);\n\n    const createdPermit = { ...permitPayload, id: docRef.id, number: permitNumber } as Permit;\n    const involvedUsers = await getInvolvedUsers(createdPermit);\n    const message = `Se cre√≥ un nuevo permiso de trabajo: #${permitNumber}`;\n    \n    for (const uid of involvedUsers) {\n      if (uid !== userId) {\n        await createNotification(uid, createdPermit, message, 'creation', { uid: userId, displayName: userDisplayName });\n      }\n    }\n\n    const workTypesText = getWorkTypesString(permitPayload);\n    const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'https://sgpt-movil.web.app';\n    const permitUrl = `${baseUrl}/permits/${docRef.id}`;\n    \n    const messageBody = `*¬°Alerta de Seguridad SGPT!* üö®\nSe ha creado una nueva solicitud de permiso de trabajo.\n\nüìÑ *N√∫mero:* ${permitNumber}\nüë§ *Solicitante:* ${userDisplayName || 'N/A'}\nüõ†Ô∏è *Tipo de Trabajo:* ${workTypesText}\n\nPor favor, revise la solicitud para su aprobaci√≥n en el siguiente enlace:\n${permitUrl}`;\n    \n    await sendWhatsAppNotification(messageBody);\n    \n    revalidatePath('/permits');\n    revalidatePath('/dashboard');\n    \n    return { success: true, permitId: docRef.id, permitNumber };\n  } catch (error: any) {\n    console.error(\"‚ùå [Action] Error al crear permiso:\", error);\n    return { \n      success: false, \n      error: error.message || 'Could not create permit. Please try again.' \n    };\n  }\n}\n\nexport async function savePermitDraft(data: PermitCreateData & { draftId?: string }) {\n  if (!data.userId) {\n    return { success: false, error: 'User not authenticated' };\n  }\n  if (!isAdminReady()) {\n    return { success: false, error: 'Credenciales de administrador de Firebase no configuradas en el servidor.' };\n  }\n\n  const { userId, userDisplayName, userEmail, userPhotoURL, draftId, ...permitData } = data;\n\n  const initialApprovals = {\n    solicitante: { status: 'pendiente' as const },\n    autorizante: { status: 'pendiente' as const },\n    mantenimiento: { status: 'pendiente' as const },\n    lider_sst: { status: 'pendiente' as const },\n    coordinador_alturas: { status: 'pendiente' as const },\n  };\n\n  const permitPayload: Omit<Permit, 'id' | 'createdAt'> = {\n    ...permitData,\n    status: 'borrador' as const,\n    createdBy: userId,\n    user: {\n      displayName: userDisplayName,\n      email: userEmail,\n      photoURL: userPhotoURL,\n    },\n    approvals: initialApprovals,\n    trabajoAlturas: data.trabajoAlturas || false,\n    isSSTSignatureRequired: data.isSSTSignatureRequired || false,\n  };\n\n  try {\n    if (draftId) {\n      // Actualizar un borrador existente\n      const docRef = adminDb.collection('permits').doc(draftId);\n      await docRef.update({ ...permitPayload, updatedAt: FieldValue.serverTimestamp() });\n      revalidatePath(`/permits/${draftId}`);\n      revalidatePath('/permits');\n      return { success: true, permitId: draftId, isUpdate: true };\n    } else {\n      // Crear un nuevo borrador\n      const payloadWithTimestamp = { ...permitPayload, createdAt: FieldValue.serverTimestamp() };\n      const docRef = await adminDb.collection('permits').add(payloadWithTimestamp as any);\n      revalidatePath('/permits');\n      return { success: true, permitId: docRef.id, isUpdate: false };\n    }\n  } catch (error: any) {\n    console.error(\"‚ùå [Action] Error al guardar borrador:\", error);\n    return { \n      success: false, \n      error: error.message || 'Could not save draft. Please try again.' \n    };\n  }\n}\n\nexport async function addSignatureAndNotify(\n  permitId: string, \n  role: 'solicitante' | 'autorizante' | 'mantenimiento' | 'lider_sst' | 'coordinador_alturas' | 'cierre_autoridad' | 'cierre_responsable' | 'cancelacion', \n  signatureType: 'firmaApertura' | 'firmaCierre',\n  signatureDataUrl: string,\n  user: { uid: string, displayName: string | null, role?: UserRole, empresa?: string },\n  comments?: string\n) {\n    if (!permitId || !role || !user || !user.uid || !user.role) {\n        return { success: false, error: 'Par√°metros inv√°lidos para guardar la firma.' };\n    }\n    if (!isAdminReady()) {\n      return { success: false, error: 'Credenciales de administrador de Firebase no configuradas en el servidor.' };\n    }\n\n    try {\n        const docRef = adminDb.collection('permits').doc(permitId);\n        const permitDocBefore = await docRef.get();\n        if (!permitDocBefore.exists) {\n            return { success: false, error: 'El permiso no existe.' };\n        }\n        const permitBeforeData = permitDocBefore.data() as Permit;\n\n        const updateData: UpdateData<Permit> = {};\n\n        // L√≥gica para manejar firmas de cierre y cancelaci√≥n\n        if (role.startsWith('cierre_') || role === 'cancelacion') {\n            const closureRole = role === 'cierre_autoridad' ? 'autoridad' : (role === 'cierre_responsable' ? 'responsable' : 'canceladoPor');\n            const closurePath = `closure.${closureRole}`;\n            \n            const existingClosureData = (permitBeforeData.closure as any)?.[closureRole] || {};\n\n            updateData[closurePath as keyof UpdateData<Permit>] = {\n                ...existingClosureData,\n                firma: signatureDataUrl,\n                nombre: user.displayName,\n                fecha: FieldValue.serverTimestamp() \n            };\n            \n            if (role === 'cancelacion') {\n                updateData['closure.razonCancelacion'] = comments || 'No especificado';\n                updateData['closure.cancelado'] = 'si';\n            }\n\n        } else {\n            // ‚úÖ VALIDACI√ìN DE PERMISOS ANTES DE FIRMAR\n            const canSign = await validateSignaturePermission(permitId, role, user);\n            if (!canSign.allowed) {\n                return { success: false, error: canSign.reason };\n            }\n\n            const approvalData: Partial<Approval> = {\n                status: 'aprobado',\n                firmaApertura: signatureDataUrl,\n                userName: user.displayName,\n                userId: user.uid,\n                signedAt: FieldValue.serverTimestamp() as any,\n                userRole: user.role,\n                userEmpresa: user.empresa || 'N/A',\n                comments: comments || '',\n            }\n            \n            updateData[`approvals.${role}`] = approvalData;\n            \n            // ‚úÖ L√ìGICA DE FIRMAS SEG√öN EL ROL\n            if (signatureType === 'firmaApertura') {\n                const validationPayload: ValidacionDiaria = { \n                    dia: 1, \n                    nombre: user.displayName || '', \n                    firma: signatureDataUrl, \n                    fecha: new Date().toISOString() \n                };\n                \n                // ‚úÖ SOLICITANTE FIRMA: Cambia de Borrador a Pendiente de Revisi√≥n\n                if (role === 'solicitante') {\n                    if (permitBeforeData.status === 'borrador') {\n                        const permitNumber = `PT-${Date.now()}-${permitId.substring(0, 6).toUpperCase()}`;\n                        updateData['number'] = permitNumber;\n                        updateData['status'] = 'pendiente_revision';\n                    }\n                    \n                    // Validaci√≥n diaria inicial del responsable\n                    ['anexoAltura', 'anexoConfinado', 'anexoIzaje', 'anexoExcavaciones'].forEach(anexo => {\n                        if ((permitBeforeData as any)?.[anexo]) {\n                            const currentValidations = (permitBeforeData as any)[anexo].validacion?.responsable || [];\n                            if (!currentValidations[0]?.firma) {\n                                currentValidations[0] = validationPayload;\n                                updateData[`${anexo}.validacion.responsable`] = currentValidations;\n                            }\n                        }\n                    });\n\n                // ‚úÖ AUTORIZANTE FIRMA: Agrega validaci√≥n diaria de autoridad\n                } else if (role === 'autorizante') {\n                    ['anexoAltura', 'anexoConfinado', 'anexoIzaje', 'anexoExcavaciones'].forEach(anexo => {\n                        if ((permitBeforeData as any)?.[anexo]) {\n                           const currentValidations = (permitBeforeData as any)[anexo].validacion?.autoridad || [];\n                            if (!currentValidations[0]?.firma) {\n                                currentValidations[0] = validationPayload;\n                                updateData[`${anexo}.validacion.autoridad`] = currentValidations;\n                            }\n                        }\n                    });\n                }\n            }\n\n            // ‚úÖ VERIFICACI√ìN AUTOM√ÅTICA: ¬øTodas las firmas requeridas est√°n completas?\n            const updatedPermitData = { \n                ...permitBeforeData, \n                approvals: { ...permitBeforeData.approvals, [role]: approvalData }\n            };\n            \n            if (await checkAllRequiredSignaturesComplete(updatedPermitData)) {\n                // üöÄ CAMBIO AUTOM√ÅTICO DE PENDIENTE_REVISION ‚Üí EN_EJECUCION\n                if (permitBeforeData.status === 'pendiente_revision') {\n                    updateData['status'] = 'en_ejecucion';\n                }\n            }\n        }\n        \n        await docRef.update(updateData);\n        \n        const permitDoc = await docRef.get();\n        const updatedPermitData = { id: permitDoc.id, ...permitDoc.data() } as Permit;\n        \n        const signatureRoleName = (signatureRoles as any)[role] || role.replace('_', ' ').replace(/\\b\\w/g, l => l.toUpperCase());\n        \n        const message = `${user.displayName || 'Un usuario'} ha firmado el permiso #${updatedPermitData.number} como ${signatureRoleName}.`;\n        const involvedUsers = await getInvolvedUsers(updatedPermitData);\n        \n        for (const uid of involvedUsers) {\n          if (uid !== user.uid) {\n            await createNotification(uid, updatedPermitData, message, 'signature', user);\n          }\n        }\n        \n        // ‚úÖ NOTIFICACI√ìN ESPECIAL SI EL PERMISO PAS√ì AUTOM√ÅTICAMENTE A EN_EJECUCION\n        if (updateData['status'] === 'en_ejecucion') {\n            const executionMessage = `El permiso #${updatedPermitData.number} ha completado todas las aprobaciones requeridas y ahora est√° EN EJECUCI√ìN.`;\n            for (const uid of involvedUsers) {\n                 await createNotification(uid, updatedPermitData, executionMessage, 'approval', user);\n            }\n            \n            // Notificaci√≥n WhatsApp\n            const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'https://sgpt-movil.web.app';\n            const permitUrl = `${baseUrl}/permits/${permitId}`;\n            const whatsappMsg = `*¬°PERMISO EN EJECUCI√ìN!* ‚úÖ\n\nüìÑ *N√∫mero:* ${updatedPermitData.number}\nüìç *√Årea:* ${permitBeforeData.generalInfo?.areaEspecifica || 'N/A'}\nüõ†Ô∏è *Tipo:* ${getWorkTypesString(permitBeforeData)}\n\n‚úÖ Todas las firmas requeridas han sido completadas.\nEl permiso est√° ahora EN EJECUCI√ìN.\n\nVer detalles: ${permitUrl}`;\n            \n            await sendWhatsAppNotification(whatsappMsg);\n        }\n\n        revalidatePath(`/permits/${permitId}`);\n        return { success: true };\n\n    } catch (error: any) {\n        console.error(\"‚ùå Error al guardar firma y notificar:\", error);\n        return {\n            success: false,\n            error: error.message || 'No se pudo guardar la firma.'\n        };\n    }\n}\n\n// ‚úÖ FUNCI√ìN CORREGIDA: Verificar si todas las firmas requeridas est√°n completas\nasync function checkAllRequiredSignaturesComplete(\n  permitData: Permit\n): Promise<boolean> {\n    const { approvals } = permitData;\n    \n    // Firma del solicitante es SIEMPRE requerida\n    if (approvals?.solicitante?.status !== 'aprobado') {\n        return false;\n    }\n    \n    // Firma del autorizante es SIEMPRE requerida\n    if (approvals?.autorizante?.status !== 'aprobado') {\n        return false;\n    }\n    \n    // Si hay trabajos en alturas, requiere firma del coordinador\n    if (permitData.trabajoAlturas || permitData.selectedWorkTypes?.alturas) {\n        if (approvals?.coordinador_alturas?.status !== 'aprobado') {\n            return false;\n        }\n    }\n    \n    // Si hay control de energ√≠a, requiere firma de mantenimiento\n    if (permitData.controlEnergia) {\n        if (approvals?.mantenimiento?.status !== 'aprobado') {\n            return false;\n        }\n    }\n    \n    // Si SST es requerido, validar su firma\n    if (permitData.isSSTSignatureRequired) {\n        if (approvals?.lider_sst?.status !== 'aprobado') {\n            return false;\n        }\n    }\n    \n    return true;\n}\n\n// ‚úÖ FUNCI√ìN MEJORADA: Validaci√≥n de transiciones de estado\nfunction validateStateTransition(currentStatus: PermitStatus, targetStatus: PermitStatus, userRole: UserRole): { allowed: boolean, reason?: string } {\n    const allowedTransitions: Partial<Record<PermitStatus, Partial<Record<PermitStatus, UserRole[]>>>> = {\n        'borrador': {\n            'pendiente_revision': ['solicitante', 'lider_tarea', 'admin']\n        },\n        'pendiente_revision': {\n            'en_ejecucion': ['autorizante', 'admin'],\n            'rechazado': ['autorizante', 'lider_sst', 'admin']\n        },\n        'en_ejecucion': {\n            'suspendido': ['lider_sst', 'admin'],\n            'cerrado': ['lider_tarea', 'autorizante', 'admin']\n        },\n        'suspendido': {\n            'en_ejecucion': ['lider_sst', 'admin'],\n            'cerrado': ['lider_tarea', 'autorizante', 'admin']\n        },\n        // Mantener compatibilidad con permisos antiguos que tengan estado \"aprobado\"\n        'aprobado': {\n            'en_ejecucion': ['lider_tarea', 'admin'],\n            'rechazado': ['autorizante', 'lider_sst', 'admin']\n        }\n    };\n    \n    const allowedRoles = allowedTransitions[currentStatus]?.[targetStatus];\n    if (!allowedRoles) {\n        return { allowed: false, reason: `Transici√≥n de '${currentStatus}' a '${targetStatus}' no est√° permitida.` };\n    }\n\n    if (!allowedRoles.includes(userRole) && userRole !== 'admin') {\n        return { allowed: false, reason: `Tu rol (${userRole}) no tiene permisos para cambiar el estado a '${targetStatus}'.` };\n    }\n\n    return { allowed: true };\n}\n\nexport async function updatePermitStatus(\n  permitId: string,\n  status: PermitStatus,\n  currentUser: { uid: string, displayName: string | null, role?: UserRole },\n  reason?: string\n) {\n    if (!permitId || !currentUser.uid || !currentUser.role) {\n        return { success: false, error: 'Par√°metros inv√°lidos o usuario sin rol.' };\n    }\n    if (!isAdminReady()) {\n      return { success: false, error: 'Credenciales de administrador de Firebase no configuradas.' };\n    }\n\n    try {\n        const docRef = adminDb.collection('permits').doc(permitId);\n        const permitSnap = await docRef.get();\n        if (!permitSnap.exists) {\n            return { success: false, error: 'El permiso no existe.' };\n        }\n        const permitData = permitSnap.data() as Permit;\n        \n        // ‚úÖ Validar transici√≥n de estado\n        const transition = validateStateTransition(permitData.status, status, currentUser.role);\n        if (!transition.allowed) {\n            return { success: false, error: transition.reason };\n        }\n\n        const updateData: UpdateData<Permit> = { status };\n\n        // ‚úÖ Guardar raz√≥n de rechazo\n        if (status === 'rechazado' && reason) {\n            updateData.rejectionReason = reason;\n        }\n        \n        // ‚úÖ Marcar fecha de cierre\n        if (status === 'cerrado') {\n            updateData['closure.fechaCierre'] = FieldValue.serverTimestamp();\n            updateData['closure.terminado'] = 'si';\n        }\n\n        await docRef.update(updateData);\n        \n        const updatedPermitData = { ...permitData, ...updateData, id: permitId } as Permit;\n        const triggeredBy = currentUser;\n        \n        let notificationType: Notification['type'] = 'status_change';\n        let message = `${currentUser.displayName || 'Un usuario'} ha cambiado el estado del permiso #${permitData.number} a: ${getStatusText(status)}.`;\n\n        if (status === 'en_ejecucion') {\n            notificationType = 'approval';\n            message = `El permiso #${permitData.number} ha sido puesto EN EJECUCI√ìN manualmente.`;\n        } else if (status === 'rechazado') {\n            notificationType = 'rejection';\n            message = `${currentUser.displayName || 'Un usuario'} ha rechazado el permiso #${permitData.number}.`;\n            if (reason) message += ` Motivo: ${reason}`;\n        } else if (status === 'cerrado') {\n            notificationType = 'cancellation';\n            message = `${currentUser.displayName || 'Un usuario'} ha cerrado el permiso #${permitData.number}.`;\n        }\n        \n        const involvedUsers = await getInvolvedUsers(updatedPermitData);\n        for (const uid of involvedUsers) {\n             if (uid !== currentUser.uid) {\n                await createNotification(uid, updatedPermitData, message, notificationType, triggeredBy);\n            }\n        }\n\n        const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'https://sgpt-movil.web.app';\n        const permitUrl = `${baseUrl}/permits/${permitId}`;\n\n        let messageBody = `*Actualizaci√≥n de Estado - SGTC* üîÑ\nEl estado del permiso *${permitData.number || permitId}* ha cambiado.\n\n*Nuevo Estado:* ${getStatusText(status)}\n\nPuede ver los detalles aqu√≠:\n${permitUrl}`;\n\n        if (status === 'rechazado' && reason) {\n          messageBody += `\\n\\n*Motivo del rechazo:* ${reason}`;\n        }\n        \n        await sendWhatsAppNotification(messageBody);\n        \n        revalidatePath(`/permits/${permitId}`);\n        revalidatePath('/permits');\n        revalidatePath('/dashboard');\n\n        return { success: true };\n    } catch (error: any) {\n        console.error(\"‚ùå Error updating permit status:\", error);\n        return {\n            success: false,\n            error: error.message || 'Could not update permit status.'\n        };\n    }\n}\n\n// ‚úÖ FUNCI√ìN MEJORADA: Validaci√≥n de permisos de firma con orden jer√°rquico\nasync function validateSignaturePermission(\n    permitId: string, \n    signatureRole: string, \n    currentUser: { uid: string, role?: UserRole }\n): Promise<{ allowed: boolean, reason?: string }> {\n    const docRef = adminDb.collection('permits').doc(permitId);\n    const permitDoc = await docRef.get();\n    if (!permitDoc.exists) {\n        return { allowed: false, reason: 'Permiso no encontrado.' };\n    }\n    const permit = permitDoc.data() as Permit;\n    \n    // ‚úÖ Verificar que el permiso est√© en un estado v√°lido para firmar\n    if (!['borrador', 'pendiente_revision'].includes(permit.status)) {\n        return { allowed: false, reason: `No se puede firmar un permiso en estado '${permit.status}'.` };\n    }\n    \n    switch (signatureRole) {\n        case 'coordinador_alturas':\n            // Debe haber trabajo en alturas\n            if (!permit.trabajoAlturas && !permit.selectedWorkTypes?.alturas) {\n                return { allowed: false, reason: 'Esta firma solo aplica para trabajos en alturas.' };\n            }\n            // Solo el creador o admin puede gestionar esta firma\n            if (permit.createdBy !== currentUser.uid && currentUser.role !== 'admin') {\n                return { allowed: false, reason: 'Solo el creador del permiso puede gestionar esta firma.' };\n            }\n            break;\n            \n        case 'solicitante':\n            if (permit.createdBy !== currentUser.uid && currentUser.role !== 'admin') {\n                return { allowed: false, reason: 'Solo el creador del permiso puede firmar como solicitante.' };\n            }\n            // ‚úÖ Si hay anexo de alturas, verificar firma del coordinador primero\n            if ((permit.trabajoAlturas || permit.selectedWorkTypes?.alturas) && \n                permit.approvals?.coordinador_alturas?.status !== 'aprobado') {\n                return { allowed: false, reason: 'Se requiere primero la firma del Coordinador de Trabajos en Alturas.' };\n            }\n            break;\n            \n        case 'autorizante':\n            if (currentUser.role !== 'autorizante' && currentUser.role !== 'admin') {\n                return { allowed: false, reason: 'Rol de autorizante requerido para esta firma.' };\n            }\n            if (permit.approvals?.solicitante?.status !== 'aprobado') {\n                return { allowed: false, reason: 'Se requiere primero la firma del solicitante.' };\n            }\n            break;\n            \n        case 'lider_sst':\n            if (currentUser.role !== 'lider_sst' && currentUser.role !== 'admin') {\n                return { allowed: false, reason: 'Rol de L√≠der SST requerido para esta firma.' };\n            }\n            // ‚úÖ Solo requerido si isSSTSignatureRequired es true\n            if (!permit.isSSTSignatureRequired) {\n                return { allowed: false, reason: 'Firma de SST no es requerida para este permiso.' };\n            }\n            if (permit.approvals?.solicitante?.status !== 'aprobado') {\n                return { allowed: false, reason: 'Se requiere primero la firma del solicitante.' };\n            }\n            break;\n            \n        case 'mantenimiento':\n             if (currentUser.role !== 'mantenimiento' && currentUser.role !== 'admin') {\n                return { allowed: false, reason: 'Rol de Mantenimiento requerido para esta firma.' };\n            }\n            if (!permit.controlEnergia) {\n                return { allowed: false, reason: 'Firma de Mantenimiento solo aplica cuando hay control de energ√≠as.' };\n            }\n            if (permit.approvals?.autorizante?.status !== 'aprobado') {\n                return { allowed: false, reason: 'Se requiere primero la firma del autorizante.' };\n            }\n            break;\n    }\n    \n    return { allowed: true };\n}\n\nexport async function addDailyValidationSignature(\n  permitId: string, \n  anexoName: string, \n  validationType: 'autoridad' | 'responsable', \n  index: number, \n  data: ValidacionDiaria, \n  user: User\n) {\n  if (!permitId || !anexoName || !validationType || index < 0 || !data || !user) {\n    return { success: false, error: 'Par√°metros inv√°lidos.' };\n  }\n\n  if (!isAdminReady()) {\n    return { success: false, error: 'Credenciales de administrador de Firebase no configuradas en el servidor.' };\n  }\n\n  const docRef = adminDb.collection('permits').doc(permitId);\n  try {\n    const permitSnap = await docRef.get();\n    if (!permitSnap.exists) {\n      return { success: false, error: 'El permiso no existe.' };\n    }\n    const permitData = permitSnap.data() as Permit;\n\n    // ‚úÖ Verificar que el permiso est√© en ejecuci√≥n para validaciones diarias\n    if (!['en_ejecucion', 'suspendido'].includes(permitData.status)) {\n        return { success: false, error: 'Solo se pueden agregar validaciones diarias en permisos EN EJECUCI√ìN o SUSPENDIDOS.' };\n    }\n\n    const anexoData = (permitData as any)[anexoName];\n    if (!anexoData) {\n      return { success: false, error: `El anexo ${anexoName} no existe en el permiso.` };\n    }\n    \n    const anexoUpdate: any = { ...anexoData };\n    if (!anexoUpdate.validacion) {\n        anexoUpdate.validacion = { autoridad: [], responsable: [] };\n    }\n\n    const validationArray = (anexoUpdate.validacion[validationType] as ValidacionDiaria[]) || [];\n    \n    while (validationArray.length <= index) {\n        validationArray.push({ dia: validationArray.length + 1, nombre: '', fecha: '', firma: '' });\n    }\n\n    validationArray[index] = data;\n    \n    const updatePath = `${anexoName}.validacion.${validationType}`;\n    \n    await docRef.update({\n      [updatePath]: validationArray,\n    });\n\n    const fullPermitData = { id: docRef.id, ...permitData } as Permit;\n    const anexoDisplayName = anexoName.replace('anexo', 'Anexo ');\n    const validationRoleName = validationType === 'autoridad' ? 'Autoridad del √Årea' : 'Responsable del Trabajo';\n    const day = index + 1;\n\n    const message = `${user.displayName || 'Un usuario'} ha realizado la validaci√≥n diaria (${validationRoleName}) para el D√çA ${day} del ${anexoDisplayName} en el permiso #${fullPermitData.number}.`;\n    const involvedUsers = await getInvolvedUsers(fullPermitData);\n    for (const uid of involvedUsers) {\n      if (uid !== user.uid) {\n        await createNotification(uid, fullPermitData, message, 'status_change', { uid: user.uid, displayName: user.displayName || null });\n      }\n    }\n\n    const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'https://sgpt-movil.web.app';\n    const permitUrl = `${baseUrl}/permits/${permitId}`;\n    const whatsappMessage = `*Validaci√≥n Diaria - SGTC* ‚úçÔ∏è\nSe ha registrado una nueva firma de validaci√≥n diaria.\n\nüìÑ *Permiso:* ${fullPermitData.number || 'N/A'}\nüóìÔ∏è *D√≠a:* ${day}\nüë§ *Firmante:* ${user.displayName || 'N/A'}\n‚úÖ *Rol:* ${validationRoleName}\nüìã *Anexo:* ${anexoDisplayName}\n\nPuede ver los detalles aqu√≠:\n${permitUrl}`;\n    \n    await sendWhatsAppNotification(whatsappMessage);\n\n    revalidatePath(`/permits/${permitId}`);\n    return { success: true };\n\n  } catch (error: any) {\n    console.error(\"‚ùå Error al guardar la validaci√≥n diaria:\", error);\n    return { success: false, error: 'No se pudo guardar la firma de validaci√≥n.' };\n  }\n}\n\nexport async function addWorkerSignature(permitId: string, workerIndex: number, signatureType: 'firmaApertura' | 'firmaCierre', signatureDataUrl: string) {\n    if (!permitId || workerIndex < 0 || !signatureType || !signatureDataUrl) {\n        return { success: false, error: 'Faltan par√°metros.' };\n    }\n    if (!isAdminReady()) {\n      return { success: false, error: 'Credenciales de administrador de Firebase no configuradas en el servidor.' };\n    }\n\n    const docRef = adminDb.collection('permits').doc(permitId);\n    try {\n        const permitSnap = await docRef.get();\n        if (!permitSnap.exists) {\n            return { success: false, error: 'El permiso no existe.' };\n        }\n\n        const permitData = permitSnap.data() as Permit;\n        \n        // ‚úÖ CORRECCI√ìN: Validaci√≥n de estado corregida para firma de apertura\n        if (signatureType === 'firmaApertura' && !['pendiente_revision', 'aprobado', 'en_ejecucion'].includes(permitData.status)) {\n            return { success: false, error: 'Solo se puede firmar apertura cuando el permiso est√° pendiente, aprobado o en ejecuci√≥n.' };\n        }\n        if (signatureType === 'firmaCierre' && !['en_ejecucion', 'suspendido'].includes(permitData.status)) {\n            return { success: false, error: 'Solo se puede firmar cierre en permisos EN EJECUCI√ìN o SUSPENDIDOS.' };\n        }\n        \n        const workers = permitData.workers ? [...permitData.workers] : [];\n\n        if (workerIndex >= workers.length) {\n            return { success: false, error: '√çndice de trabajador inv√°lido.' };\n        }\n\n        const signatureField = signatureType === 'firmaApertura' ? 'firmaApertura' : 'firmaCierre';\n        const dateField = signatureType === 'firmaApertura' ? 'fechaFirmaApertura' : 'fechaFirmaCierre';\n\n        workers[workerIndex] = {\n            ...workers[workerIndex],\n            [signatureField]: signatureDataUrl,\n            [dateField]: new Date().toISOString(), \n        };\n\n        await docRef.update({ workers: workers });\n\n        revalidatePath(`/permits/${permitId}`);\n        return { success: true };\n    } catch (error: any) {\n        console.error(\"Error al guardar la firma del trabajador:\", error);\n        return { success: false, error: 'No se pudo guardar la firma.' };\n    }\n}\n"],"names":[],"mappings":";;;;;;IAoQsB,wBAAA,WAAA,GAAA,CAAA,GAAA,sNAAA,CAAA,wBAAA,EAAA,8CAAA,sNAAA,CAAA,aAAA,EAAA,KAAA,GAAA,sNAAA,CAAA,mBAAA,EAAA","debugId":null}},
    {"offset": {"line": 752, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/app/%28app%29/permits/actions.ts"],"sourcesContent":["\n'use server';\n\nimport { adminDb, isAdminReady } from '@/lib/firebase-admin';\nimport { revalidatePath } from 'next/cache';\nimport type { Permit, ExternalWorker, PermitStatus, PermitClosure, Approval, UserRole, AnexoAltura, AnexoConfinado, AnexoEnergias, AnexoExcavaciones, AnexoIzaje, AnexoATS, PermitGeneralInfo, JustificacionATS, ValidacionDiaria, User, Notification } from '@/types';\nimport { FieldValue, UpdateData, Timestamp } from 'firebase-admin/firestore';\nimport { sendWhatsAppNotification } from '@/lib/notifications';\nimport { getEmailForUser, sendPermitUpdateEmail } from '@/lib/email';\nimport { config } from 'dotenv';\nconfig();\n\n// --- Funciones Auxiliares para Notificaciones ---\n\nconst getInvolvedUsers = async (permit: Permit): Promise<string[]> => {\n  const userIds = new Set<string>();\n\n  // 1. Creador del permiso\n  if (permit.createdBy) {\n    userIds.add(permit.createdBy);\n  }\n\n  // 2. Usuarios que han firmado\n  Object.values(permit.approvals || {}).forEach(approval => {\n    if (approval && approval.userId) {\n      userIds.add(approval.userId);\n    }\n  });\n\n  // 3. Roles administrativos o de supervisi√≥n que deber√≠an ser notificados\n  const adminsQuery = await adminDb.collection('users').where('role', 'in', ['admin', 'autorizante', 'lider_sst']).get();\n  adminsQuery.forEach(doc => userIds.add(doc.id));\n\n  return Array.from(userIds);\n};\n\nconst createNotification = async (\n  userId: string,\n  permit: Permit,\n  message: string,\n  type: Notification['type'],\n  triggeredBy: { uid: string, displayName: string | null }\n) => {\n  const notification: Omit<Notification, 'id'> = {\n    userId,\n    permitId: permit.id,\n    permitNumber: permit.number || '',\n    message,\n    type,\n    isRead: false,\n    createdAt: FieldValue.serverTimestamp() as Timestamp,\n    triggeredBy,\n  };\n  await adminDb.collection('notifications').add(notification as any);\n  \n  // Enviar correo electr√≥nico\n  const userEmail = await getEmailForUser(userId);\n  if (userEmail) {\n    await sendPermitUpdateEmail({\n      to: userEmail,\n      subject: `Actualizaci√≥n en Permiso SGTC: ${permit.number || permit.id}`,\n      html: `<p>${message}</p><p>Puedes ver los detalles del permiso haciendo clic <a href=\"${process.env.NEXT_PUBLIC_BASE_URL}/permits/${permit.id}\">aqu√≠</a>.</p>`\n    });\n  }\n};\n\n// --- Fin de Funciones de Notificaciones ---\n\nconst workTypesMap: {[key: string]: string} = {\n  'alturas': 'Trabajo en Alturas',\n  'confinado': 'Espacios Confinados',\n  'energia': 'Control de Energ√≠as',\n  'izaje': 'Izaje de Cargas',\n  'excavacion': 'Excavaciones',\n  'general': 'Trabajo General'\n};\n\nconst getWorkTypesString = (permit: Partial<Permit>): string => {\n  const selectedTypes: string[] = [];\n  if (permit.trabajoAlturas) selectedTypes.push('Trabajo en Alturas');\n  if (permit.espaciosConfinados) selectedTypes.push('Espacios Confinados');\n  if (permit.controlEnergia) selectedTypes.push('Control de Energ√≠as');\n  if (permit.izajeCargas) selectedTypes.push('Izaje de Cargas');\n  if (permit.excavaciones) selectedTypes.push('Excavaciones');\n  \n  if (selectedTypes.length === 0) {\n    if (permit.trabajoGeneral) return 'Trabajo General';\n    // Fallback for old data structure\n    if (permit.workType && Array.isArray(permit.workType)) {\n      return permit.workType.map(key => workTypesMap[key] || key).join(', ');\n    }\n    return 'Trabajo General';\n  }\n  return selectedTypes.join(', ');\n};\n\nconst getStatusText = (status: string) => {\n    const statusText: {[key: string]: string} = {\n      'borrador': 'Borrador',\n      'pendiente_revision': 'Pendiente de Revisi√≥n',\n      'aprobado': 'Aprobado',\n      'en_ejecucion': 'En Ejecuci√≥n',\n      'suspendido': 'Suspendido',\n      'cerrado': 'Cerrado',\n      'rechazado': 'Rechazado'\n    };\n    return statusText[status] || status;\n  };\n\nconst signatureRoles: { [key in 'solicitante' | 'autorizante' | 'mantenimiento' | 'lider_sst' | 'coordinador_alturas']: string } = {\n  coordinador_alturas: 'COORDINADOR DE TRABAJOS EN ALTURAS',\n  solicitante: 'QUIEN SOLICITA (L√çDER A CARGO DEL EQUIPO EJECUTANTE)',\n  autorizante: 'QUIEN AUTORIZA (JEFES Y DUE√ëOS DE AREA)',\n  mantenimiento: 'PERSONAL DE MANTENIMIENTO',\n  lider_sst: 'Firma SST',\n};\n\ntype PermitCreateData = Omit<Permit, 'id' | 'createdAt' | 'status' | 'createdBy' | 'number' | 'user' | 'approvals' | 'closure'> & {\n  userId: string;\n  userDisplayName: string | null;\n  userEmail: string | null;\n  userPhotoURL: string | null;\n};\n\nexport async function createPermit(data: PermitCreateData) {\n  if (!data.userId) {\n    return { success: false, error: 'User not authenticated' };\n  }\n   if (!isAdminReady()) {\n    return { success: false, error: 'Credenciales de administrador de Firebase no configuradas en el servidor.' };\n  }\n\n  const { userId, userDisplayName, userEmail, userPhotoURL, ...permitData } = data;\n\n  const initialApprovals = {\n    solicitante: { status: 'pendiente' as const },\n    autorizante: { status: 'pendiente' as const },\n    mantenimiento: { status: 'pendiente' as const },\n    lider_sst: { status: 'pendiente' as const },\n    coordinador_alturas: { status: 'pendiente' as const },\n  };\n\n  const permitPayload: Omit<Permit, 'id'> = {\n    ...permitData,\n    status: 'pendiente_revision' as const,\n    createdBy: userId,\n    createdAt: FieldValue.serverTimestamp() as Timestamp,\n    user: {\n      displayName: userDisplayName,\n      email: userEmail,\n      photoURL: userPhotoURL,\n    },\n    approvals: initialApprovals,\n    trabajoAlturas: data.trabajoAlturas || false,\n    isSSTSignatureRequired: data.isSSTSignatureRequired || false,\n    closure: {},\n  };\n  \n  try {\n    const docRef = await adminDb.collection('permits').add(permitPayload as any);\n    const permitNumber = `PT-${Date.now()}-${docRef.id.substring(0, 6).toUpperCase()}`;\n    await docRef.update({ number: permitNumber });\n    \n    console.log('‚úÖ [Action] Permiso creado con √©xito en Firestore:', docRef.id);\n\n    const createdPermit = { ...permitPayload, id: docRef.id, number: permitNumber } as Permit;\n    const involvedUsers = await getInvolvedUsers(createdPermit);\n    const message = `Se cre√≥ un nuevo permiso de trabajo: #${permitNumber}`;\n    \n    for (const uid of involvedUsers) {\n      if (uid !== userId) {\n        await createNotification(uid, createdPermit, message, 'creation', { uid: userId, displayName: userDisplayName });\n      }\n    }\n\n    const workTypesText = getWorkTypesString(permitPayload);\n    const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'https://sgpt-movil.web.app';\n    const permitUrl = `${baseUrl}/permits/${docRef.id}`;\n    \n    const messageBody = `*¬°Alerta de Seguridad SGPT!* üö®\nSe ha creado una nueva solicitud de permiso de trabajo.\n\nüìÑ *N√∫mero:* ${permitNumber}\nüë§ *Solicitante:* ${userDisplayName || 'N/A'}\nüõ†Ô∏è *Tipo de Trabajo:* ${workTypesText}\n\nPor favor, revise la solicitud para su aprobaci√≥n en el siguiente enlace:\n${permitUrl}`;\n    \n    await sendWhatsAppNotification(messageBody);\n    \n    revalidatePath('/permits');\n    revalidatePath('/dashboard');\n    \n    return { success: true, permitId: docRef.id, permitNumber };\n  } catch (error: any) {\n    console.error(\"‚ùå [Action] Error al crear permiso:\", error);\n    return { \n      success: false, \n      error: error.message || 'Could not create permit. Please try again.' \n    };\n  }\n}\n\nexport async function savePermitDraft(data: PermitCreateData & { draftId?: string }) {\n  if (!data.userId) {\n    return { success: false, error: 'User not authenticated' };\n  }\n  if (!isAdminReady()) {\n    return { success: false, error: 'Credenciales de administrador de Firebase no configuradas en el servidor.' };\n  }\n\n  const { userId, userDisplayName, userEmail, userPhotoURL, draftId, ...permitData } = data;\n\n  const initialApprovals = {\n    solicitante: { status: 'pendiente' as const },\n    autorizante: { status: 'pendiente' as const },\n    mantenimiento: { status: 'pendiente' as const },\n    lider_sst: { status: 'pendiente' as const },\n    coordinador_alturas: { status: 'pendiente' as const },\n  };\n\n  const permitPayload: Omit<Permit, 'id' | 'createdAt'> = {\n    ...permitData,\n    status: 'borrador' as const,\n    createdBy: userId,\n    user: {\n      displayName: userDisplayName,\n      email: userEmail,\n      photoURL: userPhotoURL,\n    },\n    approvals: initialApprovals,\n    trabajoAlturas: data.trabajoAlturas || false,\n    isSSTSignatureRequired: data.isSSTSignatureRequired || false,\n  };\n\n  try {\n    if (draftId) {\n      // Actualizar un borrador existente\n      const docRef = adminDb.collection('permits').doc(draftId);\n      await docRef.update({ ...permitPayload, updatedAt: FieldValue.serverTimestamp() });\n      revalidatePath(`/permits/${draftId}`);\n      revalidatePath('/permits');\n      return { success: true, permitId: draftId, isUpdate: true };\n    } else {\n      // Crear un nuevo borrador\n      const payloadWithTimestamp = { ...permitPayload, createdAt: FieldValue.serverTimestamp() };\n      const docRef = await adminDb.collection('permits').add(payloadWithTimestamp as any);\n      revalidatePath('/permits');\n      return { success: true, permitId: docRef.id, isUpdate: false };\n    }\n  } catch (error: any) {\n    console.error(\"‚ùå [Action] Error al guardar borrador:\", error);\n    return { \n      success: false, \n      error: error.message || 'Could not save draft. Please try again.' \n    };\n  }\n}\n\nexport async function addSignatureAndNotify(\n  permitId: string, \n  role: 'solicitante' | 'autorizante' | 'mantenimiento' | 'lider_sst' | 'coordinador_alturas' | 'cierre_autoridad' | 'cierre_responsable' | 'cancelacion', \n  signatureType: 'firmaApertura' | 'firmaCierre',\n  signatureDataUrl: string,\n  user: { uid: string, displayName: string | null, role?: UserRole, empresa?: string },\n  comments?: string\n) {\n    if (!permitId || !role || !user || !user.uid || !user.role) {\n        return { success: false, error: 'Par√°metros inv√°lidos para guardar la firma.' };\n    }\n    if (!isAdminReady()) {\n      return { success: false, error: 'Credenciales de administrador de Firebase no configuradas en el servidor.' };\n    }\n\n    try {\n        const docRef = adminDb.collection('permits').doc(permitId);\n        const permitDocBefore = await docRef.get();\n        if (!permitDocBefore.exists) {\n            return { success: false, error: 'El permiso no existe.' };\n        }\n        const permitBeforeData = permitDocBefore.data() as Permit;\n\n        const updateData: UpdateData<Permit> = {};\n\n        // L√≥gica para manejar firmas de cierre y cancelaci√≥n\n        if (role.startsWith('cierre_') || role === 'cancelacion') {\n            const closureRole = role === 'cierre_autoridad' ? 'autoridad' : (role === 'cierre_responsable' ? 'responsable' : 'canceladoPor');\n            const closurePath = `closure.${closureRole}`;\n            \n            const existingClosureData = (permitBeforeData.closure as any)?.[closureRole] || {};\n\n            updateData[closurePath as keyof UpdateData<Permit>] = {\n                ...existingClosureData,\n                firma: signatureDataUrl,\n                nombre: user.displayName,\n                fecha: FieldValue.serverTimestamp() \n            };\n            \n            if (role === 'cancelacion') {\n                updateData['closure.razonCancelacion'] = comments || 'No especificado';\n                updateData['closure.cancelado'] = 'si';\n            }\n\n        } else {\n            // ‚úÖ VALIDACI√ìN DE PERMISOS ANTES DE FIRMAR\n            const canSign = await validateSignaturePermission(permitId, role, user);\n            if (!canSign.allowed) {\n                return { success: false, error: canSign.reason };\n            }\n\n            const approvalData: Partial<Approval> = {\n                status: 'aprobado',\n                firmaApertura: signatureDataUrl,\n                userName: user.displayName,\n                userId: user.uid,\n                signedAt: FieldValue.serverTimestamp() as any,\n                userRole: user.role,\n                userEmpresa: user.empresa || 'N/A',\n                comments: comments || '',\n            }\n            \n            updateData[`approvals.${role}`] = approvalData;\n            \n            // ‚úÖ L√ìGICA DE FIRMAS SEG√öN EL ROL\n            if (signatureType === 'firmaApertura') {\n                const validationPayload: ValidacionDiaria = { \n                    dia: 1, \n                    nombre: user.displayName || '', \n                    firma: signatureDataUrl, \n                    fecha: new Date().toISOString() \n                };\n                \n                // ‚úÖ SOLICITANTE FIRMA: Cambia de Borrador a Pendiente de Revisi√≥n\n                if (role === 'solicitante') {\n                    if (permitBeforeData.status === 'borrador') {\n                        const permitNumber = `PT-${Date.now()}-${permitId.substring(0, 6).toUpperCase()}`;\n                        updateData['number'] = permitNumber;\n                        updateData['status'] = 'pendiente_revision';\n                    }\n                    \n                    // Validaci√≥n diaria inicial del responsable\n                    ['anexoAltura', 'anexoConfinado', 'anexoIzaje', 'anexoExcavaciones'].forEach(anexo => {\n                        if ((permitBeforeData as any)?.[anexo]) {\n                            const currentValidations = (permitBeforeData as any)[anexo].validacion?.responsable || [];\n                            if (!currentValidations[0]?.firma) {\n                                currentValidations[0] = validationPayload;\n                                updateData[`${anexo}.validacion.responsable`] = currentValidations;\n                            }\n                        }\n                    });\n\n                // ‚úÖ AUTORIZANTE FIRMA: Agrega validaci√≥n diaria de autoridad\n                } else if (role === 'autorizante') {\n                    ['anexoAltura', 'anexoConfinado', 'anexoIzaje', 'anexoExcavaciones'].forEach(anexo => {\n                        if ((permitBeforeData as any)?.[anexo]) {\n                           const currentValidations = (permitBeforeData as any)[anexo].validacion?.autoridad || [];\n                            if (!currentValidations[0]?.firma) {\n                                currentValidations[0] = validationPayload;\n                                updateData[`${anexo}.validacion.autoridad`] = currentValidations;\n                            }\n                        }\n                    });\n                }\n            }\n\n            // ‚úÖ VERIFICACI√ìN AUTOM√ÅTICA: ¬øTodas las firmas requeridas est√°n completas?\n            const updatedPermitData = { \n                ...permitBeforeData, \n                approvals: { ...permitBeforeData.approvals, [role]: approvalData }\n            };\n            \n            if (await checkAllRequiredSignaturesComplete(updatedPermitData)) {\n                // üöÄ CAMBIO AUTOM√ÅTICO DE PENDIENTE_REVISION ‚Üí EN_EJECUCION\n                if (permitBeforeData.status === 'pendiente_revision') {\n                    updateData['status'] = 'en_ejecucion';\n                }\n            }\n        }\n        \n        await docRef.update(updateData);\n        \n        const permitDoc = await docRef.get();\n        const updatedPermitData = { id: permitDoc.id, ...permitDoc.data() } as Permit;\n        \n        const signatureRoleName = (signatureRoles as any)[role] || role.replace('_', ' ').replace(/\\b\\w/g, l => l.toUpperCase());\n        \n        const message = `${user.displayName || 'Un usuario'} ha firmado el permiso #${updatedPermitData.number} como ${signatureRoleName}.`;\n        const involvedUsers = await getInvolvedUsers(updatedPermitData);\n        \n        for (const uid of involvedUsers) {\n          if (uid !== user.uid) {\n            await createNotification(uid, updatedPermitData, message, 'signature', user);\n          }\n        }\n        \n        // ‚úÖ NOTIFICACI√ìN ESPECIAL SI EL PERMISO PAS√ì AUTOM√ÅTICAMENTE A EN_EJECUCION\n        if (updateData['status'] === 'en_ejecucion') {\n            const executionMessage = `El permiso #${updatedPermitData.number} ha completado todas las aprobaciones requeridas y ahora est√° EN EJECUCI√ìN.`;\n            for (const uid of involvedUsers) {\n                 await createNotification(uid, updatedPermitData, executionMessage, 'approval', user);\n            }\n            \n            // Notificaci√≥n WhatsApp\n            const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'https://sgpt-movil.web.app';\n            const permitUrl = `${baseUrl}/permits/${permitId}`;\n            const whatsappMsg = `*¬°PERMISO EN EJECUCI√ìN!* ‚úÖ\n\nüìÑ *N√∫mero:* ${updatedPermitData.number}\nüìç *√Årea:* ${permitBeforeData.generalInfo?.areaEspecifica || 'N/A'}\nüõ†Ô∏è *Tipo:* ${getWorkTypesString(permitBeforeData)}\n\n‚úÖ Todas las firmas requeridas han sido completadas.\nEl permiso est√° ahora EN EJECUCI√ìN.\n\nVer detalles: ${permitUrl}`;\n            \n            await sendWhatsAppNotification(whatsappMsg);\n        }\n\n        revalidatePath(`/permits/${permitId}`);\n        return { success: true };\n\n    } catch (error: any) {\n        console.error(\"‚ùå Error al guardar firma y notificar:\", error);\n        return {\n            success: false,\n            error: error.message || 'No se pudo guardar la firma.'\n        };\n    }\n}\n\n// ‚úÖ FUNCI√ìN CORREGIDA: Verificar si todas las firmas requeridas est√°n completas\nasync function checkAllRequiredSignaturesComplete(\n  permitData: Permit\n): Promise<boolean> {\n    const { approvals } = permitData;\n    \n    // Firma del solicitante es SIEMPRE requerida\n    if (approvals?.solicitante?.status !== 'aprobado') {\n        return false;\n    }\n    \n    // Firma del autorizante es SIEMPRE requerida\n    if (approvals?.autorizante?.status !== 'aprobado') {\n        return false;\n    }\n    \n    // Si hay trabajos en alturas, requiere firma del coordinador\n    if (permitData.trabajoAlturas || permitData.selectedWorkTypes?.alturas) {\n        if (approvals?.coordinador_alturas?.status !== 'aprobado') {\n            return false;\n        }\n    }\n    \n    // Si hay control de energ√≠a, requiere firma de mantenimiento\n    if (permitData.controlEnergia) {\n        if (approvals?.mantenimiento?.status !== 'aprobado') {\n            return false;\n        }\n    }\n    \n    // Si SST es requerido, validar su firma\n    if (permitData.isSSTSignatureRequired) {\n        if (approvals?.lider_sst?.status !== 'aprobado') {\n            return false;\n        }\n    }\n    \n    return true;\n}\n\n// ‚úÖ FUNCI√ìN MEJORADA: Validaci√≥n de transiciones de estado\nfunction validateStateTransition(currentStatus: PermitStatus, targetStatus: PermitStatus, userRole: UserRole): { allowed: boolean, reason?: string } {\n    const allowedTransitions: Partial<Record<PermitStatus, Partial<Record<PermitStatus, UserRole[]>>>> = {\n        'borrador': {\n            'pendiente_revision': ['solicitante', 'lider_tarea', 'admin']\n        },\n        'pendiente_revision': {\n            'en_ejecucion': ['autorizante', 'admin'],\n            'rechazado': ['autorizante', 'lider_sst', 'admin']\n        },\n        'en_ejecucion': {\n            'suspendido': ['lider_sst', 'admin'],\n            'cerrado': ['lider_tarea', 'autorizante', 'admin']\n        },\n        'suspendido': {\n            'en_ejecucion': ['lider_sst', 'admin'],\n            'cerrado': ['lider_tarea', 'autorizante', 'admin']\n        },\n        // Mantener compatibilidad con permisos antiguos que tengan estado \"aprobado\"\n        'aprobado': {\n            'en_ejecucion': ['lider_tarea', 'admin'],\n            'rechazado': ['autorizante', 'lider_sst', 'admin']\n        }\n    };\n    \n    const allowedRoles = allowedTransitions[currentStatus]?.[targetStatus];\n    if (!allowedRoles) {\n        return { allowed: false, reason: `Transici√≥n de '${currentStatus}' a '${targetStatus}' no est√° permitida.` };\n    }\n\n    if (!allowedRoles.includes(userRole) && userRole !== 'admin') {\n        return { allowed: false, reason: `Tu rol (${userRole}) no tiene permisos para cambiar el estado a '${targetStatus}'.` };\n    }\n\n    return { allowed: true };\n}\n\nexport async function updatePermitStatus(\n  permitId: string,\n  status: PermitStatus,\n  currentUser: { uid: string, displayName: string | null, role?: UserRole },\n  reason?: string\n) {\n    if (!permitId || !currentUser.uid || !currentUser.role) {\n        return { success: false, error: 'Par√°metros inv√°lidos o usuario sin rol.' };\n    }\n    if (!isAdminReady()) {\n      return { success: false, error: 'Credenciales de administrador de Firebase no configuradas.' };\n    }\n\n    try {\n        const docRef = adminDb.collection('permits').doc(permitId);\n        const permitSnap = await docRef.get();\n        if (!permitSnap.exists) {\n            return { success: false, error: 'El permiso no existe.' };\n        }\n        const permitData = permitSnap.data() as Permit;\n        \n        // ‚úÖ Validar transici√≥n de estado\n        const transition = validateStateTransition(permitData.status, status, currentUser.role);\n        if (!transition.allowed) {\n            return { success: false, error: transition.reason };\n        }\n\n        const updateData: UpdateData<Permit> = { status };\n\n        // ‚úÖ Guardar raz√≥n de rechazo\n        if (status === 'rechazado' && reason) {\n            updateData.rejectionReason = reason;\n        }\n        \n        // ‚úÖ Marcar fecha de cierre\n        if (status === 'cerrado') {\n            updateData['closure.fechaCierre'] = FieldValue.serverTimestamp();\n            updateData['closure.terminado'] = 'si';\n        }\n\n        await docRef.update(updateData);\n        \n        const updatedPermitData = { ...permitData, ...updateData, id: permitId } as Permit;\n        const triggeredBy = currentUser;\n        \n        let notificationType: Notification['type'] = 'status_change';\n        let message = `${currentUser.displayName || 'Un usuario'} ha cambiado el estado del permiso #${permitData.number} a: ${getStatusText(status)}.`;\n\n        if (status === 'en_ejecucion') {\n            notificationType = 'approval';\n            message = `El permiso #${permitData.number} ha sido puesto EN EJECUCI√ìN manualmente.`;\n        } else if (status === 'rechazado') {\n            notificationType = 'rejection';\n            message = `${currentUser.displayName || 'Un usuario'} ha rechazado el permiso #${permitData.number}.`;\n            if (reason) message += ` Motivo: ${reason}`;\n        } else if (status === 'cerrado') {\n            notificationType = 'cancellation';\n            message = `${currentUser.displayName || 'Un usuario'} ha cerrado el permiso #${permitData.number}.`;\n        }\n        \n        const involvedUsers = await getInvolvedUsers(updatedPermitData);\n        for (const uid of involvedUsers) {\n             if (uid !== currentUser.uid) {\n                await createNotification(uid, updatedPermitData, message, notificationType, triggeredBy);\n            }\n        }\n\n        const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'https://sgpt-movil.web.app';\n        const permitUrl = `${baseUrl}/permits/${permitId}`;\n\n        let messageBody = `*Actualizaci√≥n de Estado - SGTC* üîÑ\nEl estado del permiso *${permitData.number || permitId}* ha cambiado.\n\n*Nuevo Estado:* ${getStatusText(status)}\n\nPuede ver los detalles aqu√≠:\n${permitUrl}`;\n\n        if (status === 'rechazado' && reason) {\n          messageBody += `\\n\\n*Motivo del rechazo:* ${reason}`;\n        }\n        \n        await sendWhatsAppNotification(messageBody);\n        \n        revalidatePath(`/permits/${permitId}`);\n        revalidatePath('/permits');\n        revalidatePath('/dashboard');\n\n        return { success: true };\n    } catch (error: any) {\n        console.error(\"‚ùå Error updating permit status:\", error);\n        return {\n            success: false,\n            error: error.message || 'Could not update permit status.'\n        };\n    }\n}\n\n// ‚úÖ FUNCI√ìN MEJORADA: Validaci√≥n de permisos de firma con orden jer√°rquico\nasync function validateSignaturePermission(\n    permitId: string, \n    signatureRole: string, \n    currentUser: { uid: string, role?: UserRole }\n): Promise<{ allowed: boolean, reason?: string }> {\n    const docRef = adminDb.collection('permits').doc(permitId);\n    const permitDoc = await docRef.get();\n    if (!permitDoc.exists) {\n        return { allowed: false, reason: 'Permiso no encontrado.' };\n    }\n    const permit = permitDoc.data() as Permit;\n    \n    // ‚úÖ Verificar que el permiso est√© en un estado v√°lido para firmar\n    if (!['borrador', 'pendiente_revision'].includes(permit.status)) {\n        return { allowed: false, reason: `No se puede firmar un permiso en estado '${permit.status}'.` };\n    }\n    \n    switch (signatureRole) {\n        case 'coordinador_alturas':\n            // Debe haber trabajo en alturas\n            if (!permit.trabajoAlturas && !permit.selectedWorkTypes?.alturas) {\n                return { allowed: false, reason: 'Esta firma solo aplica para trabajos en alturas.' };\n            }\n            // Solo el creador o admin puede gestionar esta firma\n            if (permit.createdBy !== currentUser.uid && currentUser.role !== 'admin') {\n                return { allowed: false, reason: 'Solo el creador del permiso puede gestionar esta firma.' };\n            }\n            break;\n            \n        case 'solicitante':\n            if (permit.createdBy !== currentUser.uid && currentUser.role !== 'admin') {\n                return { allowed: false, reason: 'Solo el creador del permiso puede firmar como solicitante.' };\n            }\n            // ‚úÖ Si hay anexo de alturas, verificar firma del coordinador primero\n            if ((permit.trabajoAlturas || permit.selectedWorkTypes?.alturas) && \n                permit.approvals?.coordinador_alturas?.status !== 'aprobado') {\n                return { allowed: false, reason: 'Se requiere primero la firma del Coordinador de Trabajos en Alturas.' };\n            }\n            break;\n            \n        case 'autorizante':\n            if (currentUser.role !== 'autorizante' && currentUser.role !== 'admin') {\n                return { allowed: false, reason: 'Rol de autorizante requerido para esta firma.' };\n            }\n            if (permit.approvals?.solicitante?.status !== 'aprobado') {\n                return { allowed: false, reason: 'Se requiere primero la firma del solicitante.' };\n            }\n            break;\n            \n        case 'lider_sst':\n            if (currentUser.role !== 'lider_sst' && currentUser.role !== 'admin') {\n                return { allowed: false, reason: 'Rol de L√≠der SST requerido para esta firma.' };\n            }\n            // ‚úÖ Solo requerido si isSSTSignatureRequired es true\n            if (!permit.isSSTSignatureRequired) {\n                return { allowed: false, reason: 'Firma de SST no es requerida para este permiso.' };\n            }\n            if (permit.approvals?.solicitante?.status !== 'aprobado') {\n                return { allowed: false, reason: 'Se requiere primero la firma del solicitante.' };\n            }\n            break;\n            \n        case 'mantenimiento':\n             if (currentUser.role !== 'mantenimiento' && currentUser.role !== 'admin') {\n                return { allowed: false, reason: 'Rol de Mantenimiento requerido para esta firma.' };\n            }\n            if (!permit.controlEnergia) {\n                return { allowed: false, reason: 'Firma de Mantenimiento solo aplica cuando hay control de energ√≠as.' };\n            }\n            if (permit.approvals?.autorizante?.status !== 'aprobado') {\n                return { allowed: false, reason: 'Se requiere primero la firma del autorizante.' };\n            }\n            break;\n    }\n    \n    return { allowed: true };\n}\n\nexport async function addDailyValidationSignature(\n  permitId: string, \n  anexoName: string, \n  validationType: 'autoridad' | 'responsable', \n  index: number, \n  data: ValidacionDiaria, \n  user: User\n) {\n  if (!permitId || !anexoName || !validationType || index < 0 || !data || !user) {\n    return { success: false, error: 'Par√°metros inv√°lidos.' };\n  }\n\n  if (!isAdminReady()) {\n    return { success: false, error: 'Credenciales de administrador de Firebase no configuradas en el servidor.' };\n  }\n\n  const docRef = adminDb.collection('permits').doc(permitId);\n  try {\n    const permitSnap = await docRef.get();\n    if (!permitSnap.exists) {\n      return { success: false, error: 'El permiso no existe.' };\n    }\n    const permitData = permitSnap.data() as Permit;\n\n    // ‚úÖ Verificar que el permiso est√© en ejecuci√≥n para validaciones diarias\n    if (!['en_ejecucion', 'suspendido'].includes(permitData.status)) {\n        return { success: false, error: 'Solo se pueden agregar validaciones diarias en permisos EN EJECUCI√ìN o SUSPENDIDOS.' };\n    }\n\n    const anexoData = (permitData as any)[anexoName];\n    if (!anexoData) {\n      return { success: false, error: `El anexo ${anexoName} no existe en el permiso.` };\n    }\n    \n    const anexoUpdate: any = { ...anexoData };\n    if (!anexoUpdate.validacion) {\n        anexoUpdate.validacion = { autoridad: [], responsable: [] };\n    }\n\n    const validationArray = (anexoUpdate.validacion[validationType] as ValidacionDiaria[]) || [];\n    \n    while (validationArray.length <= index) {\n        validationArray.push({ dia: validationArray.length + 1, nombre: '', fecha: '', firma: '' });\n    }\n\n    validationArray[index] = data;\n    \n    const updatePath = `${anexoName}.validacion.${validationType}`;\n    \n    await docRef.update({\n      [updatePath]: validationArray,\n    });\n\n    const fullPermitData = { id: docRef.id, ...permitData } as Permit;\n    const anexoDisplayName = anexoName.replace('anexo', 'Anexo ');\n    const validationRoleName = validationType === 'autoridad' ? 'Autoridad del √Årea' : 'Responsable del Trabajo';\n    const day = index + 1;\n\n    const message = `${user.displayName || 'Un usuario'} ha realizado la validaci√≥n diaria (${validationRoleName}) para el D√çA ${day} del ${anexoDisplayName} en el permiso #${fullPermitData.number}.`;\n    const involvedUsers = await getInvolvedUsers(fullPermitData);\n    for (const uid of involvedUsers) {\n      if (uid !== user.uid) {\n        await createNotification(uid, fullPermitData, message, 'status_change', { uid: user.uid, displayName: user.displayName || null });\n      }\n    }\n\n    const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'https://sgpt-movil.web.app';\n    const permitUrl = `${baseUrl}/permits/${permitId}`;\n    const whatsappMessage = `*Validaci√≥n Diaria - SGTC* ‚úçÔ∏è\nSe ha registrado una nueva firma de validaci√≥n diaria.\n\nüìÑ *Permiso:* ${fullPermitData.number || 'N/A'}\nüóìÔ∏è *D√≠a:* ${day}\nüë§ *Firmante:* ${user.displayName || 'N/A'}\n‚úÖ *Rol:* ${validationRoleName}\nüìã *Anexo:* ${anexoDisplayName}\n\nPuede ver los detalles aqu√≠:\n${permitUrl}`;\n    \n    await sendWhatsAppNotification(whatsappMessage);\n\n    revalidatePath(`/permits/${permitId}`);\n    return { success: true };\n\n  } catch (error: any) {\n    console.error(\"‚ùå Error al guardar la validaci√≥n diaria:\", error);\n    return { success: false, error: 'No se pudo guardar la firma de validaci√≥n.' };\n  }\n}\n\nexport async function addWorkerSignature(permitId: string, workerIndex: number, signatureType: 'firmaApertura' | 'firmaCierre', signatureDataUrl: string) {\n    if (!permitId || workerIndex < 0 || !signatureType || !signatureDataUrl) {\n        return { success: false, error: 'Faltan par√°metros.' };\n    }\n    if (!isAdminReady()) {\n      return { success: false, error: 'Credenciales de administrador de Firebase no configuradas en el servidor.' };\n    }\n\n    const docRef = adminDb.collection('permits').doc(permitId);\n    try {\n        const permitSnap = await docRef.get();\n        if (!permitSnap.exists) {\n            return { success: false, error: 'El permiso no existe.' };\n        }\n\n        const permitData = permitSnap.data() as Permit;\n        \n        // ‚úÖ CORRECCI√ìN: Validaci√≥n de estado corregida para firma de apertura\n        if (signatureType === 'firmaApertura' && !['pendiente_revision', 'aprobado', 'en_ejecucion'].includes(permitData.status)) {\n            return { success: false, error: 'Solo se puede firmar apertura cuando el permiso est√° pendiente, aprobado o en ejecuci√≥n.' };\n        }\n        if (signatureType === 'firmaCierre' && !['en_ejecucion', 'suspendido'].includes(permitData.status)) {\n            return { success: false, error: 'Solo se puede firmar cierre en permisos EN EJECUCI√ìN o SUSPENDIDOS.' };\n        }\n        \n        const workers = permitData.workers ? [...permitData.workers] : [];\n\n        if (workerIndex >= workers.length) {\n            return { success: false, error: '√çndice de trabajador inv√°lido.' };\n        }\n\n        const signatureField = signatureType === 'firmaApertura' ? 'firmaApertura' : 'firmaCierre';\n        const dateField = signatureType === 'firmaApertura' ? 'fechaFirmaApertura' : 'fechaFirmaCierre';\n\n        workers[workerIndex] = {\n            ...workers[workerIndex],\n            [signatureField]: signatureDataUrl,\n            [dateField]: new Date().toISOString(), \n        };\n\n        await docRef.update({ workers: workers });\n\n        revalidatePath(`/permits/${permitId}`);\n        return { success: true };\n    } catch (error: any) {\n        console.error(\"Error al guardar la firma del trabajador:\", error);\n        return { success: false, error: 'No se pudo guardar la firma.' };\n    }\n}\n"],"names":[],"mappings":";;;;;;IA8qBsB,8BAAA,WAAA,GAAA,CAAA,GAAA,sNAAA,CAAA,wBAAA,EAAA,8CAAA,sNAAA,CAAA,aAAA,EAAA,KAAA,GAAA,sNAAA,CAAA,mBAAA,EAAA","debugId":null}},
    {"offset": {"line": 765, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/components/ui/textarea.tsx"],"sourcesContent":["import * as React from 'react';\n\nimport {cn} from '@/lib/utils';\n\nconst Textarea = React.forwardRef<HTMLTextAreaElement, React.ComponentProps<'textarea'>>(\n  ({className, ...props}, ref) => {\n    return (\n      <textarea\n        className={cn(\n          'flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm',\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    );\n  }\n);\nTextarea.displayName = 'Textarea';\n\nexport {Textarea};\n"],"names":[],"mappings":";;;;AAAA;AAEA;;;;AAEA,MAAM,yBAAW,CAAA,GAAA,qMAAA,CAAA,aAAgB,AAAD,EAC9B,CAAC,EAAC,SAAS,EAAE,GAAG,OAAM,EAAE;IACtB,qBACE,8OAAC;QACC,WAAW,CAAA,GAAA,mHAAA,CAAA,KAAE,AAAD,EACV,qTACA;QAEF,KAAK;QACJ,GAAG,KAAK;;;;;;AAGf;AAEF,SAAS,WAAW,GAAG","debugId":null}},
    {"offset": {"line": 793, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/components/ui/radio-group.tsx"],"sourcesContent":["\"use client\"\n\nimport * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n"],"names":[],"mappings":";;;;;AAEA;AACA;AACA;AAEA;AANA;;;;;;AAQA,MAAM,2BAAa,CAAA,GAAA,qMAAA,CAAA,aAAgB,AAAD,EAGhC,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE;IAC1B,qBACE,8OAAC,0KAAA,CAAA,OAAwB;QACvB,WAAW,CAAA,GAAA,mHAAA,CAAA,KAAE,AAAD,EAAE,cAAc;QAC3B,GAAG,KAAK;QACT,KAAK;;;;;;AAGX;AACA,WAAW,WAAW,GAAG,0KAAA,CAAA,OAAwB,CAAC,WAAW;AAE7D,MAAM,+BAAiB,CAAA,GAAA,qMAAA,CAAA,aAAgB,AAAD,EAGpC,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE;IAC1B,qBACE,8OAAC,0KAAA,CAAA,OAAwB;QACvB,KAAK;QACL,WAAW,CAAA,GAAA,mHAAA,CAAA,KAAE,AAAD,EACV,4OACA;QAED,GAAG,KAAK;kBAET,cAAA,8OAAC,0KAAA,CAAA,YAA6B;YAAC,WAAU;sBACvC,cAAA,8OAAC,sMAAA,CAAA,SAAM;gBAAC,WAAU;;;;;;;;;;;;;;;;AAI1B;AACA,eAAe,WAAW,GAAG,0KAAA,CAAA,OAAwB,CAAC,WAAW","debugId":null}},
    {"offset": {"line": 853, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/app/%28app%29/permits/%5Bid%5D/page.tsx"],"sourcesContent":["'use client';\n\nimport { useEffect, useState, useRef, use } from 'react';\nimport { useParams, useRouter } from 'next/navigation';\nimport { doc, onSnapshot, updateDoc } from 'firebase/firestore';\nimport { db } from '@/lib/firebase';\nimport type {\n  Permit,\n  Tool,\n  Approval,\n  ExternalWorker,\n  AnexoAltura,\n  AnexoConfinado,\n  AnexoIzaje,\n  MedicionAtmosferica,\n  AnexoEnergias,\n  PermitStatus,\n  UserRole,\n  AnexoATS,\n  PruebaGasesPeriodica,\n  AnexoExcavaciones,\n  ValidacionDiaria,\n  AutorizacionPersona,\n  User,\n} from '@/types';\nimport { useToast } from '@/hooks/use-toast';\nimport { errorEmitter } from '@/lib/error-emitter';\nimport { FirestorePermissionError, type SecurityRuleContext } from '@/lib/errors';\nimport {\n  Loader2,\n  FileText,\n  AlertTriangle,\n  ClipboardCheck,\n  Shield,\n  Users,\n  Signature as SignatureIcon,\n  ArrowLeft,\n  CheckCircle,\n  XCircle,\n  Clock,\n  UserCheck,\n  Siren,\n  FileDown,\n  Wrench,\n  Check,\n  Building,\n  ChevronDown,\n  PlayCircle,\n  PauseCircle,\n  Lock,\n  Edit,\n  HeartPulse,\n  BookUser,\n  ShieldCheck,\n  Circle,\n  MessageSquare,\n  Info,\n  FileX,\n  Calendar,\n  MapPin,\n  Briefcase,\n  Factory,\n  Package,\n  HardHat,\n  Zap,\n  Flame,\n  Mountain,\n} from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';\nimport { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';\nimport { useUser } from '@/hooks/use-user';\nimport { format, differenceInCalendarDays, parseISO, isValid } from 'date-fns';\nimport { es } from 'date-fns/locale';\nimport jsPDF from 'jspdf';\nimport autoTable from 'jspdf-autotable';\nimport { Input } from '@/components/ui/input';\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogDescription,\n  DialogClose,\n  DialogFooter,\n} from '@/components/ui/dialog';\nimport { SignaturePad } from '@/components/ui/signature-pad';\nimport Image from 'next/image';\nimport { Collapsible, CollapsibleContent, CollapsibleTrigger } from '@/components/ui/collapsible';\nimport { Checkbox } from '@/components/ui/checkbox';\nimport { updatePermitStatus, addSignatureAndNotify, addDailyValidationSignature, addWorkerSignature } from '../actions';\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n  AlertDialogTrigger,\n} from '@/components/ui/alert-dialog';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Tooltip, TooltipProvider, TooltipTrigger, TooltipContent } from '@/components/ui/tooltip';\nimport { Label } from '@/components/ui/label';\nimport { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';\nimport { Separator } from '@/components/ui/separator';\n\n// ‚úÖ Helper function to handle different date formats\nconst parseFirestoreDate = (dateValue: any): Date | null => {\n  if (!dateValue) return null;\n  if (typeof dateValue.toDate === 'function') return dateValue.toDate();\n  if (dateValue instanceof Date) return dateValue;\n  if (typeof dateValue === 'string') {\n    const parsed = new Date(dateValue);\n    if (!isNaN(parsed.getTime())) return parsed;\n  }\n  return null;\n};\n\n// ‚úÖ Helper seguro para formatear fechas\nconst safeFormat = (date: any, fmt: string): string => {\n  const parsedDate = parseFirestoreDate(date);\n  return parsedDate && isValid(parsedDate) ? format(parsedDate, fmt, { locale: es }) : 'N/A';\n};\n\nconst getStatusInfo = (status: string): { text: string; icon: React.ElementType; color: string; bgColor: string } => {\n  const statusInfo: { [key: string]: { text: string; icon: React.ElementType; color: string; bgColor: string } } = {\n    borrador: { text: 'Borrador', icon: Clock, color: 'text-gray-600', bgColor: 'bg-gray-100' },\n    pendiente_revision: { text: 'Pendiente de Revisi√≥n', icon: Clock, color: 'text-yellow-600', bgColor: 'bg-yellow-100' },\n    aprobado: { text: 'Aprobado', icon: CheckCircle, color: 'text-green-600', bgColor: 'bg-green-100' },\n    en_ejecucion: { text: 'En Ejecuci√≥n', icon: PlayCircle, color: 'text-purple-600', bgColor: 'bg-purple-100' },\n    suspendido: { text: 'Suspendido', icon: PauseCircle, color: 'text-orange-600', bgColor: 'bg-orange-100' },\n    cerrado: { text: 'Cerrado', icon: Lock, color: 'text-blue-600', bgColor: 'bg-blue-100' },\n    rechazado: { text: 'Rechazado', icon: XCircle, color: 'text-red-600', bgColor: 'bg-red-100' },\n  };\n  return statusInfo[status] || { text: status, icon: FileText, color: 'text-gray-500', bgColor: 'bg-gray-100' };\n};\n\n// Componente Section mejorado\nconst Section: React.FC<{ title: string; children: React.ReactNode; className?: string; icon?: React.ReactNode }> = ({\n  title,\n  children,\n  className,\n  icon,\n}) => (\n  <div className={className}>\n    <div className=\"flex items-center gap-2 mb-4 pb-2 border-b-2 border-primary/20\">\n      {icon && <span className=\"text-primary\">{icon}</span>}\n      <h3 className=\"text-sm font-bold uppercase text-primary\">{title}</h3>\n    </div>\n    <div className=\"text-sm space-y-3\">{children}</div>\n  </div>\n);\n\n// Componente Field mejorado\nconst Field: React.FC<{ label: string; value?: React.ReactNode; fullWidth?: boolean; icon?: React.ReactNode }> = ({\n  label,\n  value,\n  fullWidth,\n  icon,\n}) => (\n  <div className={fullWidth ? 'col-span-full' : ''}>\n    <div className=\"flex items-center gap-1.5 mb-1\">\n      {icon && <span className=\"text-primary/70 text-xs\">{icon}</span>}\n      <p className=\"text-xs font-semibold text-muted-foreground uppercase\">{label}</p>\n    </div>\n    <div className=\"font-medium text-gray-800 break-words bg-gray-50 p-2 rounded border\">\n      {value || <span className=\"text-muted-foreground italic\">No especificado</span>}\n    </div>\n  </div>\n);\n\n// ‚ú® Componente RadioCheck con √≠conos mejorado\nconst RadioCheck: React.FC<{\n  label: string;\n  value?: string | boolean;\n  spec?: string;\n  onValueChange?: (value: any) => void;\n}> = ({ label, value, spec, onValueChange }) => {\n  let status: 'si' | 'no' | 'na';\n  if (value === true || value === 'si') status = 'si';\n  else if (value === false || value === 'no') status = 'no';\n  else status = 'na';\n\n  const iconMap = {\n    si: <CheckCircle className=\"h-5 w-5 text-green-500\" />,\n    no: <XCircle className=\"h-5 w-5 text-red-500\" />,\n    na: <Circle className=\"h-5 w-5 text-gray-400\" />,\n  };\n\n  return (\n    <div className=\"flex items-center justify-between p-3 border-b hover:bg-gray-50 transition-colors\">\n      <span className=\"text-sm flex-1 pr-2\">{label}</span>\n      <div className=\"flex items-center gap-3\">\n        {spec && <span className=\"text-xs font-semibold text-blue-600 bg-blue-100 px-2 py-1 rounded\">{spec}</span>}\n        {onValueChange ? (\n          <RadioGroup value={status} onValueChange={onValueChange} className=\"flex gap-2\">\n            <RadioGroupItem value=\"si\" />\n            <Label>S√≠</Label>\n            <RadioGroupItem value=\"no\" />\n            <Label>No</Label>\n            <RadioGroupItem value=\"na\" />\n            <Label>N/A</Label>\n          </RadioGroup>\n        ) : (\n          iconMap[status]\n        )}\n      </div>\n    </div>\n  );\n};\n\ntype SignatureRole = 'solicitante' | 'autorizante' | 'mantenimiento' | 'lider_sst' | 'coordinador_alturas';\n\nconst signatureRoles: { [key in SignatureRole]: string } = {\n  coordinador_alturas: 'COORDINADOR (ANEXO)',\n  solicitante: 'QUIEN SOLICITA (L√çDER A CARGO DEL EQUIPO EJECUTANTE)',\n  mantenimiento: 'MANTENIMIENTO (SI APLICA)',\n  lider_sst: 'Firma SST',\n  autorizante: 'QUIEN AUTORIZA (JEFES Y DUE√ëOS DE AREA)',\n};\n\nconst signatureConsents: { [key in SignatureRole]?: string } = {\n  solicitante:\n    'Al firmar, confirma que la informaci√≥n del permiso, ATS y anexos es correcta. El permiso se enviar√° para autorizaci√≥n y ya no podr√° ser modificado.',\n  coordinador_alturas:\n    'Al firmar como Coordinador de Trabajos en Alturas, manifiesto que entiendo el trabajo que se va a realizar y sus peligros, se han verificado las condiciones y formulado las medidas de prevenci√≥n necesarias.',\n};\n// Continuaci√≥n del archivo...\n\nexport default function PermitDetailPage() {\n  const params = useParams();\n  const router = useRouter();\n  const { user: currentUser, loading: userLoading } = useUser();\n  const permitId = params.id as string;\n\n  const [permit, setPermit] = useState<Permit | null>(null);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const { toast } = useToast();\n\n  const [isSignatureDialogOpen, setIsSignatureDialogOpen] = useState(false);\n  const [signingRole, setSigningRole] = useState<{\n    role: SignatureRole | 'cierre_autoridad' | 'cierre_responsable' | 'cancelacion';\n    type: 'firmaApertura' | 'firmaCierre';\n  } | null>(null);\n  const [signerName, setSignerName] = useState('');\n  const [isSigning, setIsSigning] = useState(false);\n  const [signatureObservation, setSignatureObservation] = useState('');\n\n  const [isStatusChanging, setIsStatusChanging] = useState(false);\n  const [rejectionReason, setRejectionReason] = useState('');\n  const [isRejectionDialogOpen, setIsRejectionDialogOpen] = useState(false);\n\n  const [isSolicitanteSignAlertOpen, setIsSolicitanteSignAlertOpen] = useState(false);\n\n  const [isDailyValidationSignatureOpen, setIsDailyValidationSignatureOpen] = useState(false);\n  const [isDailyValidationSigning, setIsDailyValidationSigning] = useState(false);\n  const [dailyValidationTarget, setDailyValidationTarget] = useState<{\n    anexo: string;\n    type: 'autoridad' | 'responsable';\n    index: number;\n  } | null>(null);\n  const [dailyValidationName, setDailyValidationName] = useState('');\n  const [dailyValidationDate, setDailyValidationDate] = useState('');\n\n  const [isWorkerSignatureOpen, setIsWorkerSignatureOpen] = useState(false);\n  const [workerSignatureTarget, setWorkerSignatureTarget] = useState<{\n    index: number;\n    type: 'firmaApertura' | 'firmaCierre';\n  } | null>(null);\n\n  const [isClosureDialogOpen, setIsClosureDialogOpen] = useState(false);\n  const [isCancellationDialogOpen, setIsCancellationDialogOpen] = useState(false);\n  const [cancellationReason, setCancellationReason] = useState('');\n\n  // ===== DEFINICIONES DE DATOS =====\n\n  const atsPeligros = [\n    { seccion: 'LOCATIVOS', id: 'superficies_irregulares', label: 'Superficies irregulares' },\n    { seccion: 'LOCATIVOS', id: 'superficies_deslizantes', label: 'Superficies deslizantes' },\n    { seccion: 'LOCATIVOS', id: 'diferencia_nivel', label: 'Superficies con diferencia de nivel' },\n    { seccion: 'LOCATIVOS', id: 'techos_mal_estado', label: 'Techos, muros, pisos o paredes en mal estado' },\n    { seccion: 'LOCATIVOS', id: 'espacios_reducidos', label: 'Espacios reducidos de trabajo' },\n    { seccion: 'F√çSICOS', id: 'deficiencia_iluminacion', label: 'Deficiencia de iluminaci√≥n' },\n    { seccion: 'F√çSICOS', id: 'exceso_iluminacion', label: 'Exceso de iluminaci√≥n' },\n    { seccion: 'F√çSICOS', id: 'ruido_intermitente', label: 'Ruido (Intermitente/Continuo/Impacto)' },\n    { seccion: 'F√çSICOS', id: 'contacto_superficies_calientes', label: 'Contacto con superficies calientes' },\n    { seccion: 'F√çSICOS', id: 'exposicion_soldadura', label: 'Exposici√≥n a arco de soldadura' },\n    { seccion: 'QU√çMICOS', id: 'gases_humos_vapores', label: 'Gases, humos, vapores y neblinas' },\n    { seccion: 'QU√çMICOS', id: 'material_particulado', label: 'Material particulado' },\n    { seccion: 'QU√çMICOS', id: 'contacto_sustancias_peligrosas', label: 'Uso o contacto con materiales o sustancias peligrosas' },\n    { seccion: 'QU√çMICOS', id: 'derrame_productos_quimicos', label: 'Derrame o fugas de Productos Qu√≠micos' },\n    { seccion: 'MEC√ÅNICOS', id: 'proyeccion_particulas', label: 'Proyecci√≥n de part√≠culas y fragmentos' },\n    { seccion: 'MEC√ÅNICOS', id: 'mecanismos_movimiento', label: 'Mecanismos en movimiento' },\n    { seccion: 'MEC√ÅNICOS', id: 'manejo_herramientas', label: 'Manejo de herramienta o equipos el√©ctricos' },\n    { seccion: 'MEC√ÅNICOS', id: 'movimiento_equipos_pesados', label: 'Movimiento de equipos de trabajo pesado en sitio' },\n    { seccion: 'MEC√ÅNICOS', id: 'exposicion_vibraciones', label: 'Exposici√≥n a vibraciones por equipos' },\n    { seccion: 'BIOL√ìGICOS', id: 'exposicion_vectores', label: 'Exposici√≥n a vectores transmisi√≥n de enfermedades' },\n    { seccion: 'BIOL√ìGICOS', id: 'contaminacion_biologica', label: 'Contaminaci√≥n biol√≥gica' },\n    { seccion: 'VIAL', id: 'accidente_incidente_vial', label: 'Accidente o incidente vial' },\n    { seccion: 'VIAL', id: 'atropellamiento_personas', label: 'Atropellamiento a personas' },\n    {\n      seccion: 'BIOMEC√ÅNICOS',\n      id: 'carga_estatica',\n      label: 'Carga Est√°tica (Posturas inadecuadas, prolongadas, forzadas, antigravitaci√≥n)',\n    },\n    {\n      seccion: 'BIOMEC√ÅNICOS',\n      id: 'carga_dinamica',\n      label: 'Carga Din√°mica (Esfuerzos, Movilizaci√≥n de cargas, Movimientos repetitivos)',\n    },\n    { seccion: 'AMBIENTALES', id: 'generacion_residuos', label: 'Generaci√≥n de residuos/escombros' },\n    { seccion: 'AMBIENTALES', id: 'consumo_agua', label: 'Consumo de agua en grandes cantidades' },\n    { seccion: 'AMBIENTALES', id: 'mezcla_concreto', label: 'Mezcla de concreto en suelo' },\n    { seccion: 'AMBIENTALES', id: 'emisiones_material_particulado', label: 'Emisiones de material particulado' },\n  ];\n\n  const anexoAlturaAspectos = [\n    { id: 'afiliacionVigente', label: 'A. ¬øEL PERSONAL EJECUTANTE DE LA ACTIVIDAD TIENE LA AFILIACI√ìN VIGENTE A SEGURIDAD SOCIAL?' },\n    { id: 'procedimientoActividad', label: 'B. ¬øSE CUENTA CON EL PROCEDIMIENTO DE LA ACTIVIDAD A EJECUTAR?' },\n    { id: 'medidasPrevencion', label: 'C. ¬øSE HAN DETERMINADO LAS MEDIDAS DE PREVENCI√ìN CONTRA CA√çDAS?' },\n    {\n      id: 'conocenMedidas',\n      label: 'D. ¬øTODOS LOS EJECUTANTES CONOCEN LAS MEDIDAS DE PRECAUCI√ìN ESTABLECIDAS EN LA EVALUACI√ìN DE RIESGOS?',\n    },\n    {\n      id: 'entrenadosCertificados',\n      label: 'E. ¬øEST√ÅN LOS EJECUTANTES ENTRENADOS Y SE ENCUENTRAN LOS CERTIFICADOS EN SITIO PARA REALIZAR TRABAJOS EN ALTURA?',\n    },\n    {\n      id: 'elementosProteccionCertificados',\n      label: 'F. ¬øEST√ÅN TODOS LOS ELEMENTOS DE PROTECCI√ìN CONTRA CA√çDAS EN BUEN ESTADO E CERTIFICADOS?',\n    },\n    {\n      id: 'sistemaAseguramientoVerificado',\n      label: 'G. ¬øSE VERIFIC√ì EL SISTEMA DE ASEGURAMIENTO DE LA ESCALERA, ANDAMIO O PLATAFORMA A UNA ESTRUCTURA FIJA?',\n    },\n    {\n      id: 'estadoElementosVerificado',\n      label: 'H. ¬øSE VERIFIC√ì EL ESTADO DE ESLINGAS, ARN√âS, CASCO, MOSQUETONES Y DEM√ÅS ELEMENTOS NECESARIOS PARA REALIZAR EL TRABAJO?',\n    },\n    {\n      id: 'puntosAnclajeCertificados',\n      label: 'I. ¬øLOS PUNTOS DE ANCLAJE Y DEM√ÅS ELEMENTOS CUMPLEN CON LA RESISTENCIA DE 5000 LBS POR PERSONA Y EST√ÅN CERTIFICADOS?',\n    },\n    { id: 'areaDelimitada', label: 'J. ¬øEST√Å DELIMITADA Y SE√ëALIZADA EL √ÅREA DE TRABAJO?' },\n    {\n      id: 'personalSaludable',\n      label: 'K. ¬øEL PERSONAL QUE REALIZA EL TRABAJO SE ENCUENTRA EN CONDICIONES ADECUADAS DE SALUD PARA LA ACTIVIDAD?',\n    },\n    {\n      id: 'equiposAccesoBuenEstado',\n      label: 'L. ¬øSE CUENTA CON TODOS LOS EQUIPOS Y SISTEMAS DE ACCESO PARA TRABAJO EN ALTURAS EN BUEN ESTADO?',\n    },\n    {\n      id: 'espacioCaidaLibreSuficiente',\n      label: 'M. ¬øEL ESPACIO DE CA√çDA LIBRE ES SUFICIENTE PARA EVITAR QUE LA PERSONA SE GOLPEE CONTRA EL NIVEL INFERIOR?',\n    },\n    {\n      id: 'equiposEmergenciaDisponibles',\n      label: 'N. ¬øSE CUENTA CON ELEMENTOS PARA ATENCI√ìN DE EMERGENCIAS EN EL √ÅREA Y PLAN DE EMERGENCIAS PARA RESCATE EN ALTURAS?',\n    },\n    {\n      id: 'eppSeleccionadosCorrectamente',\n      label: 'O. ¬øEST√ÅN LOS ELEMENTOS DE PROTECCI√ìN PERSONAL SELECCIONADOS TENIENDO EN CUENTA LOS RIESGOS Y REQUERIMIENTOS DE LA TAREA?',\n    },\n    {\n      id: 'plataformaSoportaCarga',\n      label: 'P. ¬øLA PLATAFORMA O ESTRUCTURA SOPORTA LA CARGA DE TRABAJO, ES FIRME Y SE EVITA LA CA√çDA DE OBJETOS O HERRAMIENTAS?',\n    },\n    { id: 'supervisorConstante', label: 'Q. ¬øEXISTE UN SUPERVISOR O ACOMPA√ëANTE CONSTANTE DURANTE EL TRABAJO?' },\n    {\n      id: 'andamiosCompletos',\n      label: 'R. EN CASO DE TRABAJOS SOBRE ANDAMIOS, ¬øESTOS EST√ÅN COMPLETOS Y ADECUADAMENTE ARMADOS (RODAPI√âS, BARANDAS, ETC.)?',\n    },\n    { id: 'condicionesClimaticasAdecuadas', label: 'S. ¬øLAS CONDICIONES CLIM√ÅTICAS SON ADECUADAS PARA REALIZAR EL TRABAJO?' },\n    { id: 'metodoSubirHerramientasSeguro', label: 'T. ¬øEL M√âTODO DE SUBIR HERRAMIENTAS ES SEGURO?' },\n    { id: 'sistemasRestriccion', label: 'U. EN CASO DE REQUERIRSE ¬øSE CUENTA CON SISTEMAS DE RESTRICCI√ìN?' },\n    { id: 'sistemasPosicionamiento', label: 'V. EN CASO DE REQUERIRSE ¬øSE CUENTA CON SISTEMAS DE POSICIONAMIENTO?' },\n  ];\n\n  const eppOptions = [\n    // Protecci√≥n Cabeza, Visual, Auditiva y Respiratoria\n    [\n      { id: 'casco_seguridad', label: 'Casco de seguridad', type: 'custom_casco' },\n      { id: 'gafas_seguridad', label: 'Gafas de seguridad', type: 'boolean' },\n      { id: 'gafas_oxicorte', label: 'Gafas de oxicorte', type: 'boolean' },\n      { id: 'monogafas', label: 'Monogafas', type: 'boolean' },\n      { id: 'careta_soldador', label: 'Careta de soldador', type: 'boolean' },\n      { id: 'careta_proteccion_total', label: 'Careta de protecci√≥n total', type: 'boolean' },\n      { id: 'gafas_antisalpicaduras', label: 'Gafas antisalpicaduras', type: 'boolean' },\n      { id: 'visor_careta', label: 'Visor careta para', type: 'text' },\n      { id: 'careta_arco_electrico', label: 'Careta arco el√©ctrico clase', type: 'text' },\n      { id: 'protector_auditivo', label: 'Protector auditivo tipo', type: 'select', selectOptions: ['Copa', 'Inserci√≥n'] },\n      { id: 'mascarilla_filtro', label: 'Mascarilla con filtro', type: 'text' },\n      { id: 'chavo_entela_carnaza', label: 'Chavo en tela o carnaza', type: 'boolean' },\n      { id: 'mascarilla_material_particulado', label: 'Mascarilla material particulado', type: 'boolean' },\n    ],\n    // Protecci√≥n Corporal, Manos y Pies\n    [\n      { id: 'overol_trabajo', label: 'Overol de trabajo', type: 'boolean' },\n      { id: 'overol_ignifugo', label: 'Overol ign√≠fugo clase', type: 'text' },\n      { id: 'chaleco_reflectivo', label: 'Chaleco reflectivo', type: 'boolean' },\n      { id: 'chaqueta_cuero_carnaza', label: 'Chaqueta de cuero o carnaza', type: 'boolean' },\n      { id: 'delantal_cuero_carnaza', label: 'Delantal de cuero o carnaza', type: 'boolean' },\n      { id: 'delantal_pvc', label: 'Delantal de PVC', type: 'boolean' },\n      { id: 'polainas', label: 'Polainas', type: 'boolean' },\n      {\n        id: 'guante_dielectrico',\n        label: 'Guante diel√©ctrico clase (guant√≠n, guante diel√©ctrico, protecci√≥n mec√°nica)',\n        type: 'text',\n      },\n      { id: 'guante_caucho_nitrilo', label: 'Guante de caucho y/o nitrilo', type: 'boolean' },\n      { id: 'guante_cuero_carnaza', label: 'Guante de cuero o carnaza', type: 'boolean' },\n      { id: 'guante_vaqueta_anticorte', label: 'Guante de vaqueta o Anticorte', type: 'boolean' },\n      { id: 'guante_temperatura', label: 'Guante temperatura', type: 'boolean' },\n      { id: 'botas_seguridad', label: 'Botas de seguridad', type: 'boolean' },\n      { id: 'botas_caucho_seguridad', label: 'Botas de caucho de seguridad', type: 'boolean' },\n      { id: 'botas_dielectricas', label: 'Botas diel√©ctricas', type: 'boolean' },\n      { id: 'proteccion_metatarso', label: 'Protecci√≥n Metatarso', type: 'boolean' },\n    ],\n    // Protecci√≥n Contra Ca√≠das y Equipos Especiales\n    [\n      { id: 'arnes', label: 'Arn√©s', type: 'text' },\n      { id: 'mosqueton', label: 'Mosquet√≥n', type: 'boolean' },\n      { id: 'punto_anclaje', label: 'Punto de anclaje (cual)', type: 'text' },\n      { id: 'eslinga', label: 'Eslinga tipo/absorbedor', type: 'text' },\n      { id: 'linea_vida', label: 'L√≠nea de vida', type: 'text' },\n      { id: 'adaptador_anclaje', label: 'Adaptador de anclaje', type: 'text' },\n      { id: 'aire_respirable', label: 'Aire respirable (compresor o cilindro)', type: 'boolean' },\n      { id: 'tapete_dielectrico', label: 'Tapete diel√©ctrico clase', type: 'text' },\n      { id: 'senalizacion', label: 'Se√±alizaci√≥n', type: 'boolean' },\n      { id: 'barandas', label: 'Barandas', type: 'boolean' },\n      { id: 'delimitacion_perimetral', label: 'Delimitaci√≥n per√≠metro', type: 'boolean' },\n      { id: 'control_acceso', label: 'Control acceso', type: 'boolean' },\n      { id: 'otro_epp', label: 'Otro', type: 'text' },\n    ],\n  ];\n\n  const justificacionOptions = [\n    { id: 'rutinario_3meses', label: 'TRABAJO RUTINARIO REALIZADO 1 VEZ CADA 3 MESES' },\n    { id: 'no_rutinario_emergencia', label: 'TRABAJO NO RUTINARIO (EMERGENCIA)' },\n    {\n      id: 'rutinario_sin_procedimiento',\n      label: 'TRABAJO RUTINARIO QUE NO POSEE UN PROCEDIMIENTO SEGURO DE TRABAJO O INDICACI√ìN CORRECTA DE RIESGOS O MEDIDAS PREVENTIVAS',\n    },\n    { id: 'no_rutinario_planeado', label: 'TRABAJO NO RUTINARIO PLANEADO' },\n    {\n      id: 'rutinario_condicion_especifica',\n      label: 'TRABAJO RUTINARIO QUE POR UNA CONDICI√ìN ESPEC√çFICA/TEMPORAL, NO ES POSIBLE APLICAR UN PROCEDIMIENTO DE FORMA INTEGRAL',\n    },\n  ];\n\n  const anexoAlturaEstructuras = [\n    { id: 'escalera_cuerpo', label: 'Escalera de un cuerpo' },\n    { id: 'escalera_dos_cuerpos', label: 'Escalera de dos cuerpos o m√°s' },\n    { id: 'andamio_tubular', label: 'Andamio Tubular Certificado' },\n    { id: 'andamio_colgante', label: 'Andamio Colgante' },\n    { id: 'plataforma', label: 'Plataforma' },\n    { id: 'man_lift', label: 'Man Lift o Cami√≥n Canasta' },\n    { id: 'otros', label: 'Otros' },\n  ];\n\n  // ===== USE EFFECT - SUSCRIPCI√ìN AL PERMISO =====\n  useEffect(() => {\n    if (!permitId) {\n      setError('ID de permiso no v√°lido.');\n      setLoading(false);\n      return;\n    }\n\n    let isMounted = true;\n    const docRef = doc(db, 'permits', permitId);\n\n    const unsubscribe = onSnapshot(\n      docRef,\n      (docSnap) => {\n        if (isMounted) {\n          if (docSnap.exists()) {\n            const data = docSnap.data();\n            setPermit({ id: docSnap.id, ...data } as Permit);\n            setError(null);\n          } else {\n            setError('No se encontr√≥ el permiso de trabajo.');\n            setPermit(null);\n          }\n          setLoading(false);\n        }\n      },\n      (serverError) => {\n        if (isMounted) {\n          const permissionError = new FirestorePermissionError({\n            path: docRef.path,\n            operation: 'get',\n          });\n          errorEmitter.emit('permission-error', permissionError);\n          setError('No tiene permisos para ver este documento o ha ocurrido un error.');\n          setLoading(false);\n        }\n      }\n    );\n\n    return () => {\n      isMounted = false;\n      unsubscribe();\n    };\n  }, [permitId]);\n    // ===== FUNCI√ìN HANDLEEXPORTTOPDF - VERSI√ìN PROFESIONAL MEJORADA =====\n    const handleExportToPDF = async () => {\n      if (!permit) {\n        toast({\n          variant: 'destructive',\n          title: 'Error',\n          description: 'Datos del permiso no disponibles.',\n        });\n        return;\n      }\n  \n      toast({\n        title: 'Generando PDF...',\n        description: 'Por favor, espere un momento.',\n      });\n  \n      const logoBase64 = ''; // Dejar vac√≠o para agregar logo manualmente\n  \n      try {\n        const doc = new jsPDF('p', 'mm', 'letter');\n        const pageWidth = doc.internal.pageSize.width;\n        const pageHeight = doc.internal.pageSize.height;\n        const margin = 10;\n        let yPos = margin;\n  \n        // Colores corporativos\n        const italcolOrange = [239, 123, 0];\n        const lightGray = [240, 240, 240];\n        const darkGray = [100, 100, 100];\n  \n        // ===== FUNCIONES HELPER PDF =====\n  \n        const checkPageBreak = (neededHeight: number) => {\n          if (yPos + neededHeight > pageHeight - margin) {\n            doc.addPage();\n            yPos = margin;\n          }\n        };\n  \n        const drawHeader = (title: string, code = 'DN-FR-SST-016', version = '04') => {\n          // Logo (espacio reservado)\n          try {\n            if (logoBase64) {\n              doc.addImage(logoBase64, 'PNG', margin, yPos, 30, 20);\n            } else {\n              doc.setFillColor(italcolOrange[0], italcolOrange[1], italcolOrange[2]);\n              doc.rect(margin, yPos, 30, 20, 'F');\n              doc.setTextColor(255, 255, 255);\n              doc.setFontSize(8);\n              doc.text('LOGO', margin + 15, yPos + 12, { align: 'center' });\n              doc.setTextColor(0, 0, 0);\n            }\n          } catch (e) {\n            console.error('Error al cargar logo:', e);\n            doc.setFillColor(italcolOrange[0], italcolOrange[1], italcolOrange[2]);\n            doc.rect(margin, yPos, 30, 20, 'F');\n          }\n  \n          // T√≠tulo principal\n          doc.setFontSize(14);\n          doc.setFont('helvetica', 'bold');\n          doc.setTextColor(0, 0, 0);\n          doc.text(title.toUpperCase(), pageWidth / 2, yPos + 10, { align: 'center' });\n  \n          // C√≥digo y versi√≥n\n          doc.setFontSize(8);\n          doc.setFont('helvetica', 'normal');\n          doc.text(`C√≥digo: ${code}`, pageWidth - margin, yPos + 8, { align: 'right' });\n          doc.text(`Versi√≥n: ${version}`, pageWidth - margin, yPos + 13, { align: 'right' });\n  \n          // L√≠nea separadora naranja\n          doc.setDrawColor(italcolOrange[0], italcolOrange[1], italcolOrange[2]);\n          doc.setLineWidth(1);\n          doc.line(margin, yPos + 24, pageWidth - margin, yPos + 24);\n  \n          yPos += 30;\n        };\n  \n        const drawSectionTitle = (title: string) => {\n          checkPageBreak(12);\n          doc.setFillColor(italcolOrange[0], italcolOrange[1], italcolOrange[2]);\n          doc.rect(margin, yPos, pageWidth - 2 * margin, 7, 'F');\n          doc.setTextColor(255, 255, 255);\n          doc.setFontSize(10);\n          doc.setFont('helvetica', 'bold');\n          doc.text(title.toUpperCase(), pageWidth / 2, yPos + 5, { align: 'center' });\n          yPos += 9;\n          doc.setTextColor(0, 0, 0);\n        };\n  \n        const drawSubSectionTitle = (title: string) => {\n          checkPageBreak(8);\n          doc.setFillColor(lightGray[0], lightGray[1], lightGray[2]);\n          doc.rect(margin, yPos, pageWidth - 2 * margin, 5, 'F');\n          doc.setTextColor(0, 0, 0);\n          doc.setFontSize(8);\n          doc.setFont('helvetica', 'bold');\n          doc.text(title, margin + 2, yPos + 3.5);\n          yPos += 7;\n        };\n  \n        const drawSignatureBox = (roleTitle: string, approval: any, x: number, y: number, width: number, height: number) => {\n          doc.setDrawColor(0, 0, 0);\n          doc.setLineWidth(0.3);\n          doc.rect(x, y, width, height);\n  \n          // T√≠tulo del rol\n          doc.setFontSize(7);\n          doc.setFont('helvetica', 'bold');\n          doc.text(roleTitle, x + 2, y + 4);\n  \n          if (approval?.status === 'aprobado') {\n            // Nombre\n            doc.setFont('helvetica', 'normal');\n            doc.setFontSize(7);\n            doc.text(`Nombre: ${approval.userName || 'N/A'}`, x + 2, y + 9);\n  \n            // Firma (imagen)\n            if (approval.firmaApertura || approval.firma) {\n              try {\n                const firmaImg = approval.firmaApertura || approval.firma;\n                doc.addImage(firmaImg, 'PNG', x + width / 2 - 20, y + 11, 40, 12);\n              } catch (e) {\n                console.error(`Error a√±adiendo firma para ${roleTitle}:`, e);\n                doc.setFontSize(6);\n                doc.setTextColor(150, 150, 150);\n                doc.text('[Firma no disponible]', x + width / 2, y + 18, { align: 'center' });\n                doc.setTextColor(0, 0, 0);\n              }\n            }\n  \n            // Fecha\n            doc.setFontSize(6);\n            doc.text(`Fecha: ${safeFormat(approval.signedAt || approval.fecha, 'dd/MM/yy HH:mm')}`, x + 2, y + height - 2);\n  \n            // Observaci√≥n si existe\n            if (approval.observacion) {\n              doc.setFontSize(5);\n              doc.text(`Obs: ${approval.observacion.substring(0, 30)}...`, x + 2, y + height - 6);\n            }\n          } else {\n            doc.setFont('helvetica', 'italic');\n            doc.setFontSize(8);\n            doc.setTextColor(150, 150, 150);\n            doc.text('PENDIENTE DE FIRMA', x + width / 2, y + height / 2, { align: 'center' });\n            doc.setTextColor(0, 0, 0);\n          }\n        };\n  \n        const drawDailyValidationTable = (validationData: any, permitDuration: number, anexoTitle: string) => {\n          checkPageBreak(50);\n          drawSubSectionTitle(`Validaci√≥n Diaria - ${anexoTitle}`);\n  \n          const bodyData = Array.from({ length: permitDuration }, (_, idx) => {\n            const valRes = validationData?.responsable?.[idx];\n            const valAut = validationData?.autoridad?.[idx];\n            return [\n              `D√çA ${idx + 1}`,\n              valRes?.nombre || '',\n              safeFormat(valRes?.fecha, 'dd/MM/yy'),\n              valAut?.nombre || '',\n              safeFormat(valAut?.fecha, 'dd/MM/yy'),\n            ];\n          });\n  \n          autoTable(doc, {\n            startY: yPos,\n            head: [\n              [\n                { content: 'D√çA', rowSpan: 2, styles: { valign: 'middle', halign: 'center' } },\n                { content: 'RESPONSABLE DEL TRABAJO', colSpan: 2, styles: { halign: 'center' } },\n                { content: 'AUTORIDAD DEL √ÅREA', colSpan: 2, styles: { halign: 'center' } },\n              ],\n              ['NOMBRE', 'FECHA', 'NOMBRE', 'FECHA'],\n            ],\n            body: bodyData,\n            theme: 'grid',\n            styles: { fontSize: 6, cellPadding: 1.5, lineColor: [0, 0, 0], lineWidth: 0.1 },\n            headStyles: { fillColor: lightGray, textColor: [0, 0, 0], fontStyle: 'bold' },\n          });\n          yPos = (doc as any).lastAutoTable.finalY + 5;\n        };\n  \n        // Helper para obtener tipos de trabajo\n        const getWorkTypesString = (permit: Permit): string => {\n          const workTypes: string[] = [];\n          if (!permit.selectedWorkTypes) return 'Trabajo General';\n          if (permit.selectedWorkTypes.alturas) workTypes.push('Trabajo en Alturas');\n          if (permit.selectedWorkTypes.confinado) workTypes.push('Espacios Confinados');\n          if (permit.selectedWorkTypes.energia) workTypes.push('Control de Energ√≠as');\n          if (permit.selectedWorkTypes.izaje) workTypes.push('Izaje de Cargas');\n          if (permit.selectedWorkTypes.excavacion) workTypes.push('Excavaciones');\n          if (permit.selectedWorkTypes.general) workTypes.push('Trabajo General');\n          return workTypes.length > 0 ? workTypes.join(', ') : 'Trabajo General';\n        };\n  \n        // Calcular duraci√≥n del permiso\n        let permitDuration = 1;\n        if (permit.generalInfo?.validFrom && permit.generalInfo?.validUntil) {\n          try {\n            const startDate = parseISO(permit.generalInfo.validFrom);\n            const endDate = parseISO(permit.generalInfo.validUntil);\n            if (isValid(startDate) && isValid(endDate)) {\n              permitDuration = differenceInCalendarDays(endDate, startDate) + 1;\n            }\n          } catch (e) {\n            console.error('Error parsing dates:', e);\n          }\n        }\n  \n        // ===== INICIO DEL CONTENIDO DEL PDF =====\n  \n        // ENCABEZADO\n        drawHeader('PERMISO DE TRABAJO');\n  \n        // ‚úÖ SECCI√ìN 1: INFORMACI√ìN GENERAL\n        drawSectionTitle('1. INFORMACI√ìN GENERAL DEL PERMISO');\n  \n        autoTable(doc, {\n          startY: yPos,\n          body: [\n            [\n              { content: 'Fecha Expedici√≥n:', styles: { fontStyle: 'bold', fillColor: lightGray } },\n              safeFormat(permit.createdAt, 'dd/MM/yyyy HH:mm'),\n              { content: 'N¬∞ Permiso:', styles: { fontStyle: 'bold', fillColor: lightGray } },\n              permit.number || permit.id.substring(0, 8),\n            ],\n            [\n              { content: 'Planta:', styles: { fontStyle: 'bold', fillColor: lightGray } },\n              permit.generalInfo?.planta || 'N/A',\n              { content: 'Proceso:', styles: { fontStyle: 'bold', fillColor: lightGray } },\n              permit.generalInfo?.proceso || 'N/A',\n            ],\n            [\n              { content: 'Empresa:', styles: { fontStyle: 'bold', fillColor: lightGray } },\n              permit.generalInfo?.empresa || 'N/A',\n              { content: 'Contrato:', styles: { fontStyle: 'bold', fillColor: lightGray } },\n              permit.generalInfo?.contrato || 'N/A',\n            ],\n            [\n              { content: '√Årea Espec√≠fica:', styles: { fontStyle: 'bold', fillColor: lightGray } },\n              permit.generalInfo?.areaEspecifica || 'N/A',\n              { content: 'Solicitante:', styles: { fontStyle: 'bold', fillColor: lightGray } },\n              permit.user?.displayName || permit.generalInfo?.nombreSolicitante || 'N/A',\n            ],\n            [\n              { content: 'V√°lido Desde:', styles: { fontStyle: 'bold', fillColor: lightGray } },\n              safeFormat(permit.generalInfo?.validFrom, 'dd/MM/yy HH:mm'),\n              { content: 'V√°lido Hasta:', styles: { fontStyle: 'bold', fillColor: lightGray } },\n              safeFormat(permit.generalInfo?.validUntil, 'dd/MM/yy HH:mm'),\n            ],\n            [\n              { content: 'N¬∞ Trabajadores:', styles: { fontStyle: 'bold', fillColor: lightGray } },\n              String(permit.generalInfo?.numTrabajadores || permit.workers?.length || 0),\n              { content: 'Responsable:', styles: { fontStyle: 'bold', fillColor: lightGray } },\n              `${permit.generalInfo?.responsable?.nombre || 'N/A'} (${permit.generalInfo?.responsable?.cargo || ''})`,\n            ],\n            [\n              { content: 'Tipos de Trabajo Seleccionados:', colSpan: 3, styles: { fontStyle: 'bold', fillColor: lightGray } },\n              getWorkTypesString(permit),\n            ],\n          ],\n          theme: 'grid',\n          styles: { fontSize: 7, cellPadding: 2, lineColor: [0, 0, 0], lineWidth: 0.1 },\n          columnStyles: { 0: { cellWidth: 40 }, 2: { cellWidth: 40 } },\n        });\n        yPos = (doc as any).lastAutoTable.finalY + 5;\n  \n        // Descripci√≥n del trabajo\n        autoTable(doc, {\n          startY: yPos,\n          head: [[{ content: 'DESCRIPCI√ìN DEL TRABAJO (ALCANCE)', styles: { fillColor: lightGray, textColor: [0, 0, 0], fontStyle: 'bold' } }]],\n          body: [[permit.generalInfo?.workDescription || 'No especificado']],\n          theme: 'grid',\n          styles: { fontSize: 7, cellPadding: 3, lineColor: [0, 0, 0], lineWidth: 0.1 },\n        });\n        yPos = (doc as any).lastAutoTable.finalY + 5;\n  \n        // Herramientas y equipos\n        if (permit.generalInfo?.tools && permit.generalInfo.tools.length > 0) {\n          autoTable(doc, {\n            startY: yPos,\n            head: [[{ content: 'HERRAMIENTAS Y EQUIPOS', styles: { fillColor: lightGray, textColor: [0, 0, 0], fontStyle: 'bold' } }]],\n            body: [[permit.generalInfo.tools.map((t) => t.name).join(', ')]],\n            theme: 'grid',\n            styles: { fontSize: 7, cellPadding: 2 },\n          });\n          yPos = (doc as any).lastAutoTable.finalY + 5;\n        }\n  \n        // ‚úÖ SECCI√ìN 2: AN√ÅLISIS DE TRABAJO SEGURO (ATS)\n        if (permit.anexoATS) {\n          checkPageBreak(40);\n          drawSectionTitle('2. AN√ÅLISIS DE TRABAJO SEGURO (ATS)');\n  \n          // 2.1 Peligros Identificados\n          if (permit.anexoATS.peligros) {\n            drawSubSectionTitle('2.1 Identificaci√≥n de Peligros y Riesgos');\n  \n            const activeRisks = atsPeligros.filter((p) => (permit.anexoATS?.peligros as any)?.[p.id] === 'si');\n  \n            if (activeRisks.length > 0) {\n              const risksBySection = activeRisks.reduce((acc, r) => {\n                if (!acc[r.seccion]) acc[r.seccion] = [];\n                acc[r.seccion].push(r.label);\n                return acc;\n              }, {} as Record<string, string[]>);\n  \n              const riskRows = Object.entries(risksBySection).flatMap(([section, risks]) => [\n                [{ content: `${section}:`, styles: { fontStyle: 'bold', fillColor: [250, 250, 250] }, colSpan: 2 }],\n                ...risks.map((risk) => ['‚úì', risk]),\n              ]);\n  \n              autoTable(doc, {\n                startY: yPos,\n                body: riskRows,\n                theme: 'grid',\n                styles: { fontSize: 6, cellPadding: 1.5 },\n                columnStyles: { 0: { cellWidth: 8, halign: 'center' } },\n              });\n              yPos = (doc as any).lastAutoTable.finalY + 5;\n            } else {\n              autoTable(doc, {\n                startY: yPos,\n                body: [['No se identificaron peligros espec√≠ficos']],\n                theme: 'grid',\n                styles: { fontSize: 7, cellPadding: 2, fontStyle: 'italic', textColor: darkGray },\n              });\n              yPos = (doc as any).lastAutoTable.finalY + 5;\n            }\n          }\n  \n          // 2.2 EPP Requeridos\n          if (permit.anexoATS.epp) {\n            checkPageBreak(30);\n            drawSubSectionTitle('2.2 Equipos de Protecci√≥n Personal (EPP) Requeridos');\n  \n            const eppData: Record<string, string[]> = {};\n            Object.entries(permit.anexoATS.epp).forEach(([key, value]) => {\n              if (value === true || value === 'si') {\n                // Buscar la categor√≠a\n                let category = 'Otros';\n                for (let i = 0; i < eppOptions.length; i++) {\n                  if (eppOptions[i].some((item) => item.id === key)) {\n                    category = i === 0 ? 'Protecci√≥n Cabeza/Visual/Auditiva' : i === 1 ? 'Protecci√≥n Corporal/Manos/Pies' : 'Protecci√≥n Ca√≠das/Especiales';\n                    break;\n                  }\n                }\n  \n                if (!eppData[category]) eppData[category] = [];\n  \n                const itemLabel =\n                  Object.values(eppOptions)\n                    .flat()\n                    .find((item) => item.id === key)?.label || key;\n  \n                const spec = (permit.anexoATS.epp as any)[`${key}_spec`] || (permit.anexoATS.epp as any)[`${key}_tipo`];\n                eppData[category].push(spec ? `${itemLabel}: ${spec}` : itemLabel);\n              }\n            });\n  \n            if (Object.keys(eppData).length > 0) {\n              const eppRows = Object.entries(eppData).flatMap(([category, items]) => [\n                [{ content: category, styles: { fontStyle: 'bold', fillColor: [250, 250, 250] }, colSpan: 2 }],\n                ...items.map((item) => ['‚úì', item]),\n              ]);\n  \n              autoTable(doc, {\n                startY: yPos,\n                body: eppRows,\n                theme: 'grid',\n                styles: { fontSize: 6, cellPadding: 1.5 },\n                columnStyles: { 0: { cellWidth: 8, halign: 'center' } },\n              });\n              yPos = (doc as any).lastAutoTable.finalY + 5;\n            }\n          }\n  \n          // 2.3 Justificaci√≥n de Uso\n          if (permit.anexoATS.justificacion) {\n            checkPageBreak(15);\n            drawSubSectionTitle('2.3 Justificaci√≥n de Uso del Permiso');\n  \n            const justSelected = justificacionOptions.find((j) => (permit.anexoATS?.justificacion as any)?.[j.id] === 'si');\n  \n            if (justSelected) {\n              autoTable(doc, {\n                startY: yPos,\n                body: [[justSelected.label]],\n                theme: 'grid',\n                styles: { fontSize: 7, cellPadding: 2 },\n              });\n              yPos = (doc as any).lastAutoTable.finalY + 5;\n            }\n          }\n        }\n  \n        // ‚úÖ SECCI√ìN 3: PERSONAL AUTORIZADO\n        if (permit.workers && permit.workers.length > 0) {\n          checkPageBreak(40);\n          drawSectionTitle('3. PERSONAL AUTORIZADO');\n  \n          const workerRows = permit.workers.map((w) => [\n            `${w.nombre}\\nC.C. ${w.cedula}`,\n            w.rol === 'Otro' ? w.otroRol || 'Otro' : w.rol,\n            `EPS: ${w.eps || 'N/A'}\\nARL: ${w.arl || 'N/A'}\\nAFP: ${w.pensiones || 'N/A'}`,\n            w.entrenamiento?.tec ? 'TEC' : w.entrenamiento?.tsa ? 'TSA' : w.entrenamiento?.otro || 'N/A',\n            w.firmaApertura ? '‚úì FIRMADO' : 'PENDIENTE',\n            w.firmaCierre ? '‚úì FIRMADO' : 'PENDIENTE',\n          ]);\n  \n          autoTable(doc, {\n            startY: yPos,\n            head: [['NOMBRE / C√âDULA', 'ROL', 'AFILIACI√ìN SEG. SOCIAL', 'ENTRENA.', 'FIRMA APERT.', 'FIRMA CIERRE']],\n            body: workerRows,\n            theme: 'grid',\n            headStyles: { fillColor: lightGray, textColor: [0, 0, 0], fontSize: 7, fontStyle: 'bold' },\n            styles: { fontSize: 6, cellPadding: 2 },\n            columnStyles: {\n              0: { cellWidth: 45 },\n              2: { cellWidth: 35 },\n              3: { cellWidth: 18 },\n              4: { cellWidth: 20, halign: 'center' },\n              5: { cellWidth: 20, halign: 'center' },\n            },\n          });\n          yPos = (doc as any).lastAutoTable.finalY + 5;\n        }\n  \n        // Continuar√° en la siguiente parte con los ANEXOS...\n        // ‚úÖ SECCI√ìN 4: ANEXO 1 - TRABAJO EN ALTURAS (si aplica)\n        if (permit.selectedWorkTypes?.alturas && permit.anexoAltura) {\n          checkPageBreak(80);\n          drawSectionTitle('4. ANEXO 1 - TRABAJO EN ALTURAS');\n  \n          // 4.1 Informaci√≥n General del Anexo\n          drawSubSectionTitle('4.1 Informaci√≥n General');\n          autoTable(doc, {\n            startY: yPos,\n            body: [\n              [\n                { content: 'Altura Aproximada (m):', styles: { fontStyle: 'bold', fillColor: lightGray } },\n                permit.anexoAltura.alturaAproximada || 'N/A',\n              ],\n              [\n                { content: 'Tarea a Realizar:', styles: { fontStyle: 'bold', fillColor: lightGray } },\n                permit.anexoAltura.tareaRealizar?.nombre || 'N/A',\n              ],\n              [\n                { content: 'Descripci√≥n:', styles: { fontStyle: 'bold', fillColor: lightGray } },\n                permit.anexoAltura.tareaRealizar?.descripcion || 'N/A',\n              ],\n              [\n                { content: 'Contacto Emergencia:', styles: { fontStyle: 'bold', fillColor: lightGray } },\n                `${permit.anexoAltura.emergencia?.contacto || 'N/A'} - Tel: ${permit.anexoAltura.emergencia?.telefono || 'N/A'}`,\n              ],\n              [\n                { content: 'Tipo de Estructura:', styles: { fontStyle: 'bold', fillColor: lightGray } },\n                Object.keys(permit.anexoAltura.tipoEstructura || {})\n                  .filter((k) => (permit.anexoAltura?.tipoEstructura as any)[k])\n                  .map((k) => {\n                    const label = anexoAlturaEstructuras.find((e) => e.id === k)?.label || k;\n                    if (k === 'otros') {\n                      const cual = (permit.anexoAltura?.tipoEstructura as any).otrosCual;\n                      return cual ? `${label}: ${cual}` : label;\n                    }\n                    return label;\n                  })\n                  .join(', ') || 'N/A',\n              ],\n            ],\n            theme: 'grid',\n            styles: { fontSize: 7, cellPadding: 2 },\n            columnStyles: { 0: { cellWidth: 50, fontStyle: 'bold' } },\n          });\n          yPos = (doc as any).lastAutoTable.finalY + 5;\n  \n          // 4.2 Aspectos de Seguridad\n          checkPageBreak(60);\n          drawSubSectionTitle('4.2 Verificaci√≥n de Aspectos de Seguridad');\n  \n          const alturaChecks = anexoAlturaAspectos.map((asp) => [\n            asp.label,\n            (permit.anexoAltura?.aspectosSeguridad as any)?.[asp.id] === 'si' ? '‚úì S√ç' : '‚úó NO',\n          ]);\n  \n          autoTable(doc, {\n            startY: yPos,\n            head: [['REQUISITO DE SEGURIDAD', 'CUMPLE']],\n            body: alturaChecks,\n            theme: 'grid',\n            styles: { fontSize: 6, cellPadding: 1.5 },\n            headStyles: { fillColor: lightGray, textColor: [0, 0, 0], fontStyle: 'bold' },\n            columnStyles: { 1: { halign: 'center', cellWidth: 20 } },\n          });\n          yPos = (doc as any).lastAutoTable.finalY + 5;\n  \n          // 4.3 Precauciones y Controles\n          if (permit.anexoAltura.precauciones && Object.keys(permit.anexoAltura.precauciones).length > 0) {\n            checkPageBreak(30);\n            drawSubSectionTitle('4.3 Precauciones y Controles Espec√≠ficos');\n  \n            const precaucionRows = Object.entries(permit.anexoAltura.precauciones)\n              .filter(([_, value]) => value === 'si' || value === true)\n              .map(([key]) => [\n                '‚úì',\n                key\n                  .replace(/([A-Z])/g, ' $1')\n                  .trim()\n                  .toUpperCase(),\n              ]);\n  \n            if (precaucionRows.length > 0) {\n              autoTable(doc, {\n                startY: yPos,\n                body: precaucionRows,\n                theme: 'grid',\n                styles: { fontSize: 6, cellPadding: 1.5 },\n                columnStyles: { 0: { cellWidth: 8, halign: 'center' } },\n              });\n              yPos = (doc as any).lastAutoTable.finalY + 5;\n            }\n          }\n  \n          // 4.4 Afectaciones\n          if (permit.anexoAltura.afectaciones) {\n            checkPageBreak(20);\n            drawSubSectionTitle('4.4 Afectaciones a Otras √Åreas');\n  \n            autoTable(doc, {\n              startY: yPos,\n              body: [\n                [\n                  '¬øProduce riesgos para otras √°reas?',\n                  permit.anexoAltura.afectaciones.riesgoOtrasAreas === 'si' ? '‚úì S√ç' : '‚úó NO',\n                ],\n                [\n                  '¬øOtras √°reas producen riesgo a este trabajo?',\n                  permit.anexoAltura.afectaciones.otrasAreasRiesgo === 'si' ? '‚úì S√ç' : '‚úó NO',\n                ],\n                ['¬øPersonal notificado?', permit.anexoAltura.afectaciones.personalNotificado === 'si' ? '‚úì S√ç' : '‚úó NO'],\n                [\n                  { content: 'Observaciones:', styles: { fontStyle: 'bold' } },\n                  permit.anexoAltura.afectaciones.observaciones || 'Ninguna',\n                ],\n              ],\n              theme: 'grid',\n              styles: { fontSize: 7, cellPadding: 2 },\n              columnStyles: { 1: { halign: 'center', cellWidth: 25 } },\n            });\n            yPos = (doc as any).lastAutoTable.finalY + 5;\n          }\n  \n          // 4.5 Validaci√≥n Diaria\n          if (permit.anexoAltura.validacion?.responsable?.length || permit.anexoAltura.validacion?.autoridad?.length) {\n            drawDailyValidationTable(permit.anexoAltura.validacion, permitDuration, 'Trabajo en Alturas');\n          }\n  \n          // 4.6 Firma del Coordinador\n          if (permit.approvals?.coordinador_alturas?.status === 'aprobado') {\n            checkPageBreak(40);\n            drawSubSectionTitle('4.6 Firma del Coordinador de Trabajos en Alturas');\n            const boxW = pageWidth - 2 * margin;\n            drawSignatureBox('COORDINADOR DE TRABAJOS EN ALTURAS', permit.approvals.coordinador_alturas, margin, yPos, boxW, 35);\n            yPos += 38;\n          }\n        }\n  \n        // ‚úÖ SECCI√ìN 5: ANEXO 2 - ESPACIOS CONFINADOS (si aplica)\n        if (permit.selectedWorkTypes?.confinado && permit.anexoConfinado) {\n          checkPageBreak(80);\n          drawSectionTitle('5. ANEXO 2 - ESPACIOS CONFINADOS');\n  \n          // 5.1 Autorizaciones del Anexo\n          drawSubSectionTitle('5.1 Autorizaciones Espec√≠ficas del Anexo');\n          autoTable(doc, {\n            startY: yPos,\n            body: [\n              [\n                { content: 'Autoridad del √Årea:', styles: { fontStyle: 'bold', fillColor: lightGray } },\n                permit.anexoConfinado.autoridadDelArea?.nombre || 'N/A',\n              ],\n              [\n                { content: 'Responsable del Trabajo:', styles: { fontStyle: 'bold', fillColor: lightGray } },\n                permit.anexoConfinado.responsableDelTrabajo?.nombre || 'N/A',\n              ],\n              [\n                { content: 'Supervisor Trabajo EC:', styles: { fontStyle: 'bold', fillColor: lightGray } },\n                permit.anexoConfinado.supervisorTrabajo?.nombre || 'N/A',\n              ],\n            ],\n            theme: 'grid',\n            styles: { fontSize: 7, cellPadding: 2 },\n            columnStyles: { 0: { cellWidth: 55 } },\n          });\n          yPos = (doc as any).lastAutoTable.finalY + 5;\n  \n          // 5.2 Pruebas de Gases Iniciales\n          checkPageBreak(25);\n          drawSubSectionTitle('5.2 Resultados de Pruebas de Gases Iniciales');\n  \n          autoTable(doc, {\n            startY: yPos,\n            head: [['PAR√ÅMETRO', 'VALOR MEDIDO', 'L√çMITE PERMISIBLE', 'ESTADO']],\n            body: [\n              [\n                'LEL (L√≠mite Explosivo Inferior)',\n                permit.anexoConfinado.resultadosPruebasGases?.lel || '-',\n                '‚â§ 0%',\n                permit.anexoConfinado.resultadosPruebasGases?.lel === '0%' || permit.anexoConfinado.resultadosPruebasGases?.lel === '0' ? '‚úì OK' : '‚úó',\n              ],\n              [\n                'O2 (Ox√≠geno)',\n                permit.anexoConfinado.resultadosPruebasGases?.o2 || '-',\n                '19.5 - 22%',\n                (permit.anexoConfinado.resultadosPruebasGases?.o2 || '').includes('19') ||\n                (permit.anexoConfinado.resultadosPruebasGases?.o2 || '').includes('20') ||\n                (permit.anexoConfinado.resultadosPruebasGases?.o2 || '').includes('21')\n                  ? '‚úì OK'\n                  : '?',\n              ],\n              [\n                'H2S (Sulfuro de Hidr√≥geno)',\n                permit.anexoConfinado.resultadosPruebasGases?.h2s || '-',\n                '0 - 10 PPM',\n                '?',\n              ],\n              [\n                'CO (Mon√≥xido de Carbono)',\n                permit.anexoConfinado.resultadosPruebasGases?.co || '-',\n                '0 - 25 PPM',\n                '?',\n              ],\n            ],\n            theme: 'grid',\n            headStyles: { fillColor: lightGray, textColor: [0, 0, 0], fontSize: 7, fontStyle: 'bold' },\n            styles: { halign: 'center', fontSize: 7, cellPadding: 2 },\n          });\n          yPos = (doc as any).lastAutoTable.finalY + 5;\n  \n          // 5.3 Pruebas Peri√≥dicas de Gases\n          if (permit.anexoConfinado.pruebasGasesPeriodicas?.pruebas?.length) {\n            checkPageBreak(30);\n            drawSubSectionTitle('5.3 Monitoreo Peri√≥dico de Gases');\n  \n            autoTable(doc, {\n              startY: yPos,\n              head: [['HORA', 'LEL %', 'O2 %', 'H2S (ppm)', 'CO (ppm)', 'RESPONSABLE']],\n              body: permit.anexoConfinado.pruebasGasesPeriodicas.pruebas.map((p) => [\n                p.hora || '-',\n                p.lel || '-',\n                p.o2 || '-',\n                p.h2s || '-',\n                p.co || '-',\n                p.responsable || '-',\n              ]),\n              theme: 'grid',\n              headStyles: { fillColor: lightGray, textColor: [0, 0, 0], fontSize: 7, fontStyle: 'bold' },\n              styles: { halign: 'center', fontSize: 6, cellPadding: 1.5 },\n            });\n            yPos = (doc as any).lastAutoTable.finalY + 5;\n          }\n  \n          // 5.4 Requerimientos y Equipos\n          if (permit.anexoConfinado.requerimientosEquipos && Object.keys(permit.anexoConfinado.requerimientosEquipos).length > 0) {\n            checkPageBreak(30);\n            drawSubSectionTitle('5.4 Requerimientos y Equipos de Seguridad');\n  \n            const reqRows = Object.entries(permit.anexoConfinado.requerimientosEquipos)\n              .filter(([_, value]) => value === 'si' || value === true)\n              .map(([key]) => [\n                '‚úì',\n                key\n                  .replace(/([A-Z])/g, ' $1')\n                  .trim()\n                  .toUpperCase(),\n              ]);\n  \n            if (reqRows.length > 0) {\n              autoTable(doc, {\n                startY: yPos,\n                body: reqRows,\n                theme: 'grid',\n                styles: { fontSize: 6, cellPadding: 1.5 },\n                columnStyles: { 0: { cellWidth: 8, halign: 'center' } },\n              });\n              yPos = (doc as any).lastAutoTable.finalY + 5;\n            }\n          }\n  \n          // 5.5 Validaci√≥n Diaria\n          if (permit.anexoConfinado.validacion?.responsable?.length || permit.anexoConfinado.validacion?.autoridad?.length) {\n            drawDailyValidationTable(permit.anexoConfinado.validacion, permitDuration, 'Espacios Confinados');\n          }\n        }\n  \n        // ‚úÖ SECCI√ìN 6: ANEXO 3 - CONTROL DE ENERG√çAS (si aplica)\n        if (permit.selectedWorkTypes?.energia && permit.anexoEnergias) {\n          checkPageBreak(60);\n          drawSectionTitle('6. ANEXO 3 - CONTROL DE ENERG√çAS');\n  \n          // 6.1 Tipos de Energ√≠a Identificados\n          drawSubSectionTitle('6.1 Tipos de Energ√≠a Peligrosa Identificados');\n  \n          const energiasActivas = Object.entries(permit.anexoEnergias.energiasPeligrosas || {})\n            .filter(([_, value]) => value === true || value === 'si')\n            .map(([key]) => [\n              '‚úì',\n              key\n                .replace(/([A-Z])/g, ' $1')\n                .trim()\n                .toUpperCase(),\n            ]);\n  \n          if (energiasActivas.length > 0) {\n            autoTable(doc, {\n              startY: yPos,\n              body: energiasActivas,\n              theme: 'grid',\n              styles: { fontSize: 7, cellPadding: 2 },\n              columnStyles: { 0: { cellWidth: 8, halign: 'center' } },\n            });\n            yPos = (doc as any).lastAutoTable.finalY + 5;\n          }\n  \n          // 6.2 M√©todos de Control\n          if (permit.anexoEnergias.metodosControl) {\n            checkPageBreak(15);\n            drawSubSectionTitle('6.2 M√©todos de Control Aplicados');\n  \n            const metodosActivos = Object.entries(permit.anexoEnergias.metodosControl)\n              .filter(([_, value]) => value)\n              .map(([key]) => key.replace(/([A-Z])/g, ' $1').toUpperCase())\n              .join(', ');\n  \n            autoTable(doc, {\n              startY: yPos,\n              body: [[metodosActivos || 'No especificado']],\n              theme: 'grid',\n              styles: { fontSize: 7, cellPadding: 2 },\n            });\n            yPos = (doc as any).lastAutoTable.finalY + 5;\n          }\n  \n          // 6.3 Trabajos en Caliente\n          if (permit.anexoEnergias.trabajosEnCaliente && Object.keys(permit.anexoEnergias.trabajosEnCaliente).length > 0) {\n            checkPageBreak(20);\n            drawSubSectionTitle('6.3 Trabajos en Caliente');\n  \n            const trabajosCaliente = Object.entries(permit.anexoEnergias.trabajosEnCaliente)\n              .filter(([_, value]) => value === 'si' || value === true)\n              .map(([key]) => {\n                const label = key.replace(/([A-Z])/g, ' $1').toUpperCase();\n                if (key === 'otro' && typeof permit.anexoEnergias.trabajosEnCaliente?.otro === 'string') {\n                  return ['‚úì', `${label}: ${permit.anexoEnergias.trabajosEnCaliente.otro}`];\n                }\n                return ['‚úì', label];\n              });\n  \n            if (trabajosCaliente.length > 0) {\n              autoTable(doc, {\n                startY: yPos,\n                body: trabajosCaliente,\n                theme: 'grid',\n                styles: { fontSize: 7, cellPadding: 2 },\n                columnStyles: { 0: { cellWidth: 8, halign: 'center' } },\n              });\n              yPos = (doc as any).lastAutoTable.finalY + 5;\n            }\n          }\n  \n          // 6.4 Procedimiento LOTO\n          if (permit.anexoEnergias.procedimientoLOTO && Object.keys(permit.anexoEnergias.procedimientoLOTO).length > 0) {\n            checkPageBreak(25);\n            drawSubSectionTitle('6.4 Procedimiento LOTO (Lockout/Tagout)');\n  \n            const lotoRows = Object.entries(permit.anexoEnergias.procedimientoLOTO)\n              .filter(([_, value]) => value === 'si' || value === true)\n              .map(([key]) => [\n                '‚úì',\n                key\n                  .replace(/([A-Z])/g, ' $1')\n                  .trim()\n                  .toUpperCase(),\n              ]);\n  \n            if (lotoRows.length > 0) {\n              autoTable(doc, {\n                startY: yPos,\n                body: lotoRows,\n                theme: 'grid',\n                styles: { fontSize: 6, cellPadding: 1.5 },\n                columnStyles: { 0: { cellWidth: 8, halign: 'center' } },\n              });\n              yPos = (doc as any).lastAutoTable.finalY + 5;\n            }\n          }\n  \n          // 6.5 Sistema El√©ctrico (si aplica)\n          if (permit.anexoEnergias.sistemaElectrico?.tensionNominal) {\n            checkPageBreak(20);\n            drawSubSectionTitle('6.5 Informaci√≥n del Sistema El√©ctrico');\n  \n            autoTable(doc, {\n              startY: yPos,\n              body: [\n                [\n                  { content: 'Tensi√≥n Nominal del Sistema:', styles: { fontStyle: 'bold', fillColor: lightGray } },\n                  permit.anexoEnergias.sistemaElectrico.tensionNominal || 'N/A',\n                ],\n                [\n                  { content: 'Tensi√≥n a la que est√° Expuesto el Personal:', styles: { fontStyle: 'bold', fillColor: lightGray } },\n                  permit.anexoEnergias.sistemaElectrico.tensionPersonal || 'N/A',\n                ],\n                [\n                  { content: 'Distancia de Seguridad:', styles: { fontStyle: 'bold', fillColor: lightGray } },\n                  permit.anexoEnergias.sistemaElectrico.distanciaSeguridad || 'N/A',\n                ],\n              ],\n              theme: 'grid',\n              styles: { fontSize: 7, cellPadding: 2 },\n              columnStyles: { 0: { cellWidth: 70 } },\n            });\n            yPos = (doc as any).lastAutoTable.finalY + 5;\n          }\n  \n          // 6.6 Planeaci√≥n\n          if (permit.anexoEnergias.planeacion && Object.keys(permit.anexoEnergias.planeacion).length > 0) {\n            checkPageBreak(25);\n            drawSubSectionTitle('6.6 Planeaci√≥n de Trabajos con Energ√≠a El√©ctrica');\n  \n            const planeacionRows = Object.entries(permit.anexoEnergias.planeacion)\n              .filter(([_, value]) => value === 'si' || value === true)\n              .map(([key]) => [\n                '‚úì',\n                key\n                  .replace(/([A-Z])/g, ' $1')\n                  .trim()\n                  .toUpperCase(),\n              ]);\n  \n            if (planeacionRows.length > 0) {\n              autoTable(doc, {\n                startY: yPos,\n                body: planeacionRows,\n                theme: 'grid',\n                styles: { fontSize: 6, cellPadding: 1.5 },\n                columnStyles: { 0: { cellWidth: 8, halign: 'center' } },\n              });\n              yPos = (doc as any).lastAutoTable.finalY + 5;\n            }\n          }\n        }\n  \n        // ‚úÖ SECCI√ìN 7: ANEXO 4 - IZAJE DE CARGAS (si aplica)\n        if (permit.selectedWorkTypes?.izaje && permit.anexoIzaje) {\n          checkPageBreak(60);\n          drawSectionTitle('7. ANEXO 4 - IZAJE DE CARGAS');\n  \n          // 7.1 Informaci√≥n General del Izaje\n          drawSubSectionTitle('7.1 Informaci√≥n de la Carga y Equipo');\n  \n          autoTable(doc, {\n            startY: yPos,\n            body: [\n              [\n                { content: 'Acci√≥n a Realizar:', styles: { fontStyle: 'bold', fillColor: lightGray } },\n                Object.entries(permit.anexoIzaje.informacionGeneral.accion || {})\n                  .filter(([_, v]) => v)\n                  .map(([k]) => k.charAt(0).toUpperCase() + k.slice(1))\n                  .join(', ') || 'N/A',\n              ],\n              [\n                { content: 'Peso de la Carga:', styles: { fontStyle: 'bold', fillColor: lightGray } },\n                Object.entries(permit.anexoIzaje.informacionGeneral.pesoCarga || {})\n                  .filter(([_, v]) => v)\n                  .map(([k]) =>\n                    k\n                      .replace('menor', '< ')\n                      .replace('mas', '> ')\n                      .replace('entre', '')\n                  )\n                  .join(', ') + ' kg' || 'N/A',\n              ],\n              [\n                { content: 'Equipo a Utilizar:', styles: { fontStyle: 'bold', fillColor: lightGray } },\n                Object.entries(permit.anexoIzaje.informacionGeneral.equipoUtilizar || {})\n                  .filter(([_, v]) => v)\n                  .map(([k]) => k.replace(/([A-Z])/g, ' $1').toUpperCase())\n                  .join(', ') || 'N/A',\n              ],\n              [\n                { content: 'Capacidad del Equipo:', styles: { fontStyle: 'bold', fillColor: lightGray } },\n                permit.anexoIzaje.informacionGeneral.capacidadEquipo || 'N/A',\n              ],\n            ],\n            theme: 'grid',\n            styles: { fontSize: 7, cellPadding: 2 },\n            columnStyles: { 0: { cellWidth: 55 } },\n          });\n          yPos = (doc as any).lastAutoTable.finalY + 5;\n  \n          // 7.2 Aspectos Requeridos\n          if (permit.anexoIzaje.aspectosRequeridos && Object.keys(permit.anexoIzaje.aspectosRequeridos).length > 0) {\n            checkPageBreak(30);\n            drawSubSectionTitle('7.2 Aspectos Requeridos para el Izaje');\n  \n            const aspectosRows = Object.entries(permit.anexoIzaje.aspectosRequeridos)\n              .filter(([_, value]) => value === 'si' || value === true)\n              .map(([key]) => [\n                '‚úì',\n                key\n                  .replace(/([A-Z])/g, ' $1')\n                  .trim()\n                  .toUpperCase(),\n              ]);\n  \n            if (aspectosRows.length > 0) {\n              autoTable(doc, {\n                startY: yPos,\n                body: aspectosRows,\n                theme: 'grid',\n                styles: { fontSize: 6, cellPadding: 1.5 },\n                columnStyles: { 0: { cellWidth: 8, halign: 'center' } },\n              });\n              yPos = (doc as any).lastAutoTable.finalY + 5;\n            }\n          }\n  \n          // 7.3 Precauciones y Controles\n          if (permit.anexoIzaje.precauciones && Object.keys(permit.anexoIzaje.precauciones).length > 0) {\n            checkPageBreak(25);\n            drawSubSectionTitle('7.3 Precauciones y Controles');\n  \n            const precaucionesRows = Object.entries(permit.anexoIzaje.precauciones)\n              .filter(([_, value]) => value === 'si' || value === true)\n              .map(([key]) => [\n                '‚úì',\n                key\n                  .replace(/([A-Z])/g, ' $1')\n                  .trim()\n                  .toUpperCase(),\n              ]);\n  \n            if (precaucionesRows.length > 0) {\n              autoTable(doc, {\n                startY: yPos,\n                body: precaucionesRows,\n                theme: 'grid',\n                styles: { fontSize: 6, cellPadding: 1.5 },\n                columnStyles: { 0: { cellWidth: 8, halign: 'center' } },\n              });\n              yPos = (doc as any).lastAutoTable.finalY + 5;\n            }\n          }\n  \n          // 7.4 Validaci√≥n Diaria\n          if (permit.anexoIzaje.validacion?.responsable?.length || permit.anexoIzaje.validacion?.autoridad?.length) {\n            drawDailyValidationTable(permit.anexoIzaje.validacion, permitDuration, 'Izaje de Cargas');\n          }\n        }\n  \n        // ‚úÖ SECCI√ìN 8: ANEXO 5 - EXCAVACIONES (si aplica)\n        if (permit.selectedWorkTypes?.excavacion && permit.anexoExcavaciones) {\n          checkPageBreak(60);\n          drawSectionTitle('8. ANEXO 5 - EXCAVACIONES');\n  \n          // 8.1 Dimensiones de la Excavaci√≥n\n          drawSubSectionTitle('8.1 Dimensiones de la Excavaci√≥n');\n  \n          autoTable(doc, {\n            startY: yPos,\n            body: [\n              [\n                { content: 'Dimensiones Generales:', styles: { fontStyle: 'bold', fillColor: lightGray } },\n                permit.anexoExcavaciones.informacionGeneral.dimensiones || 'N/A',\n              ],\n              [\n                { content: 'Profundidad:', styles: { fontStyle: 'bold', fillColor: lightGray } },\n                permit.anexoExcavaciones.informacionGeneral.profundidad || 'N/A',\n              ],\n              [\n                { content: 'Ancho:', styles: { fontStyle: 'bold', fillColor: lightGray } },\n                permit.anexoExcavaciones.informacionGeneral.ancho || 'N/A',\n              ],\n              [\n                { content: 'Largo:', styles: { fontStyle: 'bold', fillColor: lightGray } },\n                permit.anexoExcavaciones.informacionGeneral.largo || 'N/A',\n              ],\n            ],\n            theme: 'grid',\n            styles: { fontSize: 7, cellPadding: 2 },\n            columnStyles: { 0: { cellWidth: 45 } },\n          });\n          yPos = (doc as any).lastAutoTable.finalY + 5;\n  \n          // 8.2 Aspectos Requeridos\n          if (permit.anexoExcavaciones.aspectosRequeridos && Object.keys(permit.anexoExcavaciones.aspectosRequeridos).length > 0) {\n            checkPageBreak(30);\n            drawSubSectionTitle('8.2 Aspectos Requeridos para la Excavaci√≥n');\n  \n            const aspectosExcRows = Object.entries(permit.anexoExcavaciones.aspectosRequeridos)\n              .filter(([_, value]) => value === 'si' || value === true)\n              .map(([key]) => [\n                '‚úì',\n                key\n                  .replace(/([A-Z])/g, ' $1')\n                  .trim()\n                  .toUpperCase(),\n              ]);\n  \n            if (aspectosExcRows.length > 0) {\n              autoTable(doc, {\n                startY: yPos,\n                body: aspectosExcRows,\n                theme: 'grid',\n                styles: { fontSize: 6, cellPadding: 1.5 },\n                columnStyles: { 0: { cellWidth: 8, halign: 'center' } },\n              });\n              yPos = (doc as any).lastAutoTable.finalY + 5;\n            }\n          }\n  \n          // 8.3 Precauciones y Controles\n          if (permit.anexoExcavaciones.precauciones && Object.keys(permit.anexoExcavaciones.precauciones).length > 0) {\n            checkPageBreak(25);\n            drawSubSectionTitle('8.3 Precauciones y Controles');\n  \n            const precaucionesExcRows = Object.entries(permit.anexoExcavaciones.precauciones)\n              .filter(([_, value]) => value === 'si' || value === true)\n              .map(([key]) => [\n                '‚úì',\n                key\n                  .replace(/([A-Z])/g, ' $1')\n                  .trim()\n                  .toUpperCase(),\n              ]);\n  \n            if (precaucionesExcRows.length > 0) {\n              autoTable(doc, {\n                startY: yPos,\n                body: precaucionesExcRows,\n                theme: 'grid',\n                styles: { fontSize: 6, cellPadding: 1.5 },\n                columnStyles: { 0: { cellWidth: 8, halign: 'center' } },\n              });\n              yPos = (doc as any).lastAutoTable.finalY + 5;\n            }\n          }\n  \n          // 8.4 Validaci√≥n Diaria\n          if (permit.anexoExcavaciones.validacion?.responsable?.length || permit.anexoExcavaciones.validacion?.autoridad?.length) {\n            drawDailyValidationTable(permit.anexoExcavaciones.validacion, permitDuration, 'Excavaciones');\n          }\n        }\n  \n        // Continuar√° en la siguiente parte con FIRMAS Y CIERRE...\n      // ‚úÖ SECCI√ìN 9: AUTORIZACIONES Y FIRMAS DE APERTURA\n      checkPageBreak(80);\n      drawSectionTitle('9. AUTORIZACIONES Y FIRMAS DE APERTURA');\n\n      const sigBoxW = (pageWidth - 2 * margin) / 2;\n      const sigBoxH = 40;\n      let currentY = yPos;\n\n      // Fila 1: Coordinador de Alturas (si aplica) y Solicitante\n      if (permit.approvals?.coordinador_alturas) {\n        drawSignatureBox('COORDINADOR DE TRABAJOS EN ALTURAS', permit.approvals.coordinador_alturas, margin, currentY, sigBoxW, sigBoxH);\n        drawSignatureBox('QUIEN SOLICITA (L√çDER DEL EQUIPO)', permit.approvals.solicitante, margin + sigBoxW, currentY, sigBoxW, sigBoxH);\n        currentY += sigBoxH + 3;\n      } else {\n        // Solo solicitante ocupa toda la fila\n        drawSignatureBox('QUIEN SOLICITA (L√çDER DEL EQUIPO)', permit.approvals?.solicitante, margin, currentY, pageWidth - 2 * margin, sigBoxH);\n        currentY += sigBoxH + 3;\n      }\n\n      // Fila 2: Autorizante y L√≠der SST\n      checkPageBreak(sigBoxH + 5);\n      drawSignatureBox('QUIEN AUTORIZA (JEFE/DUE√ëO DE √ÅREA)', permit.approvals?.autorizante, margin, currentY, sigBoxW, sigBoxH);\n      drawSignatureBox('L√çDER SST', permit.approvals?.lider_sst, margin + sigBoxW, currentY, sigBoxW, sigBoxH);\n      currentY += sigBoxH + 3;\n\n      // Fila 3: Mantenimiento (si aplica)\n      if (permit.approvals?.mantenimiento) {\n        checkPageBreak(sigBoxH + 5);\n        drawSignatureBox('MANTENIMIENTO', permit.approvals.mantenimiento, margin, currentY, pageWidth - 2 * margin, sigBoxH);\n        currentY += sigBoxH + 3;\n      }\n\n      yPos = currentY;\n\n      // ‚úÖ SECCI√ìN 10: FIRMAS DE TRABAJADORES\n      if (permit.workers && permit.workers.length > 0) {\n        checkPageBreak(50);\n        drawSectionTitle('10. FIRMAS DE TRABAJADORES');\n\n        // 10.1 Firmas de Apertura\n        drawSubSectionTitle('10.1 Firmas de Apertura de Trabajadores');\n\n        const workerSignaturesApertura = permit.workers.filter((w) => w.firmaApertura);\n\n        if (workerSignaturesApertura.length > 0) {\n          // Crear grid de firmas (3 por fila)\n          const signaturesPerRow = 3;\n          const workerSigBoxW = (pageWidth - 2 * margin) / signaturesPerRow;\n          const workerSigBoxH = 35;\n\n          for (let i = 0; i < workerSignaturesApertura.length; i += signaturesPerRow) {\n            checkPageBreak(workerSigBoxH + 5);\n\n            for (let j = 0; j < signaturesPerRow && i + j < workerSignaturesApertura.length; j++) {\n              const worker = workerSignaturesApertura[i + j];\n              const x = margin + j * workerSigBoxW;\n\n              doc.rect(x, yPos, workerSigBoxW, workerSigBoxH);\n              doc.setFontSize(6);\n              doc.setFont('helvetica', 'bold');\n              doc.text(worker.nombre.substring(0, 25), x + 2, yPos + 4);\n              doc.setFont('helvetica', 'normal');\n              doc.setFontSize(5);\n              doc.text(`C.C. ${worker.cedula}`, x + 2, yPos + 8);\n\n              if (worker.firmaApertura) {\n                try {\n                  doc.addImage(worker.firmaApertura, 'PNG', x + workerSigBoxW / 2 - 15, yPos + 10, 30, 12);\n                } catch (e) {\n                  console.error('Error a√±adiendo firma de trabajador:', e);\n                }\n              }\n\n              doc.setFontSize(5);\n              doc.text('Firma Apertura', x + 2, yPos + workerSigBoxH - 2);\n            }\n\n            yPos += workerSigBoxH + 3;\n          }\n        } else {\n          autoTable(doc, {\n            startY: yPos,\n            body: [['No hay firmas de apertura registradas']],\n            theme: 'grid',\n            styles: { fontSize: 7, cellPadding: 3, fontStyle: 'italic', textColor: darkGray },\n          });\n          yPos = (doc as any).lastAutoTable.finalY + 5;\n        }\n\n        // 10.2 Firmas de Cierre\n        checkPageBreak(50);\n        drawSubSectionTitle('10.2 Firmas de Cierre de Trabajadores');\n\n        const workerSignaturesCierre = permit.workers.filter((w) => w.firmaCierre);\n\n        if (workerSignaturesCierre.length > 0) {\n          const signaturesPerRow = 3;\n          const workerSigBoxW = (pageWidth - 2 * margin) / signaturesPerRow;\n          const workerSigBoxH = 35;\n\n          for (let i = 0; i < workerSignaturesCierre.length; i += signaturesPerRow) {\n            checkPageBreak(workerSigBoxH + 5);\n\n            for (let j = 0; j < signaturesPerRow && i + j < workerSignaturesCierre.length; j++) {\n              const worker = workerSignaturesCierre[i + j];\n              const x = margin + j * workerSigBoxW;\n\n              doc.rect(x, yPos, workerSigBoxW, workerSigBoxH);\n              doc.setFontSize(6);\n              doc.setFont('helvetica', 'bold');\n              doc.text(worker.nombre.substring(0, 25), x + 2, yPos + 4);\n              doc.setFont('helvetica', 'normal');\n              doc.setFontSize(5);\n              doc.text(`C.C. ${worker.cedula}`, x + 2, yPos + 8);\n\n              if (worker.firmaCierre) {\n                try {\n                  doc.addImage(worker.firmaCierre, 'PNG', x + workerSigBoxW / 2 - 15, yPos + 10, 30, 12);\n                } catch (e) {\n                  console.error('Error a√±adiendo firma de cierre de trabajador:', e);\n                }\n              }\n\n              doc.setFontSize(5);\n              doc.text('Firma Cierre', x + 2, yPos + workerSigBoxH - 2);\n            }\n\n            yPos += workerSigBoxH + 3;\n          }\n        } else {\n          autoTable(doc, {\n            startY: yPos,\n            body: [['No hay firmas de cierre registradas']],\n            theme: 'grid',\n            styles: { fontSize: 7, cellPadding: 3, fontStyle: 'italic', textColor: darkGray },\n          });\n          yPos = (doc as any).lastAutoTable.finalY + 5;\n        }\n      }\n\n      // ‚úÖ SECCI√ìN 11: CIERRE O CANCELACI√ìN DEL PERMISO (si aplica)\n      if (permit.closure?.terminado || permit.closure?.cancelado) {\n        checkPageBreak(80);\n\n        if (permit.closure.cancelado) {\n          drawSectionTitle('11. CANCELACI√ìN DEL PERMISO');\n\n          autoTable(doc, {\n            startY: yPos,\n            body: [\n              [\n                { content: 'PERMISO CANCELADO', colSpan: 2, styles: { fillColor: [255, 200, 200], fontStyle: 'bold', halign: 'center' } },\n              ],\n              [\n                { content: 'Raz√≥n de Cancelaci√≥n:', styles: { fontStyle: 'bold', fillColor: lightGray } },\n                permit.closure.razonCancelacion || 'No especificado',\n              ],\n              [\n                { content: 'Cancelado por:', styles: { fontStyle: 'bold', fillColor: lightGray } },\n                permit.closure.canceladoPor?.nombre || 'N/A',\n              ],\n              [\n                { content: 'Fecha de Cancelaci√≥n:', styles: { fontStyle: 'bold', fillColor: lightGray } },\n                safeFormat(permit.closure.canceladoPor?.fecha, 'dd/MM/yy HH:mm'),\n              ],\n            ],\n            theme: 'grid',\n            styles: { fontSize: 7, cellPadding: 3 },\n            columnStyles: { 0: { cellWidth: 55 } },\n          });\n          yPos = (doc as any).lastAutoTable.finalY + 5;\n\n          // Firma de cancelaci√≥n\n          if (permit.closure.canceladoPor?.firma) {\n            checkPageBreak(40);\n            drawSubSectionTitle('Firma de Cancelaci√≥n');\n            drawSignatureBox('CANCELADO POR', permit.closure.canceladoPor, margin, yPos, pageWidth - 2 * margin, 35);\n            yPos += 38;\n          }\n        } else {\n          drawSectionTitle('11. CIERRE DEL PERMISO');\n\n          autoTable(doc, {\n            startY: yPos,\n            body: [\n              [\n                { content: 'PERMISO CERRADO EXITOSAMENTE', colSpan: 2, styles: { fillColor: [200, 255, 200], fontStyle: 'bold', halign: 'center' } },\n              ],\n              [\n                { content: 'Observaciones de Cierre:', styles: { fontStyle: 'bold', fillColor: lightGray } },\n                permit.closure.observacionesCierre || 'Sin observaciones',\n              ],\n            ],\n            theme: 'grid',\n            styles: { fontSize: 7, cellPadding: 3 },\n            columnStyles: { 0: { cellWidth: 55 } },\n          });\n          yPos = (doc as any).lastAutoTable.finalY + 5;\n\n          // Firmas de cierre\n          checkPageBreak(50);\n          drawSubSectionTitle('Firmas de Cierre del Permiso');\n\n          const closureSigBoxW = (pageWidth - 2 * margin) / 2;\n          const closureSigBoxH = 40;\n\n          drawSignatureBox('RESPONSABLE DEL TRABAJO', permit.closure.responsable, margin, yPos, closureSigBoxW, closureSigBoxH);\n          drawSignatureBox('AUTORIDAD DEL √ÅREA', permit.closure.autoridad, margin + closureSigBoxW, yPos, closureSigBoxW, closureSigBoxH);\n\n          yPos += closureSigBoxH + 5;\n        }\n      }\n\n      // ===== PIE DE P√ÅGINA EN TODAS LAS P√ÅGINAS =====\n      const totalPages = (doc as any).internal.getNumberOfPages();\n      for (let i = 1; i <= totalPages; i++) {\n        doc.setPage(i);\n        doc.setFontSize(7);\n        doc.setTextColor(150, 150, 150);\n        doc.text(\n          `P√°gina ${i} de ${totalPages} | Documento: DN-FR-SST-016 V04 | Permiso N¬∞ ${permit.number || permit.id.substring(0, 8)}`,\n          pageWidth / 2,\n          pageHeight - 5,\n          { align: 'center' }\n        );\n      }\n\n      // ===== GUARDAR PDF =====\n      doc.save(`Permiso_Trabajo_${permit.number || permit.id.substring(0, 8)}_${safeFormat(new Date(), 'ddMMyyyy')}.pdf`);\n\n      toast({\n        title: 'PDF Generado Exitosamente',\n        description: 'El documento ha sido descargado correctamente.',\n        className: 'bg-green-100 dark:bg-green-900',\n      });\n    } catch (error: any) {\n      console.error('Error al generar el PDF:', error);\n      toast({\n        variant: 'destructive',\n        title: 'Error al Generar PDF',\n        description: error.message || 'No se pudo generar el PDF. Por favor, intente nuevamente.',\n      });\n    }\n  }; // ‚Üê CIERRE DE handleExportToPDF\n  // ===== FUNCIONES DE FIRMAS Y VALIDACIONES (mantener l√≥gica existente) =====\n  \n  const openSignatureDialog = (role: SignatureRole | 'cierre_autoridad' | 'cierre_responsable' | 'cancelacion', signatureType: 'firmaApertura' | 'firmaCierre') => {\n    if (!currentUser) return;\n    setSigningRole({ role, type: signatureType });\n    setSignatureObservation('');\n    if (role === 'coordinador_alturas' || role.startsWith('cierre') || role === 'cancelacion') {\n      setSignerName('');\n    } else {\n      setSignerName(currentUser?.displayName || '');\n    }\n    setIsSignatureDialogOpen(true);\n  };\n\n  const handleSaveSignature = async (signatureDataUrl: string) => {\n    if (!permit || !currentUser || !signingRole) return;\n\n    const isSpecialSignature = signingRole.role === 'coordinador_alturas' || signingRole.role.startsWith('cierre') || signingRole.role === 'cancelacion';\n\n    if (isSpecialSignature && !signerName.trim()) {\n      toast({\n        variant: 'destructive',\n        title: 'Nombre Requerido',\n        description: 'Por favor, ingrese el nombre.',\n      });\n      return;\n    }\n\n    setIsSigning(true);\n    try {\n      const simpleUser = {\n        uid: currentUser.uid,\n        displayName: isSpecialSignature ? signerName : currentUser.displayName || null,\n        role: currentUser.role,\n        empresa: currentUser.empresa || 'N/A',\n      };\n\n      const result = await addSignatureAndNotify(permit.id, signingRole.role, signingRole.type, signatureDataUrl, simpleUser, signatureObservation);\n\n      if (result.success) {\n        toast({\n          title: 'Firma Registrada',\n          description: `${simpleUser.displayName} ha firmado exitosamente.`,\n        });\n        setIsSignatureDialogOpen(false);\n        setSigningRole(null);\n        setSignerName('');\n        setSignatureObservation('');\n      } else {\n        throw new Error(result.error || 'No se pudo guardar la firma.');\n      }\n    } catch (e: any) {\n      toast({\n        variant: 'destructive',\n        title: 'Error al firmar',\n        description: e.message || 'Ocurri√≥ un error inesperado.',\n      });\n    } finally {\n      setIsSigning(false);\n    }\n  };\n\n  const handleChangeStatus = async (newStatus: PermitStatus, reason?: string) => {\n    if (!permit || !currentUser || !currentUser.role) return;\n\n    setIsStatusChanging(true);\n    try {\n      const result = await updatePermitStatus(\n        permit.id,\n        newStatus,\n        { uid: currentUser.uid, displayName: currentUser.displayName, role: currentUser.role },\n        reason\n      );\n\n      if (result.success) {\n        toast({\n          title: 'Estado Actualizado',\n          description: `El permiso ahora est√° ${getStatusInfo(newStatus).text}.`,\n          className: 'bg-green-100 dark:bg-green-900',\n        });\n        if (isRejectionDialogOpen) setIsRejectionDialogOpen(false);\n        if (rejectionReason) setRejectionReason('');\n        if (isClosureDialogOpen) setIsClosureDialogOpen(false);\n        if (isCancellationDialogOpen) setIsCancellationDialogOpen(false);\n      } else {\n        throw new Error(result.error || 'No se pudo actualizar el estado.');\n      }\n    } catch (error: any) {\n      toast({\n        variant: 'destructive',\n        title: 'Error al actualizar',\n        description: error.message,\n      });\n    } finally {\n      setIsStatusChanging(false);\n    }\n  };\n\n  // Funci√≥n para abrir el di√°logo de validaci√≥n diaria\n  const openDailyValidationSignatureDialog = (anexo: string, type: 'autoridad' | 'responsable', index: number) => {\n    if (!currentUser) return;\n    setDailyValidationTarget({ anexo, type, index });\n    setDailyValidationName('');\n    setDailyValidationDate(new Date().toISOString().slice(0, 16));\n    setIsDailyValidationSignatureOpen(true);\n  };\n\n  // Funci√≥n para guardar validaci√≥n diaria\n  const handleSaveDailyValidationSignature = async (signature: string) => {\n    if (!permit || !dailyValidationTarget || !dailyValidationName.trim() || !dailyValidationDate || !currentUser) {\n      toast({\n        variant: 'destructive',\n        title: 'Faltan datos',\n        description: 'Por favor, complete nombre y fecha.',\n      });\n      return;\n    }\n\n    setIsDailyValidationSigning(true);\n    try {\n      const result = await addDailyValidationSignature(\n        permit.id,\n        dailyValidationTarget.anexo,\n        dailyValidationTarget.type,\n        dailyValidationTarget.index,\n        {\n          nombre: dailyValidationName,\n          fecha: dailyValidationDate,\n          firma: signature,\n        },\n        {\n          uid: currentUser.uid,\n          displayName: currentUser.displayName || null,\n          role: currentUser.role,\n          empresa: currentUser.empresa || 'N/A',\n        }\n      );\n\n      if (result.success) {\n        toast({\n          title: 'Validaci√≥n Registrada',\n          description: 'La validaci√≥n diaria ha sido guardada exitosamente.',\n        });\n        setIsDailyValidationSignatureOpen(false);\n        setDailyValidationTarget(null);\n        setDailyValidationName('');\n        setDailyValidationDate('');\n      } else {\n        throw new Error(result.error || 'No se pudo guardar la validaci√≥n.');\n      }\n    } catch (e: any) {\n      toast({\n        variant: 'destructive',\n        title: 'Error',\n        description: e.message || 'Ocurri√≥ un error al guardar la validaci√≥n.',\n      });\n    } finally {\n      setIsDailyValidationSigning(false);\n    }\n  };\n\n  // Componente para tabla de validaci√≥n diaria\n  const DailyValidationTable: React.FC<{\n    anexoName: string;\n    validationData?: { autoridad?: ValidacionDiaria[]; responsable?: ValidacionDiaria[] };\n  }> = ({ anexoName, validationData }) => {\n    let durationInDays = 1;\n\n    if (permit.generalInfo?.validFrom && permit.generalInfo?.validUntil) {\n      try {\n        const startDate = parseISO(permit.generalInfo.validFrom);\n        const endDate = parseISO(permit.generalInfo.validUntil);\n        durationInDays = differenceInCalendarDays(endDate, startDate) + 1;\n      } catch (e) {\n        console.error('Error parsing dates for daily validation', e);\n      }\n    }\n\n    const renderRows = (type: 'responsable' | 'autoridad') => {\n      return Array.from({ length: durationInDays }, (_, i) => {\n        const v = validationData?.[type]?.[i];\n        \n        // L√ìGICA CORREGIDA DE PERMISOS\n        let canSignValidation = false;\n        let tooltipContent = 'No tienes permiso para firmar.';\n\n        // Solo se puede firmar si el permiso est√° en ejecuci√≥n o suspendido\n        if (permit.status !== 'en_ejecucion' && permit.status !== 'suspendido') {\n          tooltipContent = 'El permiso debe estar en ejecuci√≥n para firmar validaciones diarias.';\n        } else if (v?.firma) {\n          tooltipContent = 'Esta validaci√≥n ya ha sido firmada.';\n        } else {\n          // Verificar permisos seg√∫n el tipo\n          if (type === 'autoridad') {\n            canSignValidation = currentUser?.role === 'autorizante' || currentUser?.role === 'admin';\n            tooltipContent = canSignValidation \n              ? 'Haz clic para firmar la validaci√≥n diaria' \n              : 'Solo Autorizantes o Administradores pueden firmar como Autoridad.';\n          } else if (type === 'responsable') {\n            canSignValidation = \n              currentUser?.uid === permit.createdBy || \n              currentUser?.role === 'lider_tarea' || \n              currentUser?.role === 'admin';\n            tooltipContent = canSignValidation \n              ? 'Haz clic para firmar la validaci√≥n diaria' \n              : 'Solo el Responsable del Trabajo, L√≠der de Tarea o Admin pueden firmar.';\n          }\n        }\n\n        return (\n          <TableRow key={`${type}-${i}`}>\n            <TableCell className=\"text-center font-semibold\">{i + 1}</TableCell>\n            <TableCell>{v?.nombre || 'N/A'}</TableCell>\n            <TableCell>\n              {v?.firma ? (\n                <div className=\"flex items-center gap-2\">\n                  <Image src={v.firma} alt=\"Firma\" width={60} height={30} className=\"border rounded\" />\n                  <Badge variant=\"outline\" className=\"bg-green-50 text-green-700 border-green-300 text-xs\">\n                    <CheckCircle size={10} className=\"mr-1\" />\n                    Firmado\n                  </Badge>\n                </div>\n              ) : permit.status === 'en_ejecucion' || permit.status === 'suspendido' ? (\n                <TooltipProvider>\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        onClick={() => openDailyValidationSignatureDialog(anexoName, type, i)}\n                        disabled={!canSignValidation}\n                        className=\"h-8 w-8\"\n                      >\n                        <SignatureIcon className={`h-4 w-4 ${canSignValidation ? 'text-primary' : 'text-gray-400'}`} />\n                      </Button>\n                    </TooltipTrigger>\n                    <TooltipContent><p>{tooltipContent}</p></TooltipContent>\n                  </Tooltip>\n                </TooltipProvider>\n              ) : (\n                <Badge variant=\"outline\" className=\"text-gray-500 text-xs\">\n                  Pendiente\n                </Badge>\n              )}\n            </TableCell>\n            <TableCell className=\"text-xs\">{safeFormat(v?.fecha, 'dd/MM/yy HH:mm')}</TableCell>\n          </TableRow>\n        );\n      });\n    };\n\n    return (\n      <Section title=\"Validaci√≥n Diaria\">\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n          {/* Responsable del Trabajo */}\n          <div className=\"p-4 border rounded-lg space-y-2\">\n            <h4 className=\"font-semibold flex items-center gap-2\">\n              <UserCheck size={16} className=\"text-blue-600\" />\n              Responsable del Trabajo\n            </h4>\n            <p className=\"text-xs text-muted-foreground\">\n              Entiendo las condiciones y responsabilidad del trabajo a ejecutar.\n            </p>\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead className=\"text-center w-12\">D√≠a</TableHead>\n                  <TableHead>Nombre</TableHead>\n                  <TableHead className=\"text-center\">Firma</TableHead>\n                  <TableHead className=\"text-center\">Fecha</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>{renderRows('responsable')}</TableBody>\n            </Table>\n          </div>\n\n          {/* Autoridad del √Årea */}\n          <div className=\"p-4 border rounded-lg space-y-2\">\n            <h4 className=\"font-semibold flex items-center gap-2\">\n              <ShieldCheck size={16} className=\"text-green-600\" />\n              Autoridad del √Årea\n            </h4>\n            <p className=\"text-xs text-muted-foreground\">\n              Autorizo la ejecuci√≥n del trabajo bajo las condiciones verificadas.\n            </p>\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead className=\"text-center w-12\">D√≠a</TableHead>\n                  <TableHead>Nombre</TableHead>\n                  <TableHead className=\"text-center\">Firma</TableHead>\n                  <TableHead className=\"text-center\">Fecha</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>{renderRows('autoridad')}</TableBody>\n            </Table>\n          </div>\n        </div>\n      </Section>\n    );\n  };\n\n  // ===== RENDERIZADO DEL COMPONENTE =====\n\n  if (loading || userLoading) {\n    return (\n      <div className=\"flex h-screen items-center justify-center\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n        <p className=\"ml-4 text-lg\">Cargando detalles del permiso...</p>\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <div className=\"flex flex-col h-screen items-center justify-center text-center p-4\">\n        <XCircle className=\"h-16 w-16 text-destructive mb-4\" />\n        <h2 className=\"text-2xl font-bold mb-2\">Error al Cargar el Permiso</h2>\n        <p className=\"text-muted-foreground mb-6\">{error}</p>\n        <Button onClick={() => router.back()}>\n          <ArrowLeft className=\"mr-2 h-4 w-4\" />\n          Volver\n        </Button>\n      </div>\n    );\n  }\n\n  if (!permit) return null;\n\n  const statusInfo = getStatusInfo(permit.status);\n\n  // Helper para tipos de trabajo\n  const getWorkTypesStringDisplay = (permit: Permit): string[] => {\n    const workTypes: string[] = [];\n    if (!permit.selectedWorkTypes) return ['Trabajo General'];\n    if (permit.selectedWorkTypes.alturas) workTypes.push('Trabajo en Alturas');\n    if (permit.selectedWorkTypes.confinado) workTypes.push('Espacios Confinados');\n    if (permit.selectedWorkTypes.energia) workTypes.push('Control de Energ√≠as');\n    if (permit.selectedWorkTypes.izaje) workTypes.push('Izaje de Cargas');\n    if (permit.selectedWorkTypes.excavacion) workTypes.push('Excavaciones');\n    if (permit.selectedWorkTypes.general) workTypes.push('Trabajo General');\n    return workTypes.length > 0 ? workTypes : ['Trabajo General'];\n  };\n\n  const atsPeligrosAgrupados = atsPeligros.reduce((acc, peligro) => {\n    if (!acc[peligro.seccion]) acc[peligro.seccion] = [];\n    acc[peligro.seccion].push(peligro);\n    return acc;\n  }, {} as { [key: string]: typeof atsPeligros });\n\n  return (\n    <div className=\"flex flex-1 flex-col bg-gray-50 min-h-screen\">\n      {/* HEADER CON ACCIONES */}\n      <div className=\"bg-white p-4 md:p-6 shadow-md sticky top-0 z-10 border-b-2 border-primary/10\">\n        <div className=\"flex flex-wrap items-center justify-between gap-4 mb-4\">\n          <Button variant=\"outline\" onClick={() => router.back()} className=\"flex items-center gap-2\">\n            <ArrowLeft className=\"h-4 w-4\" />\n            <span className=\"hidden sm:inline\">Volver a la Lista</span>\n          </Button>\n\n          <div className=\"flex items-center gap-3\">\n            <div className={`flex items-center gap-2 rounded-lg p-2 px-4 ${statusInfo.bgColor}`}>\n              <statusInfo.icon className={`h-6 w-6 ${statusInfo.color}`} />\n              <span className={`font-bold text-sm ${statusInfo.color}`}>{statusInfo.text}</span>\n            </div>\n          </div>\n\n          <div className=\"flex gap-2\">\n            <Button variant=\"outline\" onClick={handleExportToPDF} className=\"flex items-center gap-2\">\n              <FileDown className=\"h-4 w-4\" />\n              <span className=\"hidden sm:inline\">Exportar PDF</span>\n            </Button>\n          </div>\n        </div>\n\n        {/* RESUMEN EJECUTIVO EN HEADER */}\n        <Card className=\"bg-gradient-to-r from-primary/5 to-primary/10 border-primary/20\">\n          <CardContent className=\"p-4\">\n            <div className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 text-sm\">\n              <Field\n                label=\"N¬∞ Permiso\"\n                value={<span className=\"font-bold text-primary text-base\">{permit.number || permit.id.substring(0, 8)}</span>}\n              />\n              <Field label=\"Solicitante\" value={permit.user?.displayName} icon={<UserCheck size={12} />} />\n              <Field label=\"Empresa\" value={permit.generalInfo?.empresa} icon={<Building size={12} />} />\n              <Field label=\"Planta\" value={permit.generalInfo?.planta} icon={<Factory size={12} />} />\n              <Field label=\"Proceso\" value={permit.generalInfo?.proceso} icon={<Package size={12} />} />\n              <Field label=\"Fecha Creaci√≥n\" value={safeFormat(permit.createdAt, 'dd/MM/yy HH:mm')} icon={<Calendar size={12} />} />\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* CONTENIDO PRINCIPAL */}\n      <main className=\"p-4 md:p-6 lg:p-8 max-w-7xl mx-auto w-full\">\n        <div className=\"bg-white p-6 md:p-8 rounded-2xl shadow-lg space-y-8\">\n          {/* ===== SECCI√ìN 1: INFORMACI√ìN GENERAL COMPLETA ===== */}\n          <Section title=\"Informaci√≥n General del Permiso\" icon={<FileText size={20} />}>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n              <Field label=\"√Årea Espec√≠fica\" value={permit.generalInfo?.areaEspecifica} icon={<MapPin size={12} />} />\n              <Field label=\"Contrato\" value={permit.generalInfo?.contrato} icon={<Briefcase size={12} />} />\n              <Field label=\"N¬∞ Trabajadores\" value={permit.generalInfo?.numTrabajadores || permit.workers?.length} icon={<Users size={12} />} />\n              <Field\n                label=\"Validez Desde\"\n                value={\n                  <span className=\"text-green-700 font-semibold\">\n                    {safeFormat(permit.generalInfo?.validFrom, \"EEEE, dd 'de' MMMM 'de' yyyy - HH:mm\")}\n                  </span>\n                }\n                icon={<Clock size={12} />}\n              />\n              <Field\n                label=\"Validez Hasta\"\n                value={\n                  <span className=\"text-red-700 font-semibold\">\n                    {safeFormat(permit.generalInfo?.validUntil, \"EEEE, dd 'de' MMMM 'de' yyyy - HH:mm\")}\n                  </span>\n                }\n                icon={<Clock size={12} />}\n              />\n              <Field\n                label=\"Responsable del Trabajo\"\n                value={`${permit.generalInfo?.responsable?.nombre || 'N/A'} (${permit.generalInfo?.responsable?.cargo || 'N/A'})`}\n                icon={<UserCheck size={12} />}\n              />\n            </div>\n\n            <Separator className=\"my-4\" />\n\n            <div className=\"space-y-2\">\n              <p className=\"text-xs font-semibold text-muted-foreground uppercase flex items-center gap-2\">\n                <Briefcase size={12} />\n                Tipos de Trabajo Seleccionados\n              </p>\n              <div className=\"flex flex-wrap gap-2\">\n                {getWorkTypesStringDisplay(permit).map((type, idx) => (\n                  <Badge key={idx} variant=\"default\" className=\"text-sm py-1.5 px-3\">\n                    {type}\n                  </Badge>\n                ))}\n              </div>\n            </div>\n\n            <Separator className=\"my-4\" />\n\n            <div className=\"space-y-2\">\n              <p className=\"text-xs font-semibold text-muted-foreground uppercase flex items-center gap-2\">\n                <FileText size={12} />\n                Descripci√≥n de la Tarea / Alcance\n              </p>\n              <div className=\"bg-gray-50 p-4 rounded-lg border\">\n                <p className=\"text-sm whitespace-pre-wrap text-gray-700\">{permit.generalInfo?.workDescription || 'No especificado'}</p>\n              </div>\n            </div>\n\n            <Separator className=\"my-4\" />\n\n            <div className=\"space-y-2\">\n              <p className=\"text-xs font-semibold text-muted-foreground uppercase flex items-center gap-2\">\n                <Wrench size={12} />\n                Herramientas y Equipos ({permit.generalInfo?.tools?.length || 0})\n              </p>\n              <div className=\"flex flex-wrap gap-2\">\n                {permit.generalInfo?.tools && permit.generalInfo.tools.length > 0 ? (\n                  permit.generalInfo.tools.map((tool, idx) => (\n                    <Badge key={idx} variant=\"outline\" className=\"text-xs\">\n                      <Wrench size={10} className=\"mr-1\" />\n                      {tool.name}\n                    </Badge>\n                  ))\n                ) : (\n                  <span className=\"text-muted-foreground italic text-sm\">Ninguna herramienta especificada</span>\n                )}\n              </div>\n            </div>\n          </Section>\n\n          {/* ===== SECCI√ìN 2: ATS COMPLETO ===== */}\n          {permit.anexoATS && (\n            <Collapsible defaultOpen>\n              <CollapsibleTrigger className=\"flex w-full items-center justify-between rounded-lg border-2 border-orange-200 bg-white hover:bg-gray-50 px-4 py-4 text-left font-semibold transition-colors shadow-sm\">\n                <div className=\"flex items-center gap-2\">\n                  <Shield className=\"h-5 w-5 text-orange-600\" />\n                  <span>An√°lisis de Trabajo Seguro (ATS)</span>\n                </div>\n                <ChevronDown className=\"h-5 w-5 text-orange-600 transition-transform data-[state=open]:rotate-180\" />\n              </CollapsibleTrigger>\n              <CollapsibleContent className=\"border-2 border-t-0 border-orange-200 rounded-b-lg bg-white p-6 space-y-6\">\n                {/* 2.1 Peligros Identificados */}\n                <div>\n                  <h4 className=\"text-sm font-bold text-orange-600 mb-3 flex items-center gap-2\">\n                    <AlertTriangle className=\"h-4 w-4\" />\n                    1. Identificaci√≥n de Peligros, Riesgos y Controles\n                  </h4>\n                  <div className=\"space-y-4 pl-6\">\n                    {Object.entries(atsPeligrosAgrupados).map(([seccion, peligros]) => (\n                      <div key={seccion}>\n                        <h5 className=\"font-semibold text-gray-700 mb-2 text-sm bg-orange-50 p-2 rounded\">{seccion}</h5>\n                        <div className=\"pl-4 space-y-1 border-l-2 border-orange-200\">\n                          {peligros.map((peligro) => (\n                            <RadioCheck key={peligro.id} label={peligro.label} value={(permit.anexoATS?.peligros as any)?.[peligro.id]} />\n                          ))}\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n\n                <Separator />\n\n                {/* 2.2 EPP Requeridos */}\n                <div>\n                  <h4 className=\"text-sm font-bold text-orange-600 mb-3 flex items-center gap-2\">\n                    <HardHat className=\"h-4 w-4\" />\n                    2. EPP Requeridos\n                  </h4>\n                  <div className=\"pl-6\">\n                    {eppOptions.map((category, categoryIdx) => {\n                      const categoryItems = category.filter((item) => {\n                        const value = (permit.anexoATS?.epp as any)?.[item.id];\n                        return value === true || value === 'si';\n                      });\n\n                      if (categoryItems.length === 0) return null;\n\n                      const categoryTitle =\n                        categoryIdx === 0\n                          ? 'Protecci√≥n Cabeza, Visual, Auditiva y Respiratoria'\n                          : categoryIdx === 1\n                          ? 'Protecci√≥n Corporal, Manos y Pies'\n                          : 'Protecci√≥n Contra Ca√≠das y Equipos Especiales';\n\n                      return (\n                        <div key={categoryIdx} className=\"mb-4\">\n                          <h5 className=\"font-semibold text-gray-600 mb-2 text-sm bg-orange-50 p-2 rounded\">{categoryTitle}</h5>\n                          <div className=\"pl-4 space-y-1 border-l-2 border-orange-200\">\n                            {categoryItems.map((item) => {\n                              let spec: string | undefined;\n                              const eppData = permit.anexoATS?.epp as any;\n\n                              if (item.type === 'text') {\n                                spec = eppData[`${item.id}_spec`];\n                              } else if (item.type === 'select') {\n                                spec = eppData[`${item.id}_tipo`];\n                              } else if (item.type === 'custom_casco') {\n                                spec = [eppData.casco_seguridad_tipo, eppData.casco_seguridad_clase, eppData.casco_seguridad_barbuquejo]\n                                  .filter(Boolean)\n                                  .join(', ');\n                              }\n\n                              return <RadioCheck key={item.id} label={item.label} value={true} spec={spec} />;\n                            })}\n                          </div>\n                        </div>\n                      );\n                    })}\n                  </div>\n                </div>\n\n                <Separator />\n\n                {/* 2.3 Justificaci√≥n de Uso */}\n                <div>\n                  <h4 className=\"text-sm font-bold text-orange-600 mb-3 flex items-center gap-2\">\n                    <Info className=\"h-4 w-4\" />\n                    3. Justificaci√≥n de Uso del Permiso\n                  </h4>\n                  <div className=\"pl-6\">\n                    {justificacionOptions.map((item) => (\n                      <RadioCheck key={item.id} label={item.label} value={(permit.anexoATS?.justificacion as any)?.[item.id]} />\n                    ))}\n                  </div>\n                </div>\n              </CollapsibleContent>\n            </Collapsible>\n          )}\n\n          {/* ===== SECCI√ìN 3: PERSONAL AUTORIZADO COMPLETO ===== */}\n          <Collapsible defaultOpen>\n            <CollapsibleTrigger className=\"flex w-full items-center justify-between rounded-lg border-2 border-green-200 bg-white hover:bg-gray-50 px-4 py-4 text-left font-semibold transition-colors shadow-sm\">\n              <div className=\"flex items-center gap-2\">\n                <Users className=\"h-5 w-5 text-green-600\" />\n                <span>Personal Autorizado ({permit.workers?.length || 0})</span>\n              </div>\n              <ChevronDown className=\"h-5 w-5 text-green-600 transition-transform data-[state=open]:rotate-180\" />\n            </CollapsibleTrigger>\n            <CollapsibleContent className=\"border-2 border-t-0 border-green-200 rounded-b-lg bg-white p-6\">\n              <div className=\"overflow-x-auto\">\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead className=\"w-[200px]\">Nombre / C√©dula</TableHead>\n                      <TableHead>Rol</TableHead>\n                      <TableHead>Afiliaci√≥n</TableHead>\n                      <TableHead>Entrenamiento</TableHead>\n                      <TableHead className=\"text-center\">Firma Apertura</TableHead>\n                      <TableHead className=\"text-center\">Firma Cierre</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {permit.workers && permit.workers.length > 0 ? (\n                      permit.workers.map((worker, index) => (\n                        <TableRow key={index} className=\"hover:bg-green-50\">\n                          <TableCell>\n                            <div>\n                              <p className=\"font-semibold text-sm\">{worker.nombre}</p>\n                              <p className=\"text-xs text-muted-foreground\">C.C. {worker.cedula}</p>\n                            </div>\n                          </TableCell>\n                          <TableCell>\n                            <Badge variant=\"outline\" className=\"text-xs\">\n                              {worker.rol === 'Otro' ? worker.otroRol || 'Otro' : worker.rol}\n                            </Badge>\n                          </TableCell>\n                          <TableCell>\n                            <div className=\"text-xs space-y-1\">\n                              <div className=\"flex items-center gap-1\">\n                                {worker.eps ? <CheckCircle size={12} className=\"text-green-500\" /> : <XCircle size={12} className=\"text-red-500\" />}\n                                <span>EPS: {worker.eps || 'N/A'}</span>\n                              </div>\n                              <div className=\"flex items-center gap-1\">\n                                {worker.arl ? <CheckCircle size={12} className=\"text-green-500\" /> : <XCircle size={12} className=\"text-red-500\" />}\n                                <span>ARL: {worker.arl || 'N/A'}</span>\n                              </div>\n                              <div className=\"flex items-center gap-1\">\n                                {worker.pensiones ? <CheckCircle size={12} className=\"text-green-500\" /> : <XCircle size={12} className=\"text-red-500\" />}\n                                <span>AFP: {worker.pensiones || 'N/A'}</span>\n                              </div>\n                            </div>\n                          </TableCell>\n                          <TableCell>\n                            <div className=\"text-xs space-y-1\">\n                              {worker.entrenamiento?.tec && (\n                                <div className=\"flex items-center gap-1\">\n                                  <CheckCircle size={12} className=\"text-green-500\" />\n                                  <span>TEC</span>\n                                </div>\n                              )}\n                              {worker.entrenamiento?.tsa && (\n                                <div className=\"flex items-center gap-1\">\n                                  <CheckCircle size={12} className=\"text-green-500\" />\n                                  <span>TSA</span>\n                                </div>\n                              )}\n                              {worker.entrenamiento?.otro && <div className=\"text-xs text-muted-foreground\">{worker.entrenamiento.otro}</div>}\n                            </div>\n                          </TableCell>\n                          <TableCell className=\"text-center\">\n                            {worker.firmaApertura ? (\n                              <div className=\"flex flex-col items-center gap-1\">\n                                <Image\n                                  src={worker.firmaApertura}\n                                  alt=\"Firma Apertura\"\n                                  width={100}\n                                  height={50}\n                                  className=\"border rounded p-1 bg-white\"\n                                />\n                                <Badge variant=\"default\" className=\"bg-green-100 text-green-800 text-xs\">\n                                  ‚úì Firmado\n                                </Badge>\n                              </div>\n                            ) : (\n                              <Badge variant=\"destructive\" className=\"text-xs\">\n                                Pendiente\n                              </Badge>\n                            )}\n                          </TableCell>\n                          <TableCell className=\"text-center\">\n                            {worker.firmaCierre ? (\n                              <div className=\"flex flex-col items-center gap-1\">\n                                <Image\n                                  src={worker.firmaCierre}\n                                  alt=\"Firma Cierre\"\n                                  width={100}\n                                  height={50}\n                                  className=\"border rounded p-1 bg-white\"\n                                />\n                                <Badge variant=\"default\" className=\"bg-blue-100 text-blue-800 text-xs\">\n                                  ‚úì Firmado\n                                </Badge>\n                              </div>\n                            ) : (\n                              <Badge variant=\"outline\" className=\"text-xs\">\n                                Pendiente\n                              </Badge>\n                            )}\n                          </TableCell>\n                        </TableRow>\n                      ))\n                    ) : (\n                      <TableRow>\n                        <TableCell colSpan={6} className=\"text-center text-muted-foreground italic py-8\">\n                          No hay trabajadores registrados\n                        </TableCell>\n                      </TableRow>\n                    )}\n                  </TableBody>\n                </Table>\n              </div>\n            </CollapsibleContent>\n          </Collapsible>\n\n          {/* ===== SECCI√ìN 4: ANEXO TRABAJO EN ALTURAS (si aplica) ===== */}\n          {permit.selectedWorkTypes?.alturas && permit.anexoAltura && (\n            <Collapsible defaultOpen>\n              <CollapsibleTrigger className=\"flex w-full items-center justify-between rounded-lg border-2 border-blue-200 bg-white hover:bg-gray-50 px-4 py-4 text-left font-semibold transition-colors shadow-sm\">\n                <div className=\"flex items-center gap-2\">\n                  <Mountain className=\"h-5 w-5 text-blue-600\" />\n                  <span>Anexo 1 - Trabajo en Alturas</span>\n                </div>\n                <ChevronDown className=\"h-5 w-5 text-blue-600 transition-transform data-[state=open]:rotate-180\" />\n              </CollapsibleTrigger>\n              <CollapsibleContent className=\"border-2 border-t-0 border-blue-200 rounded-b-lg bg-white p-6 space-y-6\">\n                {/* 4.1 Informaci√≥n general */}\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                  <Field label=\"Altura Aproximada (m)\" value={permit.anexoAltura.alturaAproximada || 'N/A'} />\n                  <Field label=\"Tarea a Realizar\" value={permit.anexoAltura.tareaRealizar?.nombre} />\n                  <Field\n                    label=\"Descripci√≥n de la Tarea\"\n                    value={<p className=\"text-sm whitespace-pre-wrap\">{permit.anexoAltura.tareaRealizar?.descripcion}</p>}\n                    fullWidth\n                  />\n                  <Field\n                    label=\"Contacto de Emergencia\"\n                    value={`${permit.anexoAltura.emergencia?.contacto || 'N/A'} - ${permit.anexoAltura.emergencia?.telefono || 'N/A'}`}\n                  />\n                </div>\n\n                <Separator />\n\n                {/* 4.2 Tipos de Estructura */}\n                <div>\n                  <h5 className=\"text-sm font-bold text-blue-600 mb-3\">Tipo de Estructura</h5>\n                  <div className=\"grid grid-cols-2 md:grid-cols-3 gap-2\">\n                    {anexoAlturaEstructuras.map((e) => (\n                      <RadioCheck\n                        key={e.id}\n                        label={e.label}\n                        value={(permit.anexoAltura?.tipoEstructura as any)?.[e.id]}\n                        spec={e.id === 'otros' ? (permit.anexoAltura.tipoEstructura as any)?.otrosCual : undefined}\n                      />\n                    ))}\n                  </div>\n                </div>\n\n                <Separator />\n\n                {/* 4.3 Aspectos de Seguridad */}\n                <div>\n                  <h5 className=\"text-sm font-bold text-blue-600 mb-3\">Verificaci√≥n de Aspectos de Seguridad</h5>\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-1\">\n                    {anexoAlturaAspectos.map((aspect) => (\n                      <RadioCheck key={aspect.id} label={aspect.label} value={(permit.anexoAltura?.aspectosSeguridad as any)?.[aspect.id]} />\n                    ))}\n                  </div>\n                </div>\n\n                <Separator />\n\n                {/* 4.4 Precauciones y Controles */}\n                {permit.anexoAltura.precauciones && Object.keys(permit.anexoAltura.precauciones).length > 0 && (\n                  <>\n                    <div>\n                      <h5 className=\"text-sm font-bold text-blue-600 mb-3\">Precauciones y Controles Espec√≠ficos</h5>\n                      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-1\">\n                        {Object.entries(permit.anexoAltura.precauciones).map(([key, value]) => (\n                          <RadioCheck\n                            key={key}\n                            label={key\n                              .replace(/([A-Z])/g, ' $1')\n                              .trim()\n                              .toUpperCase()}\n                            value={value as string}\n                          />\n                        ))}\n                      </div>\n                    </div>\n                    <Separator />\n                  </>\n                )}\n\n                {/* 4.5 Afectaciones */}\n                {permit.anexoAltura.afectaciones && (\n                  <>\n                    <div>\n                      <h5 className=\"text-sm font-bold text-blue-600 mb-3\">Afectaciones</h5>\n                      <div className=\"space-y-2\">\n                        <RadioCheck label=\"¬øProduce riesgos para otras √°reas?\" value={permit.anexoAltura.afectaciones.riesgoOtrasAreas} />\n                        <RadioCheck label=\"¬øOtras √°reas producen riesgo a este trabajo?\" value={permit.anexoAltura.afectaciones.otrasAreasRiesgo} />\n                        <RadioCheck label=\"¬øPersonal notificado?\" value={permit.anexoAltura.afectaciones.personalNotificado} />\n                        <Field\n                          label=\"Observaciones\"\n                          value={<p className=\"text-sm whitespace-pre-wrap\">{permit.anexoAltura.afectaciones.observaciones}</p>}\n                          fullWidth\n                        />\n                      </div>\n                    </div>\n                    <Separator />\n                  </>\n                )}\n\n                {/* 4.5 Validaci√≥n Diaria */}\n                {(permit.anexoAltura.validacion?.responsable?.length || permit.anexoAltura.validacion?.autoridad?.length) && (\n                  <>\n                    <Separator />\n                    <DailyValidationTable anexoName=\"anexoAltura\" validationData={permit.anexoAltura.validacion} />\n                  </>\n                )}\n\n                {/* 4.6 Firma del Coordinador si existe */}\n                {permit.approvals?.coordinador_alturas?.status === 'aprobado' && (\n                  <Card className=\"bg-blue-50 border-blue-300\">\n                    <CardHeader>\n                      <CardTitle className=\"text-sm text-blue-800 flex items-center gap-2\">\n                        <SignatureIcon size={16} />\n                        Firma del Coordinador de Trabajos en Alturas\n                      </CardTitle>\n                    </CardHeader>\n                    <CardContent>\n                      <div className=\"space-y-2\">\n                        <p className=\"text-sm\">\n                          <strong>Nombre:</strong> {permit.approvals.coordinador_alturas.userName}\n                        </p>\n                        <p className=\"text-sm\">\n                          <strong>Fecha:</strong> {safeFormat(permit.approvals.coordinador_alturas.signedAt, 'dd/MM/yy HH:mm')}\n                        </p>\n                        {permit.approvals.coordinador_alturas.firmaApertura && (\n                          <div className=\"mt-2\">\n                            <p className=\"text-xs text-muted-foreground mb-1\">Firma:</p>\n                            <Image\n                              src={permit.approvals.coordinador_alturas.firmaApertura}\n                              alt=\"Firma Coordinador\"\n                              width={150}\n                              height={75}\n                              className=\"border rounded p-2 bg-white\"\n                            />\n                          </div>\n                        )}\n                      </div>\n                    </CardContent>\n                  </Card>\n                )}\n              </CollapsibleContent>\n            </Collapsible>\n          )}\n\n          {/* ===== SECCI√ìN 5: ANEXO ESPACIOS CONFINADOS (si aplica) ===== */}\n          {permit.selectedWorkTypes?.confinado && permit.anexoConfinado && (\n            <Collapsible defaultOpen>\n              <CollapsibleTrigger className=\"flex w-full items-center justify-between rounded-lg border-2 border-purple-200 bg-white hover:bg-gray-50 px-4 py-4 text-left font-semibold transition-colors shadow-sm\">\n                <div className=\"flex items-center gap-2\">\n                  <ShieldCheck className=\"h-5 w-5 text-purple-600\" />\n                  <span>Anexo 2 - Espacios Confinados</span>\n                </div>\n                <ChevronDown className=\"h-5 w-5 text-purple-600 transition-transform data-[state=open]:rotate-180\" />\n              </CollapsibleTrigger>\n              <CollapsibleContent className=\"border-2 border-t-0 border-purple-200 rounded-b-lg bg-white p-6 space-y-6\">\n                {/* Contenido similar a Alturas - incluyendo todos los campos */}\n                {/* 5.1 Autorizaciones */}\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                  <Field label=\"Autoridad del √Årea\" value={permit.anexoConfinado.autoridadDelArea?.nombre} />\n                  <Field label=\"Responsable del Trabajo\" value={permit.anexoConfinado.responsableDelTrabajo?.nombre} />\n                  <Field label=\"Supervisor Trabajo EC\" value={permit.anexoConfinado.supervisorTrabajo?.nombre} />\n                </div>\n\n                <Separator />\n\n                {/* 5.2 Pruebas de Gases */}\n                <div>\n                  <h5 className=\"text-sm font-bold text-purple-600 mb-3\">Pruebas de Gases Iniciales</h5>\n                  <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n                    <Field label=\"LEL (‚â§0%)\" value={permit.anexoConfinado.resultadosPruebasGases?.lel} />\n                    <Field label=\"O2 (19.5-22%)\" value={permit.anexoConfinado.resultadosPruebasGases?.o2} />\n                    <Field label=\"H2S (0-10 PPM)\" value={permit.anexoConfinado.resultadosPruebasGases?.h2s} />\n                    <Field label=\"CO (0-25 PPM)\" value={permit.anexoConfinado.resultadosPruebasGases?.co} />\n                  </div>\n                </div>\n                <Separator />\n\n                {/* 5.3 Pruebas Peri√≥dicas */}\n                {permit.anexoConfinado.pruebasGasesPeriodicas?.pruebas?.length && (\n                  <>\n                    <div>\n                      <h5 className=\"text-sm font-bold text-purple-600 mb-3\">Monitoreo Peri√≥dico de Gases</h5>\n                      <div className=\"overflow-x-auto\">\n                        <Table>\n                          <TableHeader>\n                            <TableRow>\n                              <TableHead>HORA</TableHead>\n                              <TableHead>LEL %</TableHead>\n                              <TableHead>O2 %</TableHead>\n                              <TableHead>H2S (ppm)</TableHead>\n                              <TableHead>CO (ppm)</TableHead>\n                              <TableHead>RESPONSABLE</TableHead>\n                            </TableRow>\n                          </TableHeader>\n                          <TableBody>\n                            {permit.anexoConfinado.pruebasGasesPeriodicas.pruebas.map((p, idx) => (\n                              <TableRow key={idx}>\n                                <TableCell>{p.hora || '-'}</TableCell>\n                                <TableCell>{p.lel || '-'}</TableCell>\n                                <TableCell>{p.o2 || '-'}</TableCell>\n                                <TableCell>{p.h2s || '-'}</TableCell>\n                                <TableCell>{p.co || '-'}</TableCell>\n                                <TableCell>{p.responsable || '-'}</TableCell>\n                              </TableRow>\n                            ))}\n                          </TableBody>\n                        </Table>\n                      </div>\n                    </div>\n                    <Separator />\n                  </>\n                )}\n\n                {/* 5.4 Requerimientos y Equipos */}\n                {/* ... m√°s secciones */}\n\n                {/* 5.5 Validaci√≥n Diaria */}\n                {(permit.anexoConfinado.validacion?.responsable?.length || permit.anexoConfinado.validacion?.autoridad?.length) && (\n                  <>\n                    <Separator />\n                    <DailyValidationTable anexoName=\"anexoConfinado\" validationData={permit.anexoConfinado.validacion} />\n                  </>\n                )}\n              </CollapsibleContent>\n            </Collapsible>\n          )}\n\n          {/* Continuar con los dem√°s anexos de manera similar... */}\n\n          {/* ===== SECCI√ìN FINAL: APROBACIONES Y FIRMAS ===== */}\n          <Section title=\"Aprobaciones del Permiso\" icon={<SignatureIcon size={20} />}>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n              {/* Aqu√≠ ir√≠an las tarjetas de firmas SignatureCard */}\n              {/* Ejemplo de una tarjeta de firma: */}\n              {Object.entries(signatureRoles).map(([role, title]) => {\n                const approval = permit.approvals?.[role as SignatureRole];\n                \n                // Solo mostrar mantenimiento si aplica control de energ√≠as\n                if (role === 'mantenimiento' && !permit.selectedWorkTypes?.energia) return null;\n                \n                if (!approval && role !== 'solicitante' && role !== 'autorizante') return null;\n\n                return (\n                  <Card key={role} className={`border-2 ${approval?.status === 'aprobado' ? 'border-green-300 bg-green-50' : 'border-gray-200'}`}>\n                    <CardHeader>\n                      <CardTitle className=\"text-sm flex items-center gap-2\">\n                        <SignatureIcon size={16} />\n                        {title}\n                      </CardTitle>\n                    </CardHeader>\n                    <CardContent className=\"space-y-2\">\n                      {approval?.status === 'aprobado' ? (\n                        <>\n                          <p className=\"text-sm\">\n                            <strong>Nombre:</strong> {approval.userName}\n                          </p>\n                          <p className=\"text-sm\">\n                            <strong>Fecha:</strong> {safeFormat(approval.signedAt, 'dd/MM/yy HH:mm')}\n                          </p>\n                          {approval.firmaApertura && (\n                            <div className=\"mt-2\">\n                              <p className=\"text-xs text-muted-foreground mb-1\">Firma:</p>\n                              <Image src={approval.firmaApertura} alt=\"Firma\" width={120} height={60} className=\"border rounded p-1 bg-white\" />\n                            </div>\n                          )}\n                          <Badge variant=\"default\" className=\"bg-green-100 text-green-800\">\n                            ‚úì Aprobado\n                          </Badge>\n                        </>\n                      ) : (\n                        <div className=\"text-center py-4\">\n                          <Badge variant=\"outline\" className=\"text-xs\">\n                            Pendiente de Firma\n                          </Badge>\n                        </div>\n                      )}\n                    </CardContent>\n                  </Card>\n                );\n              })}\n            </div>\n          </Section>\n\n          {/* CIERRE O CANCELACI√ìN */}\n          {(permit.closure?.terminado || permit.closure?.cancelado) && (\n            <Section title=\"Cierre o Cancelaci√≥n del Permiso\" icon={<Lock size={20} />}>\n              {/* Contenido de cierre... */}\n            </Section>\n          )}\n        </div>\n      </main>\n\n      {/* ===== DIALOGS Y MODALES ===== */}\n\n      {/* Dialog de Firma de Autorizaci√≥n */}\n      <Dialog open={isSignatureDialogOpen} onOpenChange={setIsSignatureDialogOpen}>\n        <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <SignatureIcon className=\"h-5 w-5\" />\n              Firmar como: {signingRole ? signatureRoles[signingRole.role as SignatureRole] || signingRole.role : ''}\n            </DialogTitle>\n            <DialogDescription>\n              {signingRole && signatureConsents[signingRole.role as SignatureRole]}\n            </DialogDescription>\n          </DialogHeader>\n\n          <div className=\"space-y-4 py-4\">\n            {/* Campo de nombre si es necesario */}\n            {signingRole &&\n              (signingRole.role === 'coordinador_alturas' ||\n                signingRole.role.startsWith('cierre') ||\n                signingRole.role === 'cancelacion') && (\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"signer-name\">Nombre Completo *</Label>\n                  <Input\n                    id=\"signer-name\"\n                    value={signerName}\n                    onChange={(e) => setSignerName(e.target.value)}\n                    placeholder=\"Ingrese su nombre completo\"\n                  />\n                </div>\n              )}\n\n            {/* Campo de observaciones */}\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"signature-observation\">Observaciones (Opcional)</Label>\n              <Textarea\n                id=\"signature-observation\"\n                value={signatureObservation}\n                onChange={(e) => setSignatureObservation(e.target.value)}\n                placeholder=\"Ingrese cualquier observaci√≥n o comentario relevante\"\n                rows={3}\n              />\n            </div>\n\n            {/* Pad de firma */}\n            <div className=\"space-y-2\">\n              <Label>Firma Digital *</Label>\n              <SignaturePad\n                onSave={handleSaveSignature}\n                disabled={isSigning}\n                penColor=\"rgb(0, 0, 0)\"\n                canvasProps={{\n                  className: 'border-2 border-primary/20 rounded-lg w-full',\n                  style: { width: '100%', height: '200px' },\n                }}\n              />\n            </div>\n          </div>\n\n          <DialogFooter>\n            <DialogClose asChild>\n              <Button variant=\"outline\" disabled={isSigning}>\n                Cancelar\n              </Button>\n            </DialogClose>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Dialog de Validaci√≥n Diaria */}\n      <Dialog open={isDailyValidationSignatureOpen} onOpenChange={setIsDailyValidationSignatureOpen}>\n        <DialogContent className=\"max-w-2xl\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <CheckCircle className=\"h-5 w-5\" />\n              Firma de Validaci√≥n Diaria\n            </DialogTitle>\n            <DialogDescription>\n              Complete la informaci√≥n requerida para la validaci√≥n diaria del anexo.\n            </DialogDescription>\n          </DialogHeader>\n\n          <div className=\"space-y-4 py-4\">\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"validation-name\">Nombre Completo *</Label>\n                <Input\n                  id=\"validation-name\"\n                  value={dailyValidationName}\n                  onChange={(e) => setDailyValidationName(e.target.value)}\n                  placeholder=\"Nombre del responsable\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"validation-date\">Fecha y Hora *</Label>\n                <Input\n                  id=\"validation-date\"\n                  type=\"datetime-local\"\n                  value={dailyValidationDate}\n                  onChange={(e) => setDailyValidationDate(e.target.value)}\n                />\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Firma Digital *</Label>\n              <SignaturePad\n                onSave={async (signature) => {\n                  // Implementar l√≥gica de guardado de validaci√≥n diaria\n                  await handleSaveDailyValidationSignature(signature);\n                }}\n                disabled={isDailyValidationSigning}\n                penColor=\"rgb(0, 0, 0)\"\n                canvasProps={{\n                  className: 'border-2 border-primary/20 rounded-lg w-full',\n                  style: { width: '100%', height: '180px' },\n                }}\n              />\n            </div>\n          </div>\n\n          <DialogFooter>\n            <DialogClose asChild>\n              <Button variant=\"outline\" disabled={isDailyValidationSigning}>\n                Cancelar\n              </Button>\n            </DialogClose>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Dialog de Firma de Trabajador */}\n      <Dialog open={isWorkerSignatureOpen} onOpenChange={setIsWorkerSignatureOpen}>\n        <DialogContent className=\"max-w-2xl\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Users className=\"h-5 w-5\" />\n              Firma de Trabajador\n            </DialogTitle>\n            <DialogDescription>\n              {workerSignatureTarget && permit.workers?.[workerSignatureTarget.index] && (\n                <>\n                  Firma de {workerSignatureTarget.type === 'firmaApertura' ? 'Apertura' : 'Cierre'} para:{' '}\n                  <strong>{permit.workers[workerSignatureTarget.index].nombre}</strong>\n                </>\n              )}\n            </DialogDescription>\n          </DialogHeader>\n\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label>Firma Digital *</Label>\n              <SignaturePad\n                onSave={async (signature) => {\n                  if (!workerSignatureTarget || !permit) return;\n                  // Implementar l√≥gica de guardado de firma de trabajador\n                  setIsWorkerSignatureOpen(false);\n                }}\n                disabled={isSigning}\n                penColor=\"rgb(0, 0, 0)\"\n                canvasProps={{\n                  className: 'border-2 border-primary/20 rounded-lg w-full',\n                  style: { width: '100%', height: '180px' },\n                }}\n              />\n            </div>\n          </div>\n\n          <DialogFooter>\n            <DialogClose asChild>\n              <Button variant=\"outline\" disabled={isSigning}>\n                Cancelar\n              </Button>\n            </DialogClose>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Dialog de Rechazo */}\n      <Dialog open={isRejectionDialogOpen} onOpenChange={setIsRejectionDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2 text-destructive\">\n              <XCircle className=\"h-5 w-5\" />\n              Rechazar Permiso\n            </DialogTitle>\n            <DialogDescription>\n              Por favor, especifique la raz√≥n del rechazo. Esta acci√≥n no se puede deshacer.\n            </DialogDescription>\n          </DialogHeader>\n\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"rejection-reason\">Raz√≥n del Rechazo *</Label>\n              <Textarea\n                id=\"rejection-reason\"\n                value={rejectionReason}\n                onChange={(e) => setRejectionReason(e.target.value)}\n                placeholder=\"Describa la raz√≥n del rechazo del permiso\"\n                rows={4}\n              />\n            </div>\n          </div>\n\n          <DialogFooter>\n            <DialogClose asChild>\n              <Button variant=\"outline\" disabled={isStatusChanging}>\n                Cancelar\n              </Button>\n            </DialogClose>\n            <Button\n              variant=\"destructive\"\n              onClick={() => handleChangeStatus('rechazado', rejectionReason)}\n              disabled={isStatusChanging || !rejectionReason.trim()}\n            >\n              {isStatusChanging ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Rechazando...\n                </>\n              ) : (\n                'Confirmar Rechazo'\n              )}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Dialog de Cierre del Permiso */}\n      <Dialog open={isClosureDialogOpen} onOpenChange={setIsClosureDialogOpen}>\n        <DialogContent className=\"max-w-3xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2 text-blue-600\">\n              <Lock className=\"h-5 w-5\" />\n              Cerrar Permiso de Trabajo\n            </DialogTitle>\n            <DialogDescription>\n              Complete la informaci√≥n requerida para el cierre oficial del permiso. Ambas firmas son obligatorias.\n            </DialogDescription>\n          </DialogHeader>\n\n          <div className=\"space-y-6 py-4\">\n            {/* Observaciones de cierre */}\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"closure-observations\">Observaciones de Cierre</Label>\n              <Textarea\n                id=\"closure-observations\"\n                placeholder=\"Indique cualquier observaci√≥n relevante sobre el cierre del permiso\"\n                rows={4}\n                defaultValue={permit?.closure?.observacionesCierre || ''}\n              />\n            </div>\n\n            <Separator />\n\n            {/* Firmas de cierre */}\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n              {/* Firma Responsable */}\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"text-sm\">Responsable del Trabajo</CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-3\">\n                  <div>\n                    <Label className=\"text-xs\">Nombre</Label>\n                    <p className=\"text-sm font-semibold\">{permit?.user?.displayName || 'N/A'}</p>\n                  </div>\n                  {permit?.closure?.responsable?.firma ? (\n                    <div>\n                      <Label className=\"text-xs\">Firma</Label>\n                      <Image\n                        src={permit.closure.responsable.firma}\n                        alt=\"Firma Responsable\"\n                        width={150}\n                        height={75}\n                        className=\"border rounded p-1 mt-1\"\n                      />\n                      <Badge variant=\"default\" className=\"bg-green-100 text-green-800 mt-2\">\n                        ‚úì Firmado\n                      </Badge>\n                    </div>\n                  ) : (\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => openSignatureDialog('cierre_responsable', 'firmaCierre')}\n                      className=\"w-full\"\n                    >\n                      <SignatureIcon className=\"mr-2 h-4 w-4\" />\n                      Firmar como Responsable\n                    </Button>\n                  )}\n                </CardContent>\n              </Card>\n\n              {/* Firma Autoridad */}\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"text-sm\">Autoridad del √Årea</CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-3\">\n                  <div>\n                    <Label className=\"text-xs\">Nombre</Label>\n                    <p className=\"text-sm font-semibold\">{permit?.approvals?.autorizante?.userName || 'N/A'}</p>\n                  </div>\n                  {permit?.closure?.autoridad?.firma ? (\n                    <div>\n                      <Label className=\"text-xs\">Firma</Label>\n                      <Image\n                        src={permit.closure.autoridad.firma}\n                        alt=\"Firma Autoridad\"\n                        width={150}\n                        height={75}\n                        className=\"border rounded p-1 mt-1\"\n                      />\n                      <Badge variant=\"default\" className=\"bg-green-100 text-green-800 mt-2\">\n                        ‚úì Firmado\n                      </Badge>\n                    </div>\n                  ) : (\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => openSignatureDialog('cierre_autoridad', 'firmaCierre')}\n                      className=\"w-full\"\n                    >\n                      <SignatureIcon className=\"mr-2 h-4 w-4\" />\n                      Firmar como Autoridad\n                    </Button>\n                  )}\n                </CardContent>\n              </Card>\n            </div>\n\n            {/* Advertencia sobre firmas de trabajadores */}\n            <Card className=\"bg-yellow-50 border-yellow-200\">\n              <CardContent className=\"pt-4\">\n                <div className=\"flex items-start gap-2\">\n                  <AlertTriangle className=\"h-5 w-5 text-yellow-600 mt-0.5\" />\n                  <div className=\"text-sm text-yellow-800\">\n                    <p className=\"font-semibold mb-1\">Requisitos para el Cierre:</p>\n                    <ul className=\"list-disc list-inside space-y-1 text-xs\">\n                      <li>Todos los trabajadores deben tener firma de cierre</li>\n                      <li>Todas las validaciones diarias deben estar completas</li>\n                      <li>Ambas firmas de cierre (Responsable y Autoridad) son obligatorias</li>\n                    </ul>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          <DialogFooter>\n            <DialogClose asChild>\n              <Button variant=\"outline\">Cancelar</Button>\n            </DialogClose>\n            <Button\n              onClick={() => handleChangeStatus('cerrado')}\n              disabled={\n                isStatusChanging ||\n                !permit?.closure?.responsable?.firma ||\n                !permit?.closure?.autoridad?.firma\n              }\n              className=\"bg-blue-600 hover:bg-blue-700\"\n            >\n              {isStatusChanging ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Cerrando...\n                </>\n              ) : (\n                <>\n                  <Lock className=\"mr-2 h-4 w-4\" />\n                  Cerrar Permiso\n                </>\n              )}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Dialog de Cancelaci√≥n */}\n      <Dialog open={isCancellationDialogOpen} onOpenChange={setIsCancellationDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2 text-destructive\">\n              <FileX className=\"h-5 w-5\" />\n              Cancelar Permiso\n            </DialogTitle>\n            <DialogDescription>\n              Esta acci√≥n cancelar√° el permiso de trabajo. Esta acci√≥n no se puede deshacer.\n            </DialogDescription>\n          </DialogHeader>\n\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"cancellation-reason\">Raz√≥n de la Cancelaci√≥n *</Label>\n              <Textarea\n                id=\"cancellation-reason\"\n                value={cancellationReason}\n                onChange={(e) => setCancellationReason(e.target.value)}\n                placeholder=\"Describa la raz√≥n de la cancelaci√≥n del permiso\"\n                rows={4}\n              />\n            </div>\n\n            <Card className=\"bg-red-50 border-red-200\">\n              <CardContent className=\"pt-4\">\n                <div className=\"flex items-start gap-2\">\n                  <AlertTriangle className=\"h-5 w-5 text-red-600 mt-0.5\" />\n                  <p className=\"text-sm text-red-800\">\n                    Una vez cancelado, el permiso quedar√° marcado como cancelado y se registrar√° la raz√≥n junto con su firma.\n                  </p>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          <DialogFooter>\n            <DialogClose asChild>\n              <Button variant=\"outline\" disabled={isSigning}>\n                No, Mantener Permiso\n              </Button>\n            </DialogClose>\n            <Button\n              variant=\"destructive\"\n              onClick={async () => {\n                if (!cancellationReason.trim()) {\n                  toast({\n                    variant: 'destructive',\n                    title: 'Motivo Requerido',\n                    description: 'Debe especificar un motivo para la cancelaci√≥n.',\n                  });\n                  return;\n                }\n                // Abrir dialog de firma para cancelaci√≥n\n                setIsCancellationDialogOpen(false);\n                openSignatureDialog('cancelacion', 'firmaCierre');\n              }}\n              disabled={!cancellationReason.trim()}\n            >\n              S√≠, Cancelar Permiso\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* AlertDialog para confirmar firma de solicitante */}\n      <AlertDialog open={isSolicitanteSignAlertOpen} onOpenChange={setIsSolicitanteSignAlertOpen}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle className=\"flex items-center gap-2\">\n              <Info className=\"h-5 w-5 text-blue-600\" />\n              Confirmaci√≥n de Firma\n            </AlertDialogTitle>\n            <AlertDialogDescription>\n              Al firmar como solicitante, confirma que toda la informaci√≥n del permiso, ATS y anexos es correcta.\n              El permiso se enviar√° para autorizaci√≥n y <strong>ya no podr√° ser modificado</strong>.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel>Cancelar</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={() => {\n                setIsSolicitanteSignAlertOpen(false);\n                openSignatureDialog('solicitante', 'firmaApertura');\n              }}\n              className=\"bg-blue-600 hover:bg-blue-700\"\n            >\n              Entiendo, Continuar con la Firma\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      {/* Botones de acci√≥n flotantes (si el usuario tiene permisos) */}\n      {currentUser && permit && (\n        <div className=\"fixed bottom-6 right-6 flex flex-col gap-3 z-20\">\n          <TooltipProvider>\n            {/* Bot√≥n de Firmar (si corresponde) */}\n            {permit.status === 'pendiente_revision' && currentUser.role === 'autorizante' && (\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <Button\n                    size=\"lg\"\n                    className=\"rounded-full shadow-lg\"\n                    onClick={() => openSignatureDialog('autorizante', 'firmaApertura')}\n                  >\n                    <SignatureIcon className=\"mr-2 h-5 w-5\" />\n                    Firmar Permiso\n                  </Button>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p>Firmar como Autorizante</p>\n                </TooltipContent>\n              </Tooltip>\n            )}\n\n            {/* Bot√≥n de Aprobar (si corresponde) */}\n            {permit.status === 'pendiente_revision' && currentUser.role === 'admin' && (\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <Button\n                    size=\"lg\"\n                    className=\"rounded-full shadow-lg bg-green-600 hover:bg-green-700\"\n                    onClick={() => handleChangeStatus('aprobado')}\n                    disabled={isStatusChanging}\n                  >\n                    <CheckCircle className=\"mr-2 h-5 w-5\" />\n                    Aprobar Permiso\n                  </Button>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p>Aprobar y activar el permiso</p>\n                </TooltipContent>\n              </Tooltip>\n            )}\n\n            {/* Bot√≥n de Rechazar */}\n            {['pendiente_revision', 'aprobado'].includes(permit.status) && \n             (currentUser.role === 'admin' || currentUser.role === 'lider_sst') && (\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <Button\n                    size=\"lg\"\n                    variant=\"destructive\"\n                    className=\"rounded-full shadow-lg\"\n                    onClick={() => setIsRejectionDialogOpen(true)}\n                  >\n                    <XCircle className=\"mr-2 h-5 w-5\" />\n                    Rechazar\n                  </Button>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p>Rechazar el permiso</p>\n                </TooltipContent>\n              </Tooltip>\n            )}\n\n            {/* Bot√≥n de Iniciar Ejecuci√≥n */}\n            {permit.status === 'aprobado' && \n             (currentUser.role === 'admin' || currentUser.role === 'lider_tarea') && (\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <Button\n                    size=\"lg\"\n                    className=\"rounded-full shadow-lg bg-purple-600 hover:bg-purple-700\"\n                    onClick={() => handleChangeStatus('en_ejecucion')}\n                    disabled={isStatusChanging}\n                  >\n                    <PlayCircle className=\"mr-2 h-5 w-5\" />\n                    Iniciar Ejecuci√≥n\n                  </Button>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p>Marcar permiso como en ejecuci√≥n</p>\n                </TooltipContent>\n              </Tooltip>\n            )}\n\n            {/* Bot√≥n de Cerrar Permiso */}\n            {['en_ejecucion', 'suspendido'].includes(permit.status) && \n             (currentUser.role === 'admin' || currentUser.role === 'lider_tarea') && (\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <Button\n                    size=\"lg\"\n                    className=\"rounded-full shadow-lg bg-blue-600 hover:bg-blue-700\"\n                    onClick={() => setIsClosureDialogOpen(true)}\n                  >\n                    <Lock className=\"mr-2 h-5 w-5\" />\n                    Cerrar Permiso\n                  </Button>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p>Cerrar el permiso de trabajo</p>\n                </TooltipContent>\n              </Tooltip>\n            )}\n\n            {/* Bot√≥n de Cancelar Permiso */}\n            {!['cerrado', 'rechazado'].includes(permit.status) && currentUser.role === 'admin' && (\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <Button\n                    size=\"lg\"\n                    variant=\"outline\"\n                    className=\"rounded-full shadow-lg border-red-300 text-red-600 hover:bg-red-50\"\n                    onClick={() => setIsCancellationDialogOpen(true)}\n                  >\n                    <FileX className=\"mr-2 h-5 w-5\" />\n                    Cancelar Permiso\n                  </Button>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p>Cancelar el permiso</p>\n                </TooltipContent>\n              </Tooltip>\n            )}\n          </TooltipProvider>\n        </div>\n      )}\n    </div>\n  );\n}"],"names":[],"mappings":"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","debugId":null}}]
}