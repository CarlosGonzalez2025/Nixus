{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 51, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/lib/firebase-admin.ts"],"sourcesContent":["import { initializeApp, getApps, cert } from 'firebase-admin/app';\nimport { getFirestore } from 'firebase-admin/firestore';\nimport { config } from 'dotenv';\n\n// Cargar expl√≠citamente las variables de entorno del archivo .env\nconfig();\n\nconst apps = getApps();\n\nif (!apps.length) {\n  try {\n    const projectId = process.env.FIREBASE_PROJECT_ID;\n    const clientEmail = process.env.FIREBASE_CLIENT_EMAIL;\n    const privateKey = process.env.FIREBASE_PRIVATE_KEY;\n\n    if (!projectId || !clientEmail || !privateKey) {\n      throw new Error('Missing Firebase Admin credentials in environment variables.');\n    }\n\n    // Reemplazar los literales \\n con saltos de l√≠nea reales\n    const formattedPrivateKey = privateKey.replace(/\\\\n/g, '\\n');\n\n    initializeApp({\n      credential: cert({\n        projectId,\n        clientEmail,\n        privateKey: formattedPrivateKey,\n      }),\n    });\n\n    console.log('‚úÖ Firebase Admin initialized successfully');\n  } catch (error) {\n    console.error('‚ùå Error initializing Firebase Admin:', error);\n    // Don't throw in production, just log\n    if (process.env.NODE_ENV !== 'production') {\n        throw error;\n    }\n  }\n}\n\nexport const adminDb = getFirestore();\n"],"names":[],"mappings":";;;AAAA;AACA;AACA;;;;;;;;;AAEA,kEAAkE;AAClE,CAAA,GAAA,qIAAA,CAAA,SAAM,AAAD;AAEL,MAAM,OAAO,CAAA,GAAA,gJAAA,CAAA,UAAO,AAAD;AAEnB,IAAI,CAAC,KAAK,MAAM,EAAE;IAChB,IAAI;QACF,MAAM,YAAY,QAAQ,GAAG,CAAC,mBAAmB;QACjD,MAAM,cAAc,QAAQ,GAAG,CAAC,qBAAqB;QACrD,MAAM,aAAa,QAAQ,GAAG,CAAC,oBAAoB;QAEnD,IAAI,CAAC,aAAa,CAAC,eAAe,CAAC,YAAY;YAC7C,MAAM,IAAI,MAAM;QAClB;QAEA,yDAAyD;QACzD,MAAM,sBAAsB,WAAW,OAAO,CAAC,QAAQ;QAEvD,CAAA,GAAA,gJAAA,CAAA,gBAAa,AAAD,EAAE;YACZ,YAAY,CAAA,GAAA,gJAAA,CAAA,OAAI,AAAD,EAAE;gBACf;gBACA;gBACA,YAAY;YACd;QACF;QAEA,QAAQ,GAAG,CAAC;IACd,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,wCAAwC;QACtD,sCAAsC;QACtC,IAAI,oDAAyB,cAAc;YACvC,MAAM;QACV;IACF;AACF;AAEO,MAAM,UAAU,CAAA,GAAA,4JAAA,CAAA,eAAY,AAAD","debugId":null}},
    {"offset": {"line": 198, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/lib/notifications.ts"],"sourcesContent":["\n'use server';\n\nimport twilio from 'twilio';\nimport type { Permit } from '@/types';\nimport { config } from 'dotenv';\n\n// Cargar expl√≠citamente las variables de entorno del archivo .env\nconfig();\n\n// Load credentials directly from environment variables\nconst accountSid = process.env.TWILIO_ACCOUNT_SID;\nconst authToken = process.env.TWILIO_AUTH_TOKEN;\nconst twilioWhatsAppFrom = process.env.TWILIO_WHATSAPP_FROM;\nconst whatsAppTo = process.env.WHATSAPP_TO;\n\nconst workTypesMap: {[key: string]: string} = {\n  'altura': 'Trabajo en Alturas',\n  'confinado': 'Espacios Confinados',\n  'energia': 'Control de Energ√≠as',\n  'izaje': 'Izaje de Cargas',\n  'caliente': 'Trabajo en Caliente',\n  'excavacion': 'Excavaciones',\n  'general': 'Trabajo General'\n};\n\nconst getWorkTypesString = (types: string[]): string => {\n  if (!Array.isArray(types) || types.length === 0) return workTypesMap['general'];\n  return types.map(key => workTypesMap[key] || key).join(', ');\n}\n\ninterface NotificationPayload {\n    permitNumber: string;\n    solicitante: string;\n    workTypes: string[];\n    permitId: string;\n}\n\nexport async function sendWhatsAppNotification(payload: NotificationPayload) {\n  if (!accountSid || !authToken || !twilioWhatsAppFrom || !whatsAppTo) {\n    console.error('Twilio credentials or phone numbers are not configured in environment variables.');\n    throw new Error('Notification service is not configured.');\n  }\n\n  const client = twilio(accountSid, authToken);\n\n  const workTypesText = getWorkTypesString(payload.workTypes);\n\n  const messageBody = `*¬°Alerta de Seguridad SGPT!* üö®\nSe ha creado una nueva solicitud de permiso de trabajo.\n\nüìÑ *N√∫mero:* ${payload.permitNumber}\nüë§ *Solicitante:* ${payload.solicitante}\nüõ†Ô∏è *Tipo de Trabajo:* ${workTypesText}\n\nPor favor, revise la solicitud para su aprobaci√≥n.`;\n\n  try {\n    const message = await client.messages.create({\n      body: messageBody,\n      from: twilioWhatsAppFrom,\n      to: whatsAppTo,\n    });\n    console.log(`Message sent with SID: ${message.sid}`);\n    return { success: true, sid: message.sid };\n  } catch (error) {\n    console.error('Failed to send WhatsApp message:', error);\n    throw error;\n  }\n}\n"],"names":[],"mappings":";;;;;AAGA;AAEA;;;;;;AAEA,kEAAkE;AAClE,CAAA,GAAA,qIAAA,CAAA,SAAM,AAAD;AAEL,uDAAuD;AACvD,MAAM,aAAa,QAAQ,GAAG,CAAC,kBAAkB;AACjD,MAAM,YAAY,QAAQ,GAAG,CAAC,iBAAiB;AAC/C,MAAM,qBAAqB,QAAQ,GAAG,CAAC,oBAAoB;AAC3D,MAAM,aAAa,QAAQ,GAAG,CAAC,WAAW;AAE1C,MAAM,eAAwC;IAC5C,UAAU;IACV,aAAa;IACb,WAAW;IACX,SAAS;IACT,YAAY;IACZ,cAAc;IACd,WAAW;AACb;AAEA,MAAM,qBAAqB,CAAC;IAC1B,IAAI,CAAC,MAAM,OAAO,CAAC,UAAU,MAAM,MAAM,KAAK,GAAG,OAAO,YAAY,CAAC,UAAU;IAC/E,OAAO,MAAM,GAAG,CAAC,CAAA,MAAO,YAAY,CAAC,IAAI,IAAI,KAAK,IAAI,CAAC;AACzD;AASO,eAAe,yBAAyB,OAA4B;IACzE,IAAI,CAAC,cAAc,CAAC,aAAa,CAAC,sBAAsB,CAAC,YAAY;QACnE,QAAQ,KAAK,CAAC;QACd,MAAM,IAAI,MAAM;IAClB;IAEA,MAAM,SAAS,CAAA,GAAA,sIAAA,CAAA,UAAM,AAAD,EAAE,YAAY;IAElC,MAAM,gBAAgB,mBAAmB,QAAQ,SAAS;IAE1D,MAAM,cAAc,CAAC;;;aAGV,EAAE,QAAQ,YAAY,CAAC;kBAClB,EAAE,QAAQ,WAAW,CAAC;uBACjB,EAAE,cAAc;;kDAEW,CAAC;IAEjD,IAAI;QACF,MAAM,UAAU,MAAM,OAAO,QAAQ,CAAC,MAAM,CAAC;YAC3C,MAAM;YACN,MAAM;YACN,IAAI;QACN;QACA,QAAQ,GAAG,CAAC,CAAC,uBAAuB,EAAE,QAAQ,GAAG,EAAE;QACnD,OAAO;YAAE,SAAS;YAAM,KAAK,QAAQ,GAAG;QAAC;IAC3C,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,oCAAoC;QAClD,MAAM;IACR;AACF;;;IA/BsB;;AAAA,+OAAA","debugId":null}},
    {"offset": {"line": 272, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/app/%28app%29/permits/create/actions.ts"],"sourcesContent":["\n'use server';\n\nimport { adminDb } from '@/lib/firebase-admin';\nimport { revalidatePath } from 'next/cache';\nimport type { Permit } from '@/types';\nimport { FieldValue } from 'firebase-admin/firestore';\nimport { sendWhatsAppNotification } from '@/lib/notifications';\n\ntype PermitCreateData = Omit<Permit, 'id' | 'createdAt' | 'status' | 'createdBy' | 'number' | 'user'> & {\n  userId: string;\n  userDisplayName: string | null;\n  userEmail: string | null;\n  userPhotoURL: string | null;\n};\n\nexport async function createPermit(data: PermitCreateData) {\n  if (!data.userId) {\n    return { success: false, error: 'User not authenticated' };\n  }\n\n  const { userId, userDisplayName, userEmail, userPhotoURL, ...permitData } = data;\n\n  // Initialize all approval roles as pending\n  const initialApprovals = {\n    solicitante: { status: 'pendiente' as const },\n    autorizante: { status: 'pendiente' as const },\n    mantenimiento: { status: 'pendiente' as const },\n    sst: { status: 'pendiente' as const }\n  };\n\n  const permitPayload: Partial<Permit> = {\n    ...permitData,\n    workType: permitData.workType && permitData.workType.length > 0 ? permitData.workType : ['general'],\n    status: 'pendiente_revision' as const,\n    createdBy: userId,\n    createdAt: FieldValue.serverTimestamp(), // ‚úÖ Usar serverTimestamp del Admin SDK\n    user: {\n      displayName: userDisplayName,\n      email: userEmail,\n      photoURL: userPhotoURL,\n    },\n    approvals: initialApprovals,\n    closure: {},\n  };\n  \n  if (permitData.anexoAltura) {\n    permitPayload.anexoAltura = permitData.anexoAltura;\n  }\n  \n  if (permitData.anexoConfinado) {\n    permitPayload.anexoConfinado = permitData.anexoConfinado;\n  }\n\n  if (permitData.anexoIzaje) {\n    permitPayload.anexoIzaje = permitData.anexoIzaje;\n  }\n\n  if (permitData.anexoEnergias) {\n    permitPayload.anexoEnergias = permitData.anexoEnergias;\n  }\n\n\n  try {\n    // Add document to Firestore using Admin SDK\n    const docRef = await adminDb.collection('permits').add(permitPayload as any);\n    \n    // Generate and update permit number\n    const permitNumber = `PT-${Date.now()}-${docRef.id.substring(0, 6).toUpperCase()}`;\n    await docRef.update({ number: permitNumber });\n    \n    console.log('‚úÖ Permit created successfully:', docRef.id);\n\n    // Send WhatsApp notification\n    try {\n      await sendWhatsAppNotification({\n        permitNumber: permitNumber,\n        solicitante: userDisplayName || 'N/A',\n        workTypes: permitPayload.workType || ['general'],\n        permitId: docRef.id,\n      });\n      console.log('‚úÖ WhatsApp notification sent successfully.');\n    } catch (notificationError) {\n      console.error('‚ö†Ô∏è Failed to send WhatsApp notification:', notificationError);\n      // We don't fail the whole operation if the notification fails,\n      // but we log it for debugging.\n    }\n    \n    // Revalidate paths to show the new permit in the lists\n    revalidatePath('/permits');\n    revalidatePath('/dashboard');\n    \n    return { success: true, permitId: docRef.id, permitNumber };\n  } catch (error: any) {\n    console.error(\"‚ùå Error creating permit:\", error);\n    // Return a structured error for the client\n    return { \n      success: false, \n      error: error.message || 'Could not create permit. Please try again.' \n    };\n  }\n}\n"],"names":[],"mappings":";;;;;AAGA;AACA;AAEA;AACA;;;;;;;;;;;;;AASO,eAAe,aAAa,IAAsB;IACvD,IAAI,CAAC,KAAK,MAAM,EAAE;QAChB,OAAO;YAAE,SAAS;YAAO,OAAO;QAAyB;IAC3D;IAEA,MAAM,EAAE,MAAM,EAAE,eAAe,EAAE,SAAS,EAAE,YAAY,EAAE,GAAG,YAAY,GAAG;IAE5E,2CAA2C;IAC3C,MAAM,mBAAmB;QACvB,aAAa;YAAE,QAAQ;QAAqB;QAC5C,aAAa;YAAE,QAAQ;QAAqB;QAC5C,eAAe;YAAE,QAAQ;QAAqB;QAC9C,KAAK;YAAE,QAAQ;QAAqB;IACtC;IAEA,MAAM,gBAAiC;QACrC,GAAG,UAAU;QACb,UAAU,WAAW,QAAQ,IAAI,WAAW,QAAQ,CAAC,MAAM,GAAG,IAAI,WAAW,QAAQ,GAAG;YAAC;SAAU;QACnG,QAAQ;QACR,WAAW;QACX,WAAW,4JAAA,CAAA,aAAU,CAAC,eAAe;QACrC,MAAM;YACJ,aAAa;YACb,OAAO;YACP,UAAU;QACZ;QACA,WAAW;QACX,SAAS,CAAC;IACZ;IAEA,IAAI,WAAW,WAAW,EAAE;QAC1B,cAAc,WAAW,GAAG,WAAW,WAAW;IACpD;IAEA,IAAI,WAAW,cAAc,EAAE;QAC7B,cAAc,cAAc,GAAG,WAAW,cAAc;IAC1D;IAEA,IAAI,WAAW,UAAU,EAAE;QACzB,cAAc,UAAU,GAAG,WAAW,UAAU;IAClD;IAEA,IAAI,WAAW,aAAa,EAAE;QAC5B,cAAc,aAAa,GAAG,WAAW,aAAa;IACxD;IAGA,IAAI;QACF,4CAA4C;QAC5C,MAAM,SAAS,MAAM,+HAAA,CAAA,UAAO,CAAC,UAAU,CAAC,WAAW,GAAG,CAAC;QAEvD,oCAAoC;QACpC,MAAM,eAAe,CAAC,GAAG,EAAE,KAAK,GAAG,GAAG,CAAC,EAAE,OAAO,EAAE,CAAC,SAAS,CAAC,GAAG,GAAG,WAAW,IAAI;QAClF,MAAM,OAAO,MAAM,CAAC;YAAE,QAAQ;QAAa;QAE3C,QAAQ,GAAG,CAAC,kCAAkC,OAAO,EAAE;QAEvD,6BAA6B;QAC7B,IAAI;YACF,MAAM,CAAA,GAAA,2HAAA,CAAA,2BAAwB,AAAD,EAAE;gBAC7B,cAAc;gBACd,aAAa,mBAAmB;gBAChC,WAAW,cAAc,QAAQ,IAAI;oBAAC;iBAAU;gBAChD,UAAU,OAAO,EAAE;YACrB;YACA,QAAQ,GAAG,CAAC;QACd,EAAE,OAAO,mBAAmB;YAC1B,QAAQ,KAAK,CAAC,4CAA4C;QAC1D,+DAA+D;QAC/D,+BAA+B;QACjC;QAEA,uDAAuD;QACvD,CAAA,GAAA,6HAAA,CAAA,iBAAc,AAAD,EAAE;QACf,CAAA,GAAA,6HAAA,CAAA,iBAAc,AAAD,EAAE;QAEf,OAAO;YAAE,SAAS;YAAM,UAAU,OAAO,EAAE;YAAE;QAAa;IAC5D,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,4BAA4B;QAC1C,2CAA2C;QAC3C,OAAO;YACL,SAAS;YACT,OAAO,MAAM,OAAO,IAAI;QAC1B;IACF;AACF;;;IArFsB;;AAAA,+OAAA","debugId":null}},
    {"offset": {"line": 542, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/ai/genkit.ts"],"sourcesContent":["import {genkit} from 'genkit';\nimport {googleAI} from '@genkit-ai/google-genai';\n\nexport const ai = genkit({\n  plugins: [googleAI()],\n  model: 'googleai/gemini-2.5-flash',\n});\n"],"names":[],"mappings":";;;AAAA;AAAA;AACA;AAAA;;;AAEO,MAAM,KAAK,CAAA,GAAA,uIAAA,CAAA,SAAM,AAAD,EAAE;IACvB,SAAS;QAAC,CAAA,GAAA,6KAAA,CAAA,WAAQ,AAAD;KAAI;IACrB,OAAO;AACT","debugId":null}},
    {"offset": {"line": 563, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/ai/flows/risk-assessment-recommendation.ts"],"sourcesContent":["'use server';\n\n/**\n * @fileOverview Un agente de IA de evaluaci√≥n de riesgos que recomienda controles de riesgo.\n *\n * - getRiskAssessmentRecommendations - Una funci√≥n que gestiona el proceso de evaluaci√≥n de riesgos.\n * - RiskAssessmentInput - El tipo de entrada para la funci√≥n getRiskAssessmentRecommendations.\n * - RiskAssessmentOutput - El tipo de retorno para la funci√≥n getRiskAssessmentRecommendations.\n */\n\nimport {ai} from '@/ai/genkit';\nimport {z} from 'genkit';\n\nconst RiskAssessmentInputSchema = z.object({\n  workType: z.string().describe('El tipo de trabajo que se est√° realizando.'),\n  environmentalFactors: z.string().describe('Factores ambientales presentes en el lugar de trabajo.'),\n  permitDetails: z.string().describe('Informaci√≥n detallada sobre la solicitud de permiso de trabajo.'),\n});\nexport type RiskAssessmentInput = z.infer<typeof RiskAssessmentInputSchema>;\n\nconst RiskAssessmentOutputSchema = z.object({\n  recommendedControls: z.string().describe('Los controles de riesgo recomendados para la solicitud de permiso de trabajo.'),\n});\nexport type RiskAssessmentOutput = z.infer<typeof RiskAssessmentOutputSchema>;\n\nexport async function getRiskAssessmentRecommendations(input: RiskAssessmentInput): Promise<RiskAssessmentOutput> {\n  return riskAssessmentFlow(input);\n}\n\nconst prompt = ai.definePrompt({\n  name: 'riskAssessmentPrompt',\n  input: {schema: RiskAssessmentInputSchema},\n  output: {schema: RiskAssessmentOutputSchema},\n  prompt: `Eres un oficial de seguridad responsable de evaluar riesgos y recomendar controles para permisos de trabajo.\n\n  Bas√°ndote en los detalles de la solicitud del permiso de trabajo, el tipo de trabajo que se realiza y los factores ambientales presentes, recomendar√°s los controles de riesgo apropiados.\n\n  Tipo de Trabajo: {{{workType}}}\n  Factores Ambientales: {{{environmentalFactors}}}\n  Detalles del Permiso: {{{permitDetails}}}\n\n  Controles de Riesgo Recomendados:`,\n});\n\nconst riskAssessmentFlow = ai.defineFlow(\n  {\n    name: 'riskAssessmentFlow',\n    inputSchema: RiskAssessmentInputSchema,\n    outputSchema: RiskAssessmentOutputSchema,\n  },\n  async input => {\n    const {output} = await prompt(input);\n    return output!;\n  }\n);\n"],"names":[],"mappings":";;;;;AAEA;;;;;;CAMC,GAED;AACA;AAAA;;;;;;AAEA,MAAM,4BAA4B,uIAAA,CAAA,IAAC,CAAC,MAAM,CAAC;IACzC,UAAU,uIAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;IAC9B,sBAAsB,uIAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;IAC1C,eAAe,uIAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;AACrC;AAGA,MAAM,6BAA6B,uIAAA,CAAA,IAAC,CAAC,MAAM,CAAC;IAC1C,qBAAqB,uIAAA,CAAA,IAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;AAC3C;AAGO,eAAe,iCAAiC,KAA0B;IAC/E,OAAO,mBAAmB;AAC5B;AAEA,MAAM,SAAS,mHAAA,CAAA,KAAE,CAAC,YAAY,CAAC;IAC7B,MAAM;IACN,OAAO;QAAC,QAAQ;IAAyB;IACzC,QAAQ;QAAC,QAAQ;IAA0B;IAC3C,QAAQ,CAAC;;;;;;;;mCAQwB,CAAC;AACpC;AAEA,MAAM,qBAAqB,mHAAA,CAAA,KAAE,CAAC,UAAU,CACtC;IACE,MAAM;IACN,aAAa;IACb,cAAc;AAChB,GACA,OAAM;IACJ,MAAM,EAAC,MAAM,EAAC,GAAG,MAAM,OAAO;IAC9B,OAAO;AACT;;;IA5BoB;;AAAA,+OAAA","debugId":null}},
    {"offset": {"line": 630, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/.next-internal/server/app/%28app%29/permits/create/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {createPermit as '4097d45d85355825b31a4c927dbcb1c60fd2c554af'} from 'ACTIONS_MODULE0'\nexport {getRiskAssessmentRecommendations as '401d2929af3bb2809a59f1fa2b833eaa16ed136c97'} from 'ACTIONS_MODULE1'\n"],"names":[],"mappings":";AAAA;AACA","debugId":null}},
    {"offset": {"line": 717, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/app/%28app%29/permits/create/page.tsx/proxy.mjs"],"sourcesContent":["import { registerClientReference } from \"react-server-dom-turbopack/server.edge\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/src/app/(app)/permits/create/page.tsx <module evaluation> from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/app/(app)/permits/create/page.tsx <module evaluation>\",\n    \"default\",\n);\n"],"names":[],"mappings":";;;AAAA;;uCACe,CAAA,GAAA,qPAAA,CAAA,0BAAuB,AAAD,EACjC;IAAa,MAAM,IAAI,MAAM;AAAyS,GACtU,uEACA","debugId":null}},
    {"offset": {"line": 731, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/app/%28app%29/permits/create/page.tsx/proxy.mjs"],"sourcesContent":["import { registerClientReference } from \"react-server-dom-turbopack/server.edge\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/src/app/(app)/permits/create/page.tsx from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/app/(app)/permits/create/page.tsx\",\n    \"default\",\n);\n"],"names":[],"mappings":";;;AAAA;;uCACe,CAAA,GAAA,qPAAA,CAAA,0BAAuB,AAAD,EACjC;IAAa,MAAM,IAAI,MAAM;AAAqR,GAClT,mDACA","debugId":null}},
    {"offset": {"line": 745, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}}]
}