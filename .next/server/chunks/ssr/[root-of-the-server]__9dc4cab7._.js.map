{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 27, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/lib/firebase-admin.ts"],"sourcesContent":["import { initializeApp, getApps, cert } from 'firebase-admin/app';\nimport { getFirestore } from 'firebase-admin/firestore';\n\nconst apps = getApps();\n\nif (!apps.length) {\n  try {\n    const projectId = process.env.FIREBASE_PROJECT_ID;\n    const clientEmail = process.env.FIREBASE_CLIENT_EMAIL;\n    const privateKey = process.env.FIREBASE_PRIVATE_KEY;\n\n    if (!projectId || !clientEmail || !privateKey) {\n      throw new Error('Missing Firebase Admin credentials in environment variables.');\n    }\n\n    // Reemplazar los literales \\n con saltos de l√≠nea reales\n    const formattedPrivateKey = privateKey.replace(/\\\\n/g, '\\n');\n\n    initializeApp({\n      credential: cert({\n        projectId,\n        clientEmail,\n        privateKey: formattedPrivateKey,\n      }),\n    });\n\n    console.log('‚úÖ Firebase Admin initialized successfully');\n  } catch (error) {\n    console.error('‚ùå Error initializing Firebase Admin:', error);\n    // Don't throw in production, just log\n    if (process.env.NODE_ENV !== 'production') {\n        throw error;\n    }\n  }\n}\n\nexport const adminDb = getFirestore();\n"],"names":[],"mappings":";;;AAAA;AACA;;;;;;;;AAEA,MAAM,OAAO,CAAA,GAAA,gJAAA,CAAA,UAAO,AAAD;AAEnB,IAAI,CAAC,KAAK,MAAM,EAAE;IAChB,IAAI;QACF,MAAM,YAAY,QAAQ,GAAG,CAAC,mBAAmB;QACjD,MAAM,cAAc,QAAQ,GAAG,CAAC,qBAAqB;QACrD,MAAM,aAAa,QAAQ,GAAG,CAAC,oBAAoB;QAEnD,IAAI,CAAC,aAAa,CAAC,eAAe,CAAC,YAAY;YAC7C,MAAM,IAAI,MAAM;QAClB;QAEA,yDAAyD;QACzD,MAAM,sBAAsB,WAAW,OAAO,CAAC,QAAQ;QAEvD,CAAA,GAAA,gJAAA,CAAA,gBAAa,AAAD,EAAE;YACZ,YAAY,CAAA,GAAA,gJAAA,CAAA,OAAI,AAAD,EAAE;gBACf;gBACA;gBACA,YAAY;YACd;QACF;QAEA,QAAQ,GAAG,CAAC;IACd,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,wCAAwC;QACtD,sCAAsC;QACtC,IAAI,oDAAyB,cAAc;YACvC,MAAM;QACV;IACF;AACF;AAEO,MAAM,UAAU,CAAA,GAAA,4JAAA,CAAA,eAAY,AAAD","debugId":null}},
    {"offset": {"line": 194, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/lib/notifications.ts"],"sourcesContent":["\n'use server';\n\nimport twilio from 'twilio';\nimport type { Permit } from '@/types';\n\n// Load credentials directly from environment variables\nconst accountSid = process.env.TWILIO_ACCOUNT_SID;\nconst authToken = process.env.TWILIO_AUTH_TOKEN;\nconst twilioWhatsAppFrom = process.env.TWILIO_WHATSAPP_FROM;\nconst whatsAppTo = process.env.WHATSAPP_TO;\n\nconst workTypesMap: {[key: string]: string} = {\n  'altura': 'Trabajo en Alturas',\n  'confinado': 'Espacios Confinados',\n  'energia': 'Control de Energ√≠as',\n  'izaje': 'Izaje de Cargas',\n  'caliente': 'Trabajo en Caliente',\n  'excavacion': 'Excavaciones',\n  'general': 'Trabajo General'\n};\n\nconst getWorkTypesString = (types: string[]): string => {\n  if (!Array.isArray(types) || types.length === 0) return workTypesMap['general'];\n  return types.map(key => workTypesMap[key] || key).join(', ');\n}\n\ninterface NotificationPayload {\n    permitNumber: string;\n    solicitante: string;\n    workTypes: string[];\n    permitId: string;\n}\n\nexport async function sendWhatsAppNotification(payload: NotificationPayload) {\n  if (!accountSid || !authToken || !twilioWhatsAppFrom || !whatsAppTo) {\n    console.error('Twilio credentials or phone numbers are not configured in environment variables.');\n    throw new Error('Notification service is not configured.');\n  }\n\n  const client = twilio(accountSid, authToken);\n\n  const workTypesText = getWorkTypesString(payload.workTypes);\n\n  const messageBody = `*¬°Alerta de Seguridad SGPT!* üö®\nSe ha creado una nueva solicitud de permiso de trabajo.\n\nüìÑ *N√∫mero:* ${payload.permitNumber}\nüë§ *Solicitante:* ${payload.solicitante}\nüõ†Ô∏è *Tipo de Trabajo:* ${workTypesText}\n\nPor favor, revise la solicitud para su aprobaci√≥n.`;\n\n  try {\n    const message = await client.messages.create({\n      body: messageBody,\n      from: twilioWhatsAppFrom,\n      to: whatsAppTo,\n    });\n    console.log(`Message sent with SID: ${message.sid}`);\n    return { success: true, sid: message.sid };\n  } catch (error) {\n    console.error('Failed to send WhatsApp message:', error);\n    throw error;\n  }\n}\n"],"names":[],"mappings":";;;;;AAGA;;;;;AAGA,uDAAuD;AACvD,MAAM,aAAa,QAAQ,GAAG,CAAC,kBAAkB;AACjD,MAAM,YAAY,QAAQ,GAAG,CAAC,iBAAiB;AAC/C,MAAM,qBAAqB,QAAQ,GAAG,CAAC,oBAAoB;AAC3D,MAAM,aAAa,QAAQ,GAAG,CAAC,WAAW;AAE1C,MAAM,eAAwC;IAC5C,UAAU;IACV,aAAa;IACb,WAAW;IACX,SAAS;IACT,YAAY;IACZ,cAAc;IACd,WAAW;AACb;AAEA,MAAM,qBAAqB,CAAC;IAC1B,IAAI,CAAC,MAAM,OAAO,CAAC,UAAU,MAAM,MAAM,KAAK,GAAG,OAAO,YAAY,CAAC,UAAU;IAC/E,OAAO,MAAM,GAAG,CAAC,CAAA,MAAO,YAAY,CAAC,IAAI,IAAI,KAAK,IAAI,CAAC;AACzD;AASO,eAAe,yBAAyB,OAA4B;IACzE,IAAI,CAAC,cAAc,CAAC,aAAa,CAAC,sBAAsB,CAAC,YAAY;QACnE,QAAQ,KAAK,CAAC;QACd,MAAM,IAAI,MAAM;IAClB;IAEA,MAAM,SAAS,CAAA,GAAA,sIAAA,CAAA,UAAM,AAAD,EAAE,YAAY;IAElC,MAAM,gBAAgB,mBAAmB,QAAQ,SAAS;IAE1D,MAAM,cAAc,CAAC;;;aAGV,EAAE,QAAQ,YAAY,CAAC;kBAClB,EAAE,QAAQ,WAAW,CAAC;uBACjB,EAAE,cAAc;;kDAEW,CAAC;IAEjD,IAAI;QACF,MAAM,UAAU,MAAM,OAAO,QAAQ,CAAC,MAAM,CAAC;YAC3C,MAAM;YACN,MAAM;YACN,IAAI;QACN;QACA,QAAQ,GAAG,CAAC,CAAC,uBAAuB,EAAE,QAAQ,GAAG,EAAE;QACnD,OAAO;YAAE,SAAS;YAAM,KAAK,QAAQ,GAAG;QAAC;IAC3C,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,oCAAoC;QAClD,MAAM;IACR;AACF;;;IA/BsB;;AAAA,+OAAA","debugId":null}},
    {"offset": {"line": 264, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/app/%28app%29/permits/actions.ts"],"sourcesContent":["\n'use server';\n\nimport { adminDb } from '@/lib/firebase-admin';\nimport { revalidatePath } from 'next/cache';\nimport type { Permit, ExternalWorker } from '@/types';\nimport { FieldValue } from 'firebase-admin/firestore';\nimport { sendWhatsAppNotification } from '@/lib/notifications';\nimport { config } from 'dotenv';\nconfig();\n\ntype PermitCreateData = Omit<Permit, 'id' | 'createdAt' | 'status' | 'createdBy' | 'number' | 'user'> & {\n  userId: string;\n  userDisplayName: string | null;\n  userEmail: string | null;\n  userPhotoURL: string | null;\n};\n\nexport async function createPermit(data: PermitCreateData) {\n  if (!data.userId) {\n    return { success: false, error: 'User not authenticated' };\n  }\n\n  const { userId, userDisplayName, userEmail, userPhotoURL, ...permitData } = data;\n\n  // Initialize all approval roles as pending\n  const initialApprovals = {\n    solicitante: { status: 'pendiente' as const },\n    autorizante: { status: 'pendiente' as const },\n    mantenimiento: { status: 'pendiente' as const },\n    sst: { status: 'pendiente' as const }\n  };\n\n  const permitPayload: Partial<Permit> = {\n    ...permitData,\n    workType: permitData.workType && permitData.workType.length > 0 ? permitData.workType : ['general'],\n    status: 'pendiente_revision' as const,\n    createdBy: userId,\n    createdAt: FieldValue.serverTimestamp(), // ‚úÖ Usar serverTimestamp del Admin SDK\n    user: {\n      displayName: userDisplayName,\n      email: userEmail,\n      photoURL: userPhotoURL,\n    },\n    approvals: initialApprovals,\n    closure: {},\n  };\n  \n  if (permitData.anexoAltura) {\n    permitPayload.anexoAltura = permitData.anexoAltura;\n  }\n  \n  if (permitData.anexoConfinado) {\n    permitPayload.anexoConfinado = permitData.anexoConfinado;\n  }\n\n  if (permitData.anexoIzaje) {\n    permitPayload.anexoIzaje = permitData.anexoIzaje;\n  }\n\n  if (permitData.anexoEnergias) {\n    permitPayload.anexoEnergias = permitData.anexoEnergias;\n  }\n\n\n  try {\n    // Add document to Firestore using Admin SDK\n    const docRef = await adminDb.collection('permits').add(permitPayload as any);\n    \n    // Generate and update permit number\n    const permitNumber = `PT-${Date.now()}-${docRef.id.substring(0, 6).toUpperCase()}`;\n    await docRef.update({ number: permitNumber });\n    \n    console.log('‚úÖ Permit created successfully:', docRef.id);\n\n    // Send WhatsApp notification\n    try {\n      await sendWhatsAppNotification({\n        permitNumber: permitNumber,\n        solicitante: userDisplayName || 'N/A',\n        workTypes: permitPayload.workType || ['general'],\n        permitId: docRef.id,\n      });\n      console.log('‚úÖ WhatsApp notification sent successfully.');\n    } catch (notificationError) {\n      console.error('‚ö†Ô∏è Failed to send WhatsApp notification:', notificationError);\n      // We don't fail the whole operation if the notification fails,\n      // but we log it for debugging.\n    }\n    \n    // Revalidate paths to show the new permit in the lists\n    revalidatePath('/permits');\n    revalidatePath('/dashboard');\n    \n    return { success: true, permitId: docRef.id, permitNumber };\n  } catch (error: any) {\n    console.error(\"‚ùå Error creating permit:\", error);\n    // Return a structured error for the client\n    return { \n      success: false, \n      error: error.message || 'Could not create permit. Please try again.' \n    };\n  }\n}\n\nexport async function registerWorkerForPermit(permitId: string, workerData: ExternalWorker) {\n  if (!permitId || !workerData) {\n    return { success: false, error: 'Invalid data provided.' };\n  }\n\n  try {\n    const permitRef = adminDb.collection('permits').doc(permitId);\n    \n    // Atomically add the new worker to the 'workers' array\n    await permitRef.update({\n      workers: FieldValue.arrayUnion(workerData)\n    });\n\n    console.log(`‚úÖ Worker ${workerData.nombre} added to permit ${permitId}`);\n    \n    revalidatePath(`/permits/${permitId}`);\n\n    return { success: true };\n  } catch (error: any) {\n    console.error(\"‚ùå Error registering worker:\", error);\n    return { \n      success: false, \n      error: error.message || 'Could not register worker. Please try again.' \n    };\n  }\n}\n\n    "],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 422, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/.next-internal/server/app/%28app%29/permits/%5Bid%5D/register-worker/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {registerWorkerForPermit as '60d74deb3b89c05ec6c0c56315e435524482a12a73'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":";AAAA","debugId":null}},
    {"offset": {"line": 503, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/app/%28app%29/permits/%5Bid%5D/register-worker/page.tsx/proxy.mjs"],"sourcesContent":["import { registerClientReference } from \"react-server-dom-turbopack/server.edge\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/src/app/(app)/permits/[id]/register-worker/page.tsx <module evaluation> from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/app/(app)/permits/[id]/register-worker/page.tsx <module evaluation>\",\n    \"default\",\n);\n"],"names":[],"mappings":";;;AAAA;;uCACe,CAAA,GAAA,qPAAA,CAAA,0BAAuB,AAAD,EACjC;IAAa,MAAM,IAAI,MAAM;AAAuT,GACpV,qFACA","debugId":null}},
    {"offset": {"line": 517, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/app/%28app%29/permits/%5Bid%5D/register-worker/page.tsx/proxy.mjs"],"sourcesContent":["import { registerClientReference } from \"react-server-dom-turbopack/server.edge\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/src/app/(app)/permits/[id]/register-worker/page.tsx from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/app/(app)/permits/[id]/register-worker/page.tsx\",\n    \"default\",\n);\n"],"names":[],"mappings":";;;AAAA;;uCACe,CAAA,GAAA,qPAAA,CAAA,0BAAuB,AAAD,EACjC;IAAa,MAAM,IAAI,MAAM;AAAmS,GAChU,iEACA","debugId":null}},
    {"offset": {"line": 531, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}}]
}