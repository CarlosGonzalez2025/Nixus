rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if the user is an admin
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Colección de Usuarios (users)
    match /users/{userId} {
      // An admin can read all user profiles for the management table.
      // A user can read their own profile.
      allow get: if request.auth != null && (isAdmin() || request.auth.uid == userId);
      allow list: if request.auth != null && isAdmin();

      // An admin can update any user profile.
      // A user can update their own profile.
      allow update: if request.auth != null && (isAdmin() || request.auth.uid == userId);

      // Creation and deletion are handled by the Admin SDK server-side.
      allow create, delete: if false;
    }

    // Colección de Permisos (permits)
    match /permits/{permitId} {
      // Any authenticated user can read an individual permit or list all permits.
      // This is necessary for the dashboard and permit list pages.
      allow get, list: if request.auth != null;

      // Creation is handled by the Admin SDK server-side for security.
      allow create: if false;

      // An admin or a user with the correct role can update (sign) a permit.
      allow update: if request.auth != null && (
        isAdmin() ||
        (request.resource.data.approvals.solicitante.userId == request.auth.uid && resource.data.approvals.solicitante.userId != request.resource.data.approvals.solicitante.userId) ||
        (request.resource.data.approvals.autorizante.userId == request.auth.uid && resource.data.approvals.autorizante.userId != request.resource.data.approvals.autorizante.userId) ||
        (request.resource.data.approvals.mantenimiento.userId == request.auth.uid && resource.data.approvals.mantenimiento.userId != request.resource.data.approvals.mantenimiento.userId) ||
        (request.resource.data.approvals.sst.userId == request.auth.uid && resource.data.approvals.sst.userId != request.resource.data.approvals.sst.userId)
      );

      // Deletion is not allowed from the client.
      allow delete: if false;
    }

    // Colección de prueba (test)
    match /test/{docId} {
      // Anyone can read, but only authenticated users can write.
      allow read: if true;
      allow write: if request.auth != null;
    }
  }
}

    