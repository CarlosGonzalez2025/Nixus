
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Colección de Usuarios (users) ---
    match /users/{userId} {
      // Un administrador puede leer la lista completa de usuarios.
      // Esto es para que la tabla en "Gestión de Usuarios" funcione.
      allow list: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';

      // Un usuario puede leer su propio perfil, o un admin puede leer cualquier perfil.
      allow get: if request.auth != null && (request.auth.uid == userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
      
      // Un usuario puede actualizar su propio perfil, o un admin puede actualizar cualquier perfil.
      allow update: if request.auth != null && (request.auth.uid == userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');

      // La creación de usuarios se hace desde el servidor (Admin SDK), no desde el cliente.
      allow create: if false;

      // Nadie puede borrar perfiles de usuario desde la app.
      allow delete: if false;
    }

    // --- Colección de Permisos (permits) ---
    match /permits/{permitId} {
      // LECTURA: Sigue siendo para usuarios autenticados.
      allow read: if request.auth != null;

      // ACTUALIZACIÓN: Se divide en dos casos.
      allow update: if 
        // CASO 1: El usuario está autenticado (para firmar, cerrar, etc.)
        (request.auth != null) || 
        // CASO 2: El usuario NO está autenticado, PERO solo está añadiendo un trabajador a la lista.
        (request.auth == null && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['workers']) &&
         request.resource.data.workers.size() == resource.data.workers.size() + 1);

      // CREACIÓN/ELIMINACIÓN: Siguen protegidas.
      allow create, delete: if false;
    }

    // --- Colección de Listas Dinámicas (dynamic_lists) ---
    match /dynamic_lists/{listName} {
      // Cualquier usuario autenticado puede leer las listas (para los desplegables).
      allow read: if request.auth != null;

      // Solo los administradores pueden crear, actualizar o eliminar listas.
      allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // --- Colección de Prueba (test) ---
    match /test/{docId} {
      // Cualquiera puede leer, pero solo usuarios autenticados pueden escribir.
      allow read: if true;
      allow write: if request.auth != null;
    }
  }
}
